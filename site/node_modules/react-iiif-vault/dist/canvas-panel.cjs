"use strict";var Qo=Object.create;var Xe=Object.defineProperty;var Go=Object.getOwnPropertyDescriptor;var Zo=Object.getOwnPropertyNames;var Xo=Object.getPrototypeOf,Jo=Object.prototype.hasOwnProperty;var ei=(e,n)=>{for(var t in n)Xe(e,t,{get:n[t],enumerable:!0})},yn=(e,n,t,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of Zo(n))!Jo.call(e,o)&&o!==t&&Xe(e,o,{get:()=>n[o],enumerable:!(r=Go(n,o))||r.enumerable});return e};var $=(e,n,t)=>(t=e!=null?Qo(Xo(e)):{},yn(n||!e||!e.__esModule?Xe(t,"default",{value:e,enumerable:!0}):t,e)),ti=e=>yn(Xe({},"__esModule",{value:!0}),e);var $i={};ei($i,{CanvasPanel:()=>N});module.exports=ti($i);var he=require("react");var z=$(require("react"),1),ut=require("@atlas-viewer/atlas"),hr=require("react-error-boundary");var j=require("react");var ve=$(require("react"),1),hn=require("react/jsx-runtime"),ni={collection:void 0,manifest:void 0,range:void 0,canvas:void 0,annotation:void 0,annotationPage:void 0},Je=ve.default.createContext(ni),q=()=>(0,ve.useContext)(Je);function ne({value:e,children:n}){let t=q(),r=(0,ve.useMemo)(()=>({...t,...e}),[e,t]);return(0,hn.jsx)(Je.Provider,{value:r,children:n})}var et=$(require("react"),1),Oe=require("@iiif/helpers/vault");var Ut=require("react/jsx-runtime"),ce=et.default.createContext({vault:null,setVaultInstance:e=>{}});function Se({vault:e,vaultOptions:n,useGlobal:t,resources:r,children:o}){let[a,i]=(0,et.useState)(()=>e||(t?(0,Oe.globalVault)(n):n?new Oe.Vault(n):new Oe.Vault));return(0,Ut.jsx)(ce.Provider,{value:{vault:a,setVaultInstance:i},children:(0,Ut.jsx)(ne,{value:r||{},children:o})})}var Gn=require("react"),it=require("react");var vn=require("@iiif/helpers/vault"),Sn=require("react");function xe(e){let n=(0,Sn.useContext)(ce);return e||(n&&n.vault?n.vault:(0,vn.globalVault)())}var re=require("react");function xn(e,{noCache:n=!1}={}){let t=typeof e=="string"?e:e.id,r=xe(),[o,a]=(0,re.useState)(t),[i,s]=(0,re.useState)(void 0),u=(0,re.useMemo)(()=>r.get(t,{skipSelfReturn:!0})||void 0,[t,r]),[c,l]=(0,re.useState)(u);return(0,re.useEffect)(()=>{(async()=>{try{let m=u&&!n?u:await r.load(t),p=m?m.id||m["@id"]:null;m&&o!==p&&a(p),l(m)}catch(m){s(m)}})()},[t,n]),{isLoaded:!!c,id:o,requestId:t,error:i,resource:c,cached:!!(c&&c===u)}}function Cn(e,n){let{id:t,isLoaded:r,error:o,resource:a,requestId:i,cached:s}=xn(e,n);return{id:t,isLoaded:r,error:o,manifest:a,requestId:i,cached:s}}var Rn=require("react/jsx-runtime");function bn({manifest:e,children:n}){return(0,Rn.jsx)(ne,{value:{manifest:e},children:n})}var An=require("react/jsx-runtime");function G({canvas:e,children:n}){return(0,An.jsx)(ne,{value:{canvas:e},children:n})}var Tn=require("react"),In=$(require("react"),1);var Pn=require("react"),P=()=>{let{vault:e}=(0,Pn.useContext)(ce);if(e===null)throw new Error("Vault not found. Ensure you have your provider set up correctly.");return e};var tt=require("react");function T(e,n=[]){let t=P(),[r,o]=(0,tt.useState)(()=>e(t.getState(),t));return(0,tt.useEffect)(()=>t.subscribe(a=>e(a,t),a=>{o(a)},!1),n),r}var Ce=In.default.createContext([]);function nt(){let e=(0,Tn.useContext)(Ce);return T(n=>e.map(t=>n.iiif.entities.Canvas[t]).filter(Boolean),[e])}var wn=require("react");function k(e={},n=[]){let{id:t,selector:r}=e,o=q(),a=P(),i=t||o.manifest,s=T(u=>i?u.iiif.entities.Manifest[i]:void 0,[i]);return(0,wn.useMemo)(()=>{if(s)return r?r(s):s},[s,r,...n])}var Vn=require("react/jsx-runtime");function Mn({range:e,children:n}){return(0,Vn.jsx)(ne,{value:{range:e},children:n})}function qt(e,n){let t=[];for(let r of n.items)if(r.type==="SpecificResource"&&r.source?.type==="Canvas"&&(r.source.id.indexOf("#")!==-1?t.push({id:r.source.id.split("#")[0],type:"Canvas"}):t.push(r.source)),r.type==="Range"&&t.push(...qt(e,e.get(r))),r.type==="SpecificResource"){let o=typeof r.source=="string"?r.source:r.source.id;t.push({id:o,type:"Canvas"})}return t}function En(e,n,{disablePaging:t,skipNonPaged:r}={}){let o=n.behavior,a=o.includes("paged"),i=a?!1:o.includes("continuous"),s=a||i?!1:o.includes("individuals"),u=n.type==="Manifest"?n.items:qt(e,n);if(i)return[u,[u.map((g,d)=>d)]];if(s||!a||t)return[u,u.map((g,d)=>[d])];let c=[],l=[],m=()=>{l.length&&(c.push([...l]),l=[])},p=0,y=!1;for(let g=0;g<u.length;g++){let d=e.get(u[g]);if(d.behavior.includes("non-paged")){g===p&&p++,r||(m(),c.push([g]),m());continue}if(g===p||d.behavior.includes("facing-pages")){l.length&&(y=!0),m(),c.push([g]),m();continue}if(l.push(g),y){m(),y=!1;continue}l.length>1&&m()}return l.length&&m(),[u,c]}var W=require("react");var kn=require("react");function Nn(e={},n=[]){let{id:t,selector:r}=e,o=q(),a=t||o.range,i=T(s=>a?s.iiif.entities.Range[a]:void 0,[a]);return(0,kn.useMemo)(()=>{if(i)return r?r(i):i},[i,r,...n])}function Ln({startCanvas:e,disablePaging:n}){let t=P(),r=k(),o=Nn(),[a,i]=(0,W.useState)(void 0),s=o||r;if(!s)throw new Error("Nothing selected");let[u,c]=(0,W.useMemo)(()=>En(t,s,{disablePaging:n}),[t,s,n]),l=(0,W.useRef)(c);if(l.current!==c){let x=l.current[a][0],h=c.findIndex(v=>v.includes(x));l.current=c,i(h)}let m=(0,W.useCallback)(d=>{let x=c.findIndex(h=>h.includes(d));i(x===-1?0:x)},[u,c]),p=(0,W.useCallback)(d=>{let x=u.findIndex(h=>h.id===d);x!==-1?m(x):i(0)},[u,c]),y=(0,W.useCallback)(()=>{i(d=>d>=c.length-1?d:d+1)},[c]),g=(0,W.useCallback)(()=>{i(d=>d<=0?0:d-1)},[c]);return typeof a>"u"&&(e?p(e):i(0)),{visibleItems:c[a]?.map(d=>u[d].id)||[],cursor:a,items:u,sequence:c,hasPrevious:a>0,hasNext:a<c.length-1,setSequenceIndex:i,setCanvasIndex:m,setCanvasId:p,next:y,previous:g}}var Y=require("react"),rt=require("zustand");var _t=require("zustand/vanilla");function _(e,n,t){let r=n.findIndex(i=>i.service.id===e);if(r===-1)return n;let o=[...n],a=t(o[r]);return a===o[r]?n:(o[r]=a,o)}var On=()=>(0,_t.createStore)((e,n)=>({currentAuth:-1,authItems:[],login:()=>{let t=n().authItems[n().currentAuth];if(!t||t.isPending||t.isLoggedIn)return;if(t.type!=="active")throw new Error("Cannot login to non-active service");let r=t.service.service.find(o=>o.type==="AuthAccessTokenService2");if(!r)throw new Error("Token service not found");e(()=>({authItems:_(t.id,n().authItems,o=>({...o,isPending:!0}))})),zn(t.service).then(()=>{Wt(r).then(o=>{let a=o.expiresIn,i=Date.now()+a*1e3;e(()=>({authItems:_(t.id,n().authItems,s=>({...s,isLoggedIn:!0,isPending:!1,session:{token:o.accessToken,expires:i}}))}))}).catch(o=>{e(()=>({authItems:_(t.id,n().authItems,a=>({...a,isLoggedIn:!1,isPending:!1,error:o.message}))}))})})},logout:()=>{let t=n().authItems[n().currentAuth];if(!t||t.isPending||!t.isLoggedIn)return;if(t.type!=="active")throw new Error("Cannot logout of non-active service");let r=t.service.service.find(i=>i.type==="AuthLogoutService2");if(!r)return;let o=`${r.id}?origin=${Hn()}`,a=window.open(o);e(()=>({authItems:_(t.id,n().authItems,i=>({...i,isLoggedIn:!1,session:null,isPending:!1}))}))},nextAuth:()=>{let t=n().authItems.length,r=n().currentAuth+1;r>=t||e(()=>({currentAuth:r}))},previousAuth:()=>{let t=n().currentAuth-1;t<0||e(()=>({currentAuth:t}))},setAuth:t=>{t!==-1&&(t<0||t>=n().authItems.length)||e(()=>({currentAuth:t}))},addService:(t,r)=>{if(!t.service)return;let o=t.service.find(s=>s.type==="AuthAccessTokenService2"),a=t;if(n().authItems.find(s=>s.service.id===t.id)){e(()=>({authItems:_(t.id,n().authItems,s=>({...s,instances:s.instances+1}))}));return}if(e(()=>({currentAuth:a.profile==="active"?0:n().currentAuth,authItems:[{id:t.id,type:t.profile,service:t,probeId:r,canAuthenticate:!0,instances:1,isPending:!1,isLoggedIn:!1,session:null},...n().authItems]})),t.profile==="external"){if(!o)throw new Error("Token service not found");Wt(o).then(s=>{e(()=>({authItems:_(t.id,n().authItems,u=>({...u,isLoggedIn:!0,isPending:!1,session:{token:s.accessToken,expires:s.expiresIn}}))}))}).catch(s=>{e(()=>({authItems:_(t.id,n().authItems,u=>({...u,isLoggedIn:!1,isPending:!1,canAuthenticate:!1,error:s.message}))}))})}if(t.profile==="kiosk"){if(!o)throw new Error("Token service not found");e(()=>({authItems:_(t.id,n().authItems,s=>({...s,isPending:!0}))})),zn(a).then(()=>{Wt(o).then(s=>{e(()=>({authItems:_(t.id,n().authItems,u=>({...u,isLoggedIn:!0,isPending:!1,session:{token:s.accessToken,expires:s.expiresIn}}))}))}).catch(s=>{e(()=>({authItems:_(t.id,n().authItems,u=>({...u,isLoggedIn:!1,isPending:!1,error:s.message}))}))})})}t.profile},removeService:(t,r)=>{let o=n().currentAuth===n().authItems.findIndex(i=>i.service.id===t.id),a=n().currentAuth;if(o){let i=n().authItems.find(u=>u.service.id===t.id);i&&i.instances>1||(a=n().authItems.findIndex(c=>c.service.id!==t.id&&c.instances>0))}e(()=>({authItems:_(t.id,n().authItems,i=>({...i,instances:i.instances-1})),currentAuth:a}))}})),Dn=(e,n)=>(0,_t.createStore)((t,r)=>({service:e,status:e?"unknown":"success",shouldRedirect:!1,redirectResource:null,shouldSubstitute:!1,substituteResource:null,error:null,errorHeading:null,errorNote:null,shouldDisplayResource:!1,token:n||null,async probe(){if(!r().service)return;let o=r().service?.id;if(!o){t({status:"error",error:"Service ID not found",errorHeading:{en:["Service ID not found"]}});return}t({status:"probing"});let a=r().token;try{let i=await fetch(o,{headers:a?{Authorization:`Bearer ${r().token}`,Accept:"application/json"}:{Accept:"application/json"}}).then(s=>s.json());if(i.status===200)t({status:"success",shouldDisplayResource:!0,error:null,errorHeading:null,errorNote:null,shouldSubstitute:!1,shouldRedirect:!1});else if(i.status<400&&i.status>=300){if(!i.location)throw new Error("Redirect location not found");t({status:"error",shouldDisplayResource:!1,shouldRedirect:!0,redirectResource:i.location||null})}else if(i.status===401)t({status:"error",shouldDisplayResource:!1,shouldRedirect:!1,shouldSubstitute:!!i.substitute,substituteResource:i.substitute||null,error:"Unauthorized",errorHeading:i.heading||{en:["Unauthorized"]},errorNote:i.note||null});else throw new Error("Unknown error")}catch(i){t({status:"error",error:i.message,errorHeading:{en:["Unknown error"]}})}},setToken(o){t({token:o})}}));function Fn(e){let n=e.service||e.services||[],t={hasAuth:!1,services:{}};for(let r of n)if(r.type==="AuthProbeService2"){t.services.probe=r,t.hasAuth=!0;let o=r.service.filter(a=>a.type==="AuthAccessService2");o[0]&&(t.services.access=o[0])}return t}async function Wt(e,{strict:n=!0}={}){return new Promise((t,r)=>{let o=Math.random().toString(36).substring(7),a=`${e.id}?messageId=${o}&origin=${window.location.origin}`,i=c=>{let l=c.data;if(l.messageId===o){if(n&&l.type!=="AuthAccessToken2"){s(),r("Invalid response, expected type=AuthAccessToken2");return}if(!l.accessToken){s(),r("Invalid response, expected accessToken");return}s(),t(l)}},s=()=>window.removeEventListener("message",i),u=document.createElement("iframe");u.src=a,u.style.display="none",document.body.appendChild(u),window.addEventListener("message",i)})}function Hn(e){let n=window.location;if(e){let t=document.createElement("a");return t.href=e,t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")}return n.protocol+"//"+n.hostname+(n.port?":"+n.port:"")}async function zn(e){let n=`${e.id}?origin=${Hn()}`,t=window.open(n);if(!t)throw new Error("Failed to open window");return new Promise((r,o)=>{let a=setInterval(()=>{t.closed&&(clearInterval(a),r())},500)})}var be=require("react");var Bn=require("zustand");function $n(e){let n=(0,be.useMemo)(()=>Fn(e),[e]),t=Un(n.services.access?.id),r=(0,be.useMemo)(()=>Dn(n.services.probe,t),[n.services.probe]),o=(0,Bn.useStore)(r);return(0,be.useEffect)(()=>{o.status==="unknown"&&!t&&o.probe()},[n.services.probe,o.status]),(0,be.useEffect)(()=>{t&&(o.setToken(t),o.probe())},[t]),[e,o,n.hasAuth]}var De=require("react/jsx-runtime"),Re=(0,Y.createContext)(null),ri=(0,Y.createContext)(null);ri.displayName="CurrentAuth";var oi=(0,Y.createContext)(null);oi.displayName="AuthActions";function qn({children:e}){let n=(0,Y.useMemo)(()=>On(),[]);return(0,De.jsx)(Re.Provider,{value:n,children:e})}function Wn(){return!!(0,Y.useContext)(Re)}function jt(){let e=(0,Y.useContext)(Re);if(!e)throw new Error("useAuthActions must be used within a AuthProvider");return e}function ii(){let e=jt();return(0,rt.useStore)(e,t=>({login:t.login,logout:t.logout,nextAuth:t.nextAuth,previousAuth:t.previousAuth,setAuth:t.setAuth,addService:t.addService,removeService:t.removeService}))}function ai(e){let n=jt();return(0,rt.useStore)(n,r=>r.authItems.find(o=>o.service.id===e))}function Un(e){let n=jt();return(0,rt.useStore)(n,r=>r.authItems.find(o=>o.id===e)?.session?.token)}function si(e){let n=ii(),t=ai(e.service.id);return(0,Y.useEffect)(()=>(n?.addService(e.service,e.probeId),()=>{n?.removeService(e.service,e.probeId)}),[e.service]),t?(t.error||!t.isLoggedIn,e.children):null}function Yt(){return null}function _n(e){let[n,t,r]=$n(e.resource),o=e.fallbackComponent||Yt,a=e.loadingComponent||Yt,i=e.errorComponent||Yt,s=t.service,u=null;if(!r||!s)return e.children(n);let c=s.service.filter(l=>l.type==="AuthAccessService2");t.status==="error"&&(u=(0,De.jsx)(i,{resource:e.resource,error:t.error||"",heading:t.errorHeading,note:t.errorNote,extra:e.extra})),(t.status==="unknown"||t.status==="probing")&&(u=(0,De.jsx)(a,{})),t.status==="success"&&(u=e.children(n));for(let l of c)u=(0,De.jsx)(si,{service:l,probeId:s.id,children:u},l.id);return u}var Fe=require("react");var Yn=require("zustand/vanilla"),ci=e=>e.id||e["@id"];function ui(e){return(Array.isArray(e.service)?e.service:[e.service]).find(t=>t.profile==="http://iiif.io/api/search/0/autocomplete"||t.profile==="http://iiif.io/api/search/1/autocomplete"||t.profile==="AutoCompleteService1")}var jn=e=>{let n;typeof e=="string"?n={"@context":"http://iiif.io/api/search/1/context.json",profile:"http://iiif.io/api/search/1/search","@id":e,id:e,service:[]}:n=e;let t=n?ci(n):void 0,r=null;return(0,Yn.createStore)((o,a)=>({service:n,resources:[],lastQuery:{},loading:!1,error:!1,highlight:null,hasSearch:!!n,hasAutocomplete:n?!!ui(n):!1,errorMessage:"",search(i,s={}){if(!t)throw new Error("No search service found.");r&&!r.signal.aborted&&r.abort(),r=new AbortController;let u=new URLSearchParams;i.q&&u.set("q",i.q),i.motivation&&u.set("motivation",i.motivation),i.date&&u.set("date",i.date),i.user&&u.set("user",i.user),o({loading:!0}),fetch(`${t}?${u.toString()}`,{signal:r.signal,headers:{"Content-Type":"application/json",Accept:"application/json",...s.headers||{}}}).then(async c=>{if(!r?.signal.aborted)if(c.ok){let l=await c.json();o({resources:l.resources,error:!1,errorMessage:""})}else o({resources:[],error:!0,errorMessage:c.statusText})})},clearSearch(){o({resources:[],error:!1,errorMessage:""})},highlightResult(i){let s=a().resources.find(u=>u["@id"]===i);o({highlight:s})},nextResult(){let i=a().resources,s=a().highlight;if(!s){o({highlight:i[0]||null});return}let u=i.findIndex(c=>c["@id"]===s["@id"]);if(u===-1){o({highlight:i[0]||null});return}o({highlight:i[u+1]||i[0]||null})},previousResult(){let i=a().resources,s=a().highlight;if(!s){o({highlight:i[i.length-1]||null});return}let u=i.findIndex(c=>c["@id"]===s["@id"]);if(u===-1){o({highlight:i[i.length-1]||null});return}if(u===0){o({highlight:i[i.length-1]||null});return}o({highlight:i[u-1]||i[i.length-1]||null})}}))};var li=require("zustand");function Kn(){let e=k();return e?e.service.find(n=>n.profile==="SearchService1"||n.profile==="http://iiif.io/api/search/1/search"):void 0}var ot=require("react/jsx-runtime"),Ae=(0,Fe.createContext)(null);Ae.displayName="Search";function Qn(e){let n=Kn();return e.store?(0,ot.jsx)(Ae.Provider,{value:e.store,children:e.children}):(0,ot.jsx)(mi,{service:n,children:e.children})}function mi({service:e,children:n}){let t=(0,Fe.useMemo)(()=>jn(e),[e]);return(0,ot.jsx)(Ae.Provider,{value:t,children:n})}var F=require("react/jsx-runtime"),He=()=>{},Be=(0,it.createContext)({setCurrentCanvasId:He,setCurrentCanvasIndex:He,nextCanvas:He,previousCanvas:He,items:[],sequence:[],setSequenceIndex:He,currentSequenceIndex:0,hasNext:!1,hasPrevious:!1});function di(e){let n=k(),{cursor:t,visibleItems:r,next:o,sequence:a,items:i,setCanvasIndex:s,setCanvasId:u,previous:c,setSequenceIndex:l,hasNext:m,hasPrevious:p}=Ln({startCanvas:e.startCanvas,disablePaging:e.pagingEnabled===!1}),y=(0,it.useMemo)(()=>({sequence:a,items:i,setCurrentCanvasId:u,nextCanvas:o,previousCanvas:c,totalCanvases:i.length,setCurrentCanvasIndex:s,setSequenceIndex:l,currentSequenceIndex:t,hasNext:m,hasPrevious:p}),[a,i,u,o,c,i,s,l,t]);return n?r.length===0?null:(0,F.jsx)(Be.Provider,{value:y,children:(0,F.jsx)(Ce.Provider,{value:r,children:(0,F.jsx)(G,{canvas:r[0],children:e.children})})}):(console.warn("The manifest passed to the provider is not a valid IIIF manifest."),(0,F.jsx)("div",{children:"Sorry, something went wrong."}))}function Zn(e){let n=xe(e.vault),t=Cn(e.manifest);if(!t)return console.warn("The manifest passed to the provider is not a valid IIIF manifest."),(0,F.jsx)("div",{children:"Sorry, something went wrong."});if(t.error)return(0,F.jsx)("div",{children:t.error.toString()});if(!t.isLoaded)return(0,F.jsx)("div",{children:"Loading..."});let r=(0,F.jsx)(di,{...e,children:e.children});return(0,F.jsx)(Se,{vault:n,children:(0,F.jsx)(bn,{manifest:t.id,children:(0,F.jsx)(qn,{children:(0,F.jsx)(Qn,{children:e.rangeId?(0,F.jsx)(Mn,{range:e.rangeId,children:r}):r})})})})}function Xn(){return(0,Gn.useContext)(Be)}var Jn=$(require("react"),1),Kt=require("react"),er=$(require("mitt"),1),pi=require("react/jsx-runtime"),fi=(0,er.default)(),$e=(0,Kt.createContext)({emitter:fi});$e.displayName="Events";function tr(){return Jn.default.useContext($e).emitter}var nr=$(require("react"),1),Z=require("react/jsx-runtime"),gi=nr.default.createContext({});function rr(){let e=(0,j.useContext)(gi),n=Object.keys(e),t={};for(let r of n)e[r].Provider&&(t[r]={value:(0,j.useContext)(e[r]),Provider:e[r].Provider});return t}function yi(e){let n=Object.keys(e),t=e.children;for(let r of n){if(r==="children")continue;let{value:o,Provider:a}=e[r];t=(0,Z.jsx)(a,{value:o,children:t})}return t}function or(){return{VaultContext:(0,j.useContext)(ce),ResourceContext:(0,j.useContext)(Je),SimpleViewerReactContext:(0,j.useContext)(Be),VisibleCanvasReactContext:(0,j.useContext)(Ce),AuthRContext:(0,j.useContext)(Re),SearchReactContext:(0,j.useContext)(Ae),ReactEventContext:(0,j.useContext)($e)}}function ir(e){return(0,Z.jsx)(Se,{vault:e.bridge.VaultContext.vault||void 0,resources:e.bridge.ResourceContext,children:(0,Z.jsx)(Ce.Provider,{value:e.bridge.VisibleCanvasReactContext,children:(0,Z.jsx)(Be.Provider,{value:e.bridge.SimpleViewerReactContext,children:(0,Z.jsx)($e.Provider,{value:e.bridge.ReactEventContext,children:(0,Z.jsx)(Re.Provider,{value:e.bridge.AuthRContext,children:(0,Z.jsx)(Ae.Provider,{value:e.bridge.SearchReactContext,children:e.custom?(0,Z.jsx)(yi,{...e.custom,children:e.children}):e.children})})})})})})}var Pe=require("react");var X=require("react");var at=require("@iiif/helpers/vault/actions");var ar=require("react");function sr(){let n=P().getStore();return(0,ar.useMemo)(()=>t=>n.dispatch(t),[n])}function cr(e){return typeof e!="string"&&e&&e.bindToVault}function ur(){let e=P(),n=(0,X.useRef)([]),t=sr(),r=(0,X.useMemo)(()=>`vault://annotation-page/${new Date().getTime()}/${Math.round(Math.random()*1e9).toString(16)}`,[]);(0,X.useLayoutEffect)(()=>{let s={id:r,type:"AnnotationPage",behavior:[],label:null,thumbnail:[],summary:null,requiredStatement:null,metadata:[],rights:null,provider:[],items:[],seeAlso:[],homepage:[],rendering:[],service:[]};t(at.entityActions.importEntities({entities:{AnnotationPage:{[s.id]:s}}}))},[r]);let o=T(s=>r&&s.iiif.entities.AnnotationPage[r]||null,[r]),a=(0,X.useCallback)((s,u)=>{if(r){if(cr(s)){let m=s;m.__vault||m.bindToVault(e),s=typeof m.source=="string"?m.source:m.source.id,n.current[s]=m}else typeof s!="string"&&(s=s.id);let c=e.get({id:r,type:"AnnotationPage"}),l=e.get({id:s,type:"Annotation"});c&&l&&(c.items.find(m=>m.id===l.id)||t(at.entityActions.addReference({id:r,type:"AnnotationPage",key:"items",reference:{id:s,type:"Annotation"},index:u})))}},[r]),i=(0,X.useCallback)(s=>{r&&(cr(s)?s=typeof s.source=="string"?s.source:s.source.id:typeof s!="string"&&(s=s.id),n.current[s]&&n.current[s].beforeRemove(),e.get({id:r,type:"AnnotationPage"})&&t(at.entityActions.removeReference({id:r,type:"AnnotationPage",key:"items",reference:{id:s,type:"Annotation"}})))},[r]);return[o,{addAnnotation:a,removeAnnotation:i}]}var fr=require("react/jsx-runtime"),lr=(0,Pe.createContext)(null);function mr(){let e=(0,Pe.useContext)(lr);return[e.fullPage,{addAnnotation:e.addAnnotation,removeAnnotation:e.removeAnnotation}]}function dr({children:e}){let[n,{addAnnotation:t,removeAnnotation:r}]=ur();return(0,fr.jsx)(lr.Provider,{value:(0,Pe.useMemo)(()=>({fullPage:n,addAnnotation:t,removeAnnotation:r}),[n]),children:e})}var Te=require("react/jsx-runtime");function pr({width:e,style:n,height:t,error:r,resetErrorBoundary:o}){return(0,Te.jsxs)("div",{style:{width:e,height:t,minHeight:500,...n||{},background:"#f9f9f9"},children:[(0,Te.jsx)("h3",{children:"Error occurred"}),(0,Te.jsx)("p",{children:r.message}),(0,Te.jsx)("button",{type:"button",onClick:o,children:"Reset"})]})}var st=require("react"),ue=(0,st.createContext)(null);function ct(){return(0,st.useContext)(ue)}var le=require("react"),Qt=(0,le.createContext)(()=>{}),Gt=(0,le.createContext)(()=>{});function L(e,n,t,r,o=[]){let a=(0,le.useContext)(e==="portal"?Gt:Qt);(0,le.useEffect)(()=>(e!=="none"&&a(n,t,r),()=>{a(n,null)}),[n,e,a,...o])}var Ie=require("react");var gr=require("react");function A(e={},n=[]){let{id:t,selector:r}=e,o=q(),a=t||o.canvas,i=T(s=>a?s.iiif.entities.Canvas[a]:void 0,[a]);return(0,gr.useMemo)(()=>{if(i)return r?r(i):i},[i,r,...n])}var Zt=(0,Ie.createContext)(()=>{});function yr(e){let n=A(),t=(0,Ie.useContext)(Zt);(0,Ie.useEffect)(()=>n&&n.id?(t(n.id,e),()=>t(n.id,-1)):()=>{},[n,e])}var E=require("react/jsx-runtime");function vr({children:e,errorFallback:n,outerContainerProps:t={},worldScale:r,...o}){let[a,i]=(0,z.useState)(),s=rr(),u=or(),c=n||pr,[l,m]=(0,z.useState)({}),p=Object.entries(l),[y,g]=(0,z.useState)({}),d=Object.entries(y),[x,h]=(0,z.useState)({}),v=(0,z.useMemo)(()=>r||Math.max(...Object.values(x)),[x]),f=(0,z.useMemo)(()=>({maxOverZoom:v||1,...o.runtimeOptions||{}}),[v,o.runtimeOptions]),S=(0,z.useCallback)((b,C)=>{h(D=>{if(C===-1){let{[b]:Qe,...Q}=D;return Q}return{...D,[b]:C}})},[]),R=(0,z.useCallback)((b,C,D)=>{m(({[b]:Qe,...Q})=>C?{...Q,[b]:{element:C,props:D}}:Q)},[]),w=(0,z.useCallback)((b,C,D)=>{g(({[b]:Qe,...Q})=>C?{...Q,[b]:{element:C,props:D}}:Q)},[]);return(0,E.jsxs)(hr.ErrorBoundary,{resetKeys:[],fallbackRender:b=>(0,E.jsx)(c,{...o,...b}),children:[(0,E.jsx)(ut.AtlasAuto,{...o,containerProps:{style:{position:"relative"},...o.containerProps||{}},htmlChildren:(0,E.jsx)(E.Fragment,{children:p.map(([b,{element:C,props:D}])=>(0,E.jsx)(z.default.Fragment,{children:(0,E.jsx)(C,{...D||{}})},b))}),onCreated:b=>{i(b),o.onCreated&&o.onCreated(b)},runtimeOptions:f,children:(0,E.jsx)(ue.Provider,{value:a,children:(0,E.jsx)(Zt.Provider,{value:S,children:(0,E.jsx)(Qt.Provider,{value:R,children:(0,E.jsx)(Gt.Provider,{value:w,children:(0,E.jsx)(ir,{bridge:u,custom:s,children:(0,E.jsx)(ut.ModeContext.Provider,{value:o.mode||"explore",children:(0,E.jsx)(dr,{children:e})})})})})})})}),(0,E.jsx)("div",{children:d.map(([b,{element:C,props:D}])=>(0,E.jsx)(z.default.Fragment,{children:(0,E.jsx)(C,{...D||{}})},b))})]})}var dt=require("@atlas-viewer/atlas");var Xt=require("react"),Sr=require("@iiif/helpers/events");function lt(e,n){let t=P(),r=(0,Xt.useMemo)(()=>(0,Sr.createEventsHelper)(t),[t]),o=T(()=>e&&e.id?t.getResourceMeta(e.id,"eventManager"):null,[e]);return(0,Xt.useMemo)(()=>e?r.getListenersAsProps(e,n):{},[o,e,t,n])}var xr=require("react"),Cr=require("@iiif/helpers/styles");function we(e,n){let t=P(),r=(0,xr.useMemo)(()=>(0,Cr.createStylesHelper)(t),[t]);return T(()=>{if(!e)return null;let o=r.getAppliedStyles(e.id);return o?n?o[n]:o:void 0},[e,n])}var Ar=require("react");var br=require("react");var Rr=require("@iiif/helpers/annotation-targets");function mt(e={},n=[]){let{id:t,selector:r}=e,o=q(),a=P(),i=t||o.annotation,s=T(c=>i?c.iiif.entities.Annotation[i]:void 0,[i]),u=T(c=>s&&s.body?s.body.map(l=>l?l.type==="SpecificResource"?{...l,source:a.get(l)}:l?c.iiif.entities[l.type][l.id]:null:null).filter(Boolean):[],[s]);return(0,br.useMemo)(()=>{if(!s)return;let c={...s,body:u,target:(0,Rr.expandTarget)(s.target,{typeMap:a.getState().iiif.mapping})};return r?r(c):c},[s,r,u,...n])}var Pr=require("react/jsx-runtime"),ft=({id:e,style:n,className:t,interactive:r})=>{let o=mt({id:e}),a=we(o,"atlas"),i=we(o,"html"),s=lt(o,["atlas"]),u=A(),c=(0,Ar.useMemo)(()=>(0,dt.mergeStyles)(n,a),[n,a]);return u&&o&&o.target&&o.target.selector&&o.target.selector.type==="BoxSelector"&&o.target.source&&(o.target.source.id===u.id||o.target.source===u.id)?(0,Pr.jsx)(dt.RegionHighlight,{id:o.id,isEditing:!0,region:o.target.selector.spatial,style:c,className:i?.className||t,interactive:!!(i?.href||r),href:i?.href||null,title:i?.title||null,hrefTarget:i?.target||null,onClick:()=>{},...s}):null};var wr=require("react");var Tr=require("react");function Ir(e={},n=[]){let{id:t,selector:r}=e,o=q(),a=t||o.annotationPage,i=T(s=>a?s.iiif.entities.AnnotationPage[a]:void 0,[a]);return(0,Tr.useMemo)(()=>{if(i)return r?r(i):i},[i,...n])}var Jt=require("react/jsx-runtime"),Ue=({className:e,page:n})=>{let t=Ir({id:n.id})||n,r=we(t,"atlas"),o=we(t,"html");return T(a=>t.id?a.iiif.entities.AnnotationPage[t.id]:null,[]),(0,Jt.jsx)(wr.Fragment,{children:t.items?.map(a=>(0,Jt.jsx)(ft,{id:a.id,style:r,className:o?.className||e},a.id))})};var oe=require("react");var Me=require("react");var Mr=require("@iiif/helpers");function pt(e,n){let{selector:t,source:r}=(0,Mr.expandTarget)(n);if(r.id!==e.id)return[null,r];let o={type:"BoxSelector",spatial:{x:0,y:0,width:Number(e.width),height:Number(e.height)}};return[t?t.type==="TemporalSelector"?{type:"TemporalBoxSelector",temporal:t.temporal,spatial:o.spatial}:t:null,r]}var Vr={makeChoice:()=>{}},gt={type:"unknown"},I=e=>({type:"unknown",reason:e,annotations:{pages:[]}}),Er=(e,n)=>({type:"empty",width:e,height:n,annotations:{pages:[]},image:null,images:[]});var qe=require("react");function hi(e,n){let t=e?.iiif?.meta[n];return t?t.annotationPageManager:null}function kr(e,n){return T(t=>{let r=[];if(!e)return r;let o=Object.keys(t.iiif.entities.AnnotationPage);for(let a of o)if(!n||n.indexOf(a)!==-1){let i=hi(t,a);i&&i.views&&i.views[e]&&r.push(a)}return r},[e,n])}function Nr({canvas:e,manifest:n,all:t,canvases:r}){let o=[];if(n)for(let a of n.annotations)o.indexOf(a.id)===-1&&o.push(a.id);if(t){if(r&&r.length)for(let a of r)for(let i of a.annotations)o.indexOf(i.id)===-1&&o.push(i.id)}else if(e)for(let a of e.annotations)o.indexOf(a.id)===-1&&o.push(a.id);return o}function vi(e,n){let t=e?.iiif?.meta[n];return t?t.annotationPageManager:null}function Lr(e,n={}){let t=P(),r=k(),o=A(),a=nt(),i=(0,qe.useMemo)(()=>Nr({all:n.all,manifest:r,canvas:o,canvases:a}),[n.all,o,a,r]),s=kr(e,n.all?void 0:i),u=(0,qe.useCallback)(l=>{e&&t.setMetaValue([l,"annotationPageManager","views"],m=>m&&!m[e]?m:{...m||{},[e]:!1})},[e,t]),c=(0,qe.useCallback)((l,m={})=>{if(!e)return;let p=t.getState(),y=[];if(m?.deselectOthers){let g=Object.keys(p.iiif.entities.AnnotationPage);for(let d of g){let x=vi(p,d);x&&x.views&&x.views[e]&&y.push(d)}}for(let g of y)u(g);t.setMetaValue([l,"annotationPageManager","views"],g=>g&&g[e]?g:{...g||{},[e]:!0})},[e,u,t]);return{availablePageIds:i,enabledPageIds:s,setPageEnabled:c,setPageDisabled:u}}function zr(e,n){return T((t,r)=>r.get(e.map(o=>({id:o,type:n}))),[e,n])}var Br=$(require("mitt"),1),$r=require("react"),Ur=require("zustand");var yt=$(require("react"),1),Or=require("@iiif/helpers/image-service"),ht=require("zustand"),Dr=yt.default.createContext(Or.imageServices.store);Dr.displayName="ImageServicesHelper";function en(){return(0,yt.useContext)(Dr)}function Fr(e){let n=en();return(0,ht.useStore)(n,({loaded:t})=>t[e])}function vt(){let e=en();return(0,ht.useStore)(e,({loadServiceSync:n})=>n)}function Hr(){let e=en();return(0,ht.useStore)(e,({loaded:n})=>n)}var Si=(0,Ur.createStore)((e,n)=>({loaded:{},setLoaded:(t,r="done")=>{e(o=>({loaded:{...o.loaded,[t]:r}}))}})),xi=(0,Br.default)();xi.on("loaded",e=>{Si.getState().setLoaded(e.imageServiceId)});function qr(){let e=vt(),n=Hr();return[(0,$r.useCallback)((r,{height:o,width:a})=>r&&e(r,{height:o,width:a},!0),[e]),n]}var me=require("react");function Wr(e={}){let n=mt(),t=A(e.canvasId?{id:e.canvasId}:void 0);return T((r,o)=>{if(!t)return[];if(n&&e.enableSingleAnnotation)return[n];let a=o.get(t.items),i=[];for(let s of a)i.push(...o.get(s.items));return i},[t])}var _r=require("@iiif/helpers/painting-annotations");function Yr(e,n=[]){let t=P(),r=(0,me.useMemo)(()=>(0,_r.createPaintingAnnotationsHelper)(t),[]),o=Wr({enableSingleAnnotation:e?.enableSingleAnnotation}),[a,i]=(0,me.useState)(e?.defaultChoices||[]),s=(0,me.useMemo)(()=>r.getPaintables(o,a),[t,o,a,...n]),c={makeChoice:(0,me.useCallback)((l,{deselectOthers:m=!0,deselect:p=!1}={})=>{s.choice&&i(y=>{if(p){let d=y.filter(x=>x!==l);if(d.length===0){let x=s.items[0].resource.id;return x?[x]:[]}return d}if(m)return[l];let g=[...y];if(g.length===0&&s.items.length){let d=s.items[0].resource.id;d&&g.push(d)}return y.indexOf(l)!==-1?y:[...y,l]})},[s.choice])};return[s,c]}var Ci=["model/gltf-binary"];function jr(e,n){let t=n.items[0],r=t.resource;return r.format?Ci.indexOf(r.format)===-1?I(`3D format: ${r.format} is unsupported`):{type:"3d-model",model:r,annotationId:t.annotationId,annotation:t.annotation}:I("Unknown format")}function Kr(e,n){let t=n.items,r=t[0];if(t.length===0||!r)return I("No audio");if(!e.duration)return I("No duration on canvas");if(t.length>1)return I("Only one audio source supported");let o=r.resource;return o?"format"in o?{type:"media",media:{annotationId:r.annotationId,annotation:r.annotation,duration:e.duration,url:o.id,type:"Sound",target:{type:"TemporalSelector",temporal:{startTime:0,endTime:e.duration}},format:o.format,selector:{type:"TemporalSelector",temporal:{startTime:0,endTime:e.duration}}},annotations:{pages:[]}}:I("Audio does not have format"):I("Unknown audio")}var Qr=require("@iiif/parser/image-3");var tn=require("@iiif/helpers/annotation-targets");function St(e,n,t){let r=[];for(let o of n.items){let a=o.resource&&o.resource.type==="SpecificResource"?o.resource.source:o.resource;if(!a.id)return I("No resource Identifier");let i;if(a.service){let d=(0,Qr.getImageServices)(a);d[0]&&(i=t(d[0],e))}let s={type:"BoxSelector",spatial:{x:0,y:0,width:Number(e.width),height:Number(e.height)}},[u,c]=pt(e,o.target),l=e.id?.split("?")[0]||"";if(!(c.id===e.id||decodeURIComponent(c.id||"")===(e.id||"")||c.id===l||decodeURIComponent(c.id||"")===l))continue;let m=o.resource.width&&o.resource.height?{type:"BoxSelector",spatial:{x:0,y:0,width:o.resource.width,height:o.resource.height}}:void 0,p=o.resource.type==="SpecificResource"?(0,tn.expandTarget)(o.resource):null;if(o.selector){let d=(0,tn.expandTarget)({type:"SpecificResource",source:o.resource,selector:o.selector});d&&(p=d)}let y=p&&p.selector&&(p.selector.type==="BoxSelector"||p.selector.type==="TemporalBoxSelector")?{type:"BoxSelector",spatial:{x:p.selector.spatial.x,y:p.selector.spatial.y,width:p.selector.spatial.width,height:p.selector.spatial.height}}:void 0;i&&!i.id&&(i.id=i["@id"]);let g={id:a.id,type:"Image",annotationId:o.annotationId,annotation:o.annotation,width:Number(u||y?a.width:e.width),height:Number(u||y?a.height:e.height),service:i,sizes:i&&i.sizes?i.sizes:a.width&&a.height?[{width:a.width,height:a.height}]:[],target:u&&u.type!=="PointSelector"?u:s,selector:y||{type:"BoxSelector",spatial:{x:0,y:0,width:Number(e.width),height:Number(e.height)}}};r.push(g)}return{type:"images",image:r[0],images:r,choice:n.choice}}function Gr(e,n={},t){let r=e.language||t||"none";switch(e.type){case"TextualBody":{typeof e.value<"u"&&(n[r]=[e.value]);break}case"List":case"Composite":case"Choice":e.items&&e.items.forEach(o=>Gr(o,n,r))}return n}function xt(e,n){let t=[];return n.items.forEach(r=>{if(r.resource){let[o]=pt(e,r.target);t.push({type:"Text",annotationId:r.annotationId,annotation:r.annotation,text:Gr(r.resource),target:o})}}),{type:"textual-content",items:t}}var Ct=require("@iiif/helpers"),bi=/^.*(?:(?:youtu\.be\/|v\/|vi\/|u\/\w\/|embed\/|shorts\/)|(?:(?:watch)?\?vi?=|&vi?=))([^#&?]*).*/;function bt(e,n,t){let r=n.items.filter(y=>y.type==="video"),o=r[0],a=!1;if(e.duration||(a=!0),r.length>1||!o)return I("Only one video source supported");let i=r[0]?.resource,s=!!(i.service||[]).find(y=>(y.profile||"").includes("youtube.com"));if(!s&&a)return I("Video does not have duration");if(!i)return I("Unknown video");if((!i.format||i.format==="text/html")&&!s)return I("Video does not have format");let u=[],c=t.get(e.annotations||[]);for(let y of c){let g=t.get(y.items||[]);for(let d of g)if((d.motivation?Array.isArray(d.motivation||"")?d.motivation:[d.motivation]:[]).includes("supplementing")){let h=t.get(d.body||[]);for(let v of h){let f=v;if(f.type==="Choice")for(let S of f.items){let R=t.get(S);R.format==="text/vtt"&&u.push({id:R.id,type:"Text",format:"text/vtt",label:R.label,language:R.language})}else f.format==="text/vtt"&&u.push({id:f.id,type:"Text",format:"text/vtt",label:f.label,language:f.language})}}}let l={annotationId:o.annotationId,annotation:o.annotation,duration:e.duration,url:i.id,type:"Video",target:{type:"TemporalSelector",temporal:{startTime:0,endTime:e.duration}},format:i.format,selector:{type:"TemporalSelector",temporal:{startTime:0,endTime:e.duration}}},m=(0,Ct.expandTarget)(o.target);m.selector&&m.selector.type==="TemporalBoxSelector"&&(l.target=m.selector);let{selector:p}=(0,Ct.parseSelector)(o.selector);if(p===null){let y=l.target.temporal.startTime,d=(l.target.temporal.endTime||e.duration)-y;l.selector={type:"TemporalSelector",temporal:{startTime:0,endTime:d}}}else p.type==="TemporalSelector"&&(l.selector=p);if(s){l.type="VideoYouTube";let y=i.id.match(bi);if(!y[1])return I("Video is not known youtube video");l.youTubeId=y[1]}return{type:"media",media:l,annotations:{pages:[]},captions:u}}function Zr(e,n,t,r){let o={type:"complex-timeline",items:[],keyframes:[],duration:e.duration||0},a={type:"complex-choice",items:[]};function i(c){c.choice&&(c.choice.type==="complex-choice"?a.items.push(...c.choice.items):a.items.push(c.choice))}for(let c of n.items){if(c.type==="image"){let l=St(e,{choice:null,allChoices:null,types:["image"],items:[c]},t);if(l.type==="images"){i(l),o.items.push(l.image);let m={id:l.image.annotationId,type:"enter",resourceType:"image",time:l.image.target?.temporal?.startTime||0};o.keyframes.push(m);let p={id:l.image.annotationId,type:"exit",resourceType:"image",time:l.image.target?.temporal?.endTime||e.duration||0};o.keyframes.push(p)}}if(c.type==="textualbody"){let l=xt(e,{choice:null,allChoices:null,types:["textualbody"],items:[c]});if(l.type==="textual-content"){i(l);let m=l.items[0];o.items.push(m);let p=m.target,y={id:m.annotationId,type:"enter",resourceType:"text",time:p.temporal?.startTime||0};o.keyframes.push(y);let g={id:m.annotationId,type:"exit",resourceType:"text",time:p.temporal?.endTime||e.duration||0};o.keyframes.push(g)}}if(c.type==="video"){let l=bt(e,{choice:null,allChoices:null,types:["video"],items:[c]},r);if(l.type==="media"){i(l);let m=l.media;o.items.push(m);let p={id:m.annotationId,type:"enter",resourceType:"video",time:m.target?.temporal?.startTime||0};o.keyframes.push(p);let y={id:m.annotationId,type:"exit",resourceType:"video",time:m.target?.temporal?.endTime||e.duration||0};o.keyframes.push(y)}}}o.keyframes.sort((c,l)=>c.time-l.time);let s=[],u=[];for(let c of o.keyframes){if(c.resourceType==="image"||c.resourceType==="text"){u.push(c);continue}if(c.type==="enter"){s.length===0&&(c.isPrime=!0),s.push(c),u.push(c);continue}if(c.type==="exit"&&(u.push(c),s=s.filter(l=>l.id!==c.id),s.length!==0)){let l=s[0],m={id:l.id,type:"change",isPrime:!0,resourceType:l.resourceType,time:c.time};u.push(m)}}return o.keyframes=u,a.items.length&&(o.choice=a),o}var Rt={},nn={get(e){return e},setMetaValue([e,n,t],r){let o=nn.getResourceMeta(e,n),a=o?o[t]:void 0,i=typeof r=="function"?r(a):r;Rt[e]={...Rt[e]||{},[n]:{...(Rt[e]||{})[n]||{},[t]:i}}},getResourceMeta:(e,n)=>{let t=Rt[e];if(t)return n?t[n]:t},async load(e){let n=typeof e=="string"?e:e.id;return fetch(n).then(t=>t.json())},requestStatus(e){}};function Xr({canvas:e,paintables:n,supports:t,loadImageService:r,vault:o=nn}){if(!e)return gt;if(n.types.length===0)return t.indexOf("empty")!==-1?Er(e.width,e.height):gt;if(n.types.length!==1)if(n.types.length===2&&n.types.indexOf("text")!==-1)n.types=n.types.filter(i=>i!=="text");else return t.indexOf("complex-timeline")===-1?I("Complex timeline not supported"):Zr(e,n,r,o);let a=n.types[0];return a==="image"?t.indexOf("images")===-1?I("Image not supported"):St(e,n,r):a==="Model"||a==="model"?t.indexOf("3d-model")===-1?I("3D not supported"):jr(e,n):a==="textualbody"?t.indexOf("textual-content")===-1?I("Textual content not supported"):xt(e,n):a==="sound"||a==="audio"?t.indexOf("media")===-1?I("Media not supported"):Kr(e,n):a==="video"?t.indexOf("media")===-1?I("Media not supported"):bt(e,n,o):gt}function Jr(e){let n=k(),t=A(),r=P(),o=tr(),a=e?.emitter||o,[i,s]=qr(),{enabledPageIds:u}=Lr(e?.annotationPageManagerId||n?.id||t?.id,{all:!1}),c=zr(u,"AnnotationPage"),l=e?.strategies||["empty","images","media","textual-content","complex-timeline"],[m,p]=Yr(e,[s]);(0,Me.useEffect)(()=>{let g=d=>{p.makeChoice(d.choiceId,{deselectOthers:d.deselectOthers,deselect:d.deselect})};return a.on("make-choice",g),()=>{a.off("make-choice",g)}},[]);let y=(0,Me.useMemo)(()=>Xr({canvas:t,paintables:m,supports:l,loadImageService:i,vault:r}),[t,m,r,p.makeChoice]);return(0,Me.useEffect)(()=>{let g=m.allChoices,d={canvasId:t?.id,manifestId:n?.id};g&&a.emit("choice-change",{choice:g,partOf:d})},[t?.id,m.allChoices]),(0,Me.useMemo)(()=>y.type==="unknown"?[y,Vr]:[{...y,annotations:{pages:c}},p],[y,c])}var At=require("react"),Pt=(0,At.createContext)(null);Pt.displayName="Strategy";function M(){let e=(0,At.useContext)(Pt);if(!e)throw new Error("useStrategy must be used within a StrategyProvider");return e}var eo=require("@iiif/helpers");var Tt=require("react"),It=(0,Tt.createContext)(null);It.displayName="Controls";function H(){let e=(0,Tt.useContext)(It);if(!e)throw new Error("useStrategy must be used within a StrategyProvider");return e}var rn=require("react/jsx-runtime");function to({strategies:e,registerActions:n,defaultChoices:t,onChoiceChange:r,mediaControlsDeps:o,renderMediaControls:a,renderViewerControls:i,viewControlsDeps:s,renderComplexTimelineControls:u,complexTimelineControlsDeps:c,throwOnUnknown:l,children:m}){let p=A(),y=P(),g=(0,oe.useMemo)(()=>(0,eo.createStylesHelper)(y),[y]),[d,x]=Jr({strategies:e||["images"],defaultChoices:t?.map(({id:S})=>S)}),h="choice"in d?d.choice:void 0;if((0,oe.useEffect)(()=>{n&&n(x)},[d.annotations]),(0,oe.useEffect)(()=>{r&&r(h)},[h]),(0,oe.useEffect)(()=>{if(t)for(let S of t)typeof S.opacity<"u"&&g.applyStyles({id:S.id},"atlas",{opacity:S.opacity})},[t]),d.type==="unknown"&&l)throw new Error(d.reason||"Unknown strategy");let v=(0,oe.useMemo)(()=>({renderMediaControls:a,mediaControlsDeps:o||[],renderViewerControls:i,viewControlsDeps:s||[],renderComplexTimelineControls:u,complexTimelineControlsDeps:c||[]}),[o,a,i,s,u,c]),f=(0,oe.useMemo)(()=>({strategy:d,actions:x,choices:"choice"in d?d.choice:[]}),[d,p]);return(0,rn.jsx)(It.Provider,{value:v,children:(0,rn.jsx)(Pt.Provider,{value:f,children:m})})}var no=require("react");var oo=require("react/jsx-runtime");function ro({x:e=0,y:n=0,keepCanvasScale:t,children:r}){let{strategy:o}=M(),a=A(),i=lt(a,["deep-zoom"]),s=(0,no.useMemo)(()=>t?1:Math.max(1,...o.type==="images"?o.images.map(c=>(c.width||0)/c.target?.spatial.width):[]),[t,o]);yr(s);let u=o.type==="images"?o.images.length:0;return a?(0,oo.jsx)("world-object",{height:a.height,width:a.width,x:e,y:n,...i,children:r},`${a.id}/${o.type}/${u}`):null}var io=require("react/jsx-runtime");function wt({style:e}){let n=A();return!n||!n.height||!n.width?null:(0,io.jsx)("box",{interactive:!1,target:{x:0,y:0,width:Number(n.width),height:Number(n.height)},style:e})}var so=require("react/jsx-runtime");function ao({backgroundStyle:e,alwaysShowBackground:n}){let{strategy:t}=M();return t.type!=="empty"&&!n?null:(0,so.jsx)(wt,{style:e})}var Et=require("react");var lo=$(require("mitt"),1);var V=require("react");function co(e){return{isMuted:!1,playRequested:!1,isPlaying:!1,isFinished:!1,volume:100,duration:e}}function Ri(e,n){switch(n.type){case"RESET":return n.state;case"FINISHED":return{...e,isFinished:!0,isPlaying:!1,playRequested:!1};case"PLAY_PAUSE":return{...e,isFinished:!1,isPlaying:!e.isPlaying};case"PLAY_REQUESTED":return{...e,isFinished:!1,playRequested:!0};case"PAUSE":return{...e,isPlaying:!1};case"PLAY":return{...e,isFinished:!1,playRequested:!1,isPlaying:!0};case"MUTE":return{...e,isMuted:!0};case"SET_VOLUME":return{...e,volume:n.volume,isMuted:n.volume===0};case"TOGGLE_MUTE":return{...e,isMuted:!e.isMuted};case"UNMUTE":return{...e,isMuted:!1}}return e}function on(e){let n=Math.round(e);return`${Math.floor(n/60)}:${`${n%60}`.padStart(2,"0")}`}function Ve(e){let[n,t]=(0,V.useReducer)(Ri,co(e.duration));(0,V.useEffect)(()=>{t({type:"RESET",state:co(e.duration)})},[e.duration]);let r=(0,V.useRef)(null),o=(0,V.useRef)(null),a=(0,V.useRef)(null),i=(0,V.useRef)(!1),s=(0,V.useCallback)(()=>{o.current&&r.current&&(o.current.innerHTML=on(r.current.currentTime),a.current&&(a.current.style.width=`${r.current.currentTime/e.duration*100}%`),i.current!==r.current.muted&&(i.current=r.current.muted,t(r.current.muted?{type:"MUTE"}:{type:"UNMUTE"})))},[e.duration]),u=(0,V.useCallback)(()=>{r.current&&(t({type:"PLAY_REQUESTED"}),r.current.play().then(()=>{t({type:"PLAY"})}),s())},[s]),c=(0,V.useCallback)(()=>{r.current&&(r.current.duration>0&&r.current.paused?u():l())},[s]),l=(0,V.useCallback)(()=>{r.current&&(r.current.pause(),t({type:"PAUSE"}),s())},[s]),m=(0,V.useCallback)(()=>{r.current&&(r.current.muted=!r.current.muted,t(r.current.muted?{type:"MUTE"}:{type:"UNMUTE"}))},[]),p=(0,V.useCallback)(()=>{r.current&&(r.current.muted=!0,t({type:"MUTE"}))},[]),y=(0,V.useCallback)(()=>{r.current&&(r.current.muted=!1,t({type:"UNMUTE"}))},[]),g=(0,V.useCallback)(h=>{r.current&&(r.current.muted=!1,r.current.volume=h/100,t({type:"SET_VOLUME",volume:h}))},[]),d=(0,V.useCallback)(h=>{r.current&&(r.current.currentTime=Math.max(0,Math.min(h*e.duration,e.duration)),s())},[]),x=(0,V.useCallback)(h=>{if(r.current){let v=typeof h=="function"?h(r.current.currentTime):h;r.current.currentTime=Math.max(0,Math.min(v,e.duration)),s()}},[]);return(0,V.useEffect)(()=>{let h=setInterval(()=>{s()},350);return()=>clearInterval(h)},[s,e.duration]),(0,V.useEffect)(()=>{let h=()=>{t({type:"FINISHED"})},v=r.current;return v?.addEventListener("ended",h),()=>v?.removeEventListener("ended",h)},[]),[{element:r,currentTime:o,progress:a},n,{play:u,pause:l,playPause:c,mute:p,unmute:y,toggleMute:m,setVolume:g,setDurationPercent:d,setTime:x}]}var mo=require("zustand/vanilla");function uo({currentKeyFrameIndex:e,keyframes:n,targetTime:t,currentTime:r}){if(r<=t){let o=n.findIndex(s=>s.time>t);if(o===-1)return[e,[]];let a={},i=n.slice(e,o);for(let s of i)s.type==="enter"&&(a[s.id]=s),s.type==="exit"&&(a[s.id]?delete a[s.id]:a[s.id]=s);return[o,Object.values(a)]}return[e,[]]}function fo({complexTimeline:e,startTime:n=0}){let t=(0,lo.default)(),r={},o={progress:null,currentTime:null},a=0,i=null,s=0,u=null;function c(){let v=x.getState().visibleElements,f=r,S=[],R=Object.keys(f);for(let w of R){let b=f[w],C=v[w];b&&C&&S.push(b)}return S}function l(){return Object.keys(r).map(v=>r[v])}function m(h){o.currentTime&&(o.currentTime.innerHTML=on(h),o.progress&&(o.progress.style.width=`${h/e.duration*100}%`))}let p=()=>{let h=x.getState(),v=h.currentPrime;if(!v)return;let f=r,S=h.visibleElements,R=Object.keys(f);for(let w of R){let b=f[w],C=S[w];if(b&&w!==v.id&&C){let D=s-C.time*1e3;Math.abs(s-C.time*1e3-b.currentTime*1e3)>300&&(b.currentTime=D/1e3)}}},y=(h=0)=>{let v=h-a,f=x.getState();if(f.isPlaying){let S=f.currentPrime;if(S){let C=r[S.id];C&&(C.paused?s+=v:s=(S.time+C.currentTime)*1e3)}else s+=v;let R=s/1e3;if(R>f.duration){x.getState().setTime(0),x.setState({isPlaying:!1}),g(),m(0);return}m(R);let[w,b]=uo({currentTime:R,currentKeyFrameIndex:f.nextKeyframeIndex,keyframes:f.complexTimeline.keyframes,targetTime:R});b.length&&f.applyKeyframes(w,b)}a=h,i=requestAnimationFrame(y)},g=()=>{i&&cancelAnimationFrame(i)},d=(h,v)=>{},x=(0,mo.createStore)((h,v)=>({complexTimeline:e,elements:{},visibleElements:{},isBuffering:!1,bufferMap:{},isMuted:!1,playRequested:!1,isPlaying:!1,isFinished:!1,isReady:!1,volume:100,duration:e.duration,clockStartRequests:0,clockStartTime:0,primeTime:0,currentPrime:null,clockRunning:!1,nextKeyframeIndex:0,startClock:()=>{v().clockRunning||(y(),u=setInterval(p,500)),h({clockRunning:!0,clockStartRequests:v().clockStartRequests+1})},applyKeyframes(f,S){let R=v(),w={...R.visibleElements},b=R.currentPrime;for(let C of S)C.type==="enter"&&(w[C.id]=C,t.emit("complex-timeline.enter",{id:C.id})),C.type==="exit"&&(w[C.id]=null,t.emit("complex-timeline.exit",{id:C.id})),C.isPrime&&(b=C);h({nextKeyframeIndex:f,visibleElements:w,currentPrime:b})},stopClock:()=>{let f=v().clockStartRequests;if(f!==0){if(f===1){g(),u&&clearInterval(u),h({clockRunning:!1,clockStartRequests:0});return}h({clockStartRequests:f-1})}},setElement:(f,S)=>{r[f]=S;let R=Object.keys(r),w=v().complexTimeline;d(S,f),w.items.filter(C=>C.type!=="Image"&&C.type!=="Text").every(C=>R.includes(C.annotationId))&&!v().isReady&&(t.emit("complex-timeline.ready",{complexTimeline:w}),h({isReady:!0}))},removeElement:f=>{delete r[f]},mute(){for(let f of l())f.muted=!0;h({isMuted:!0})},unmute(){for(let f of l())f.muted=!1;h({isMuted:!1})},play(){if(!v().isPlaying){for(let S of c())S.play();h({isPlaying:!0})}},pause(){if(v().isPlaying){for(let S of c())S.pause();h({isPlaying:!1})}},playPause(){let f=v();f.isPlaying?f.pause():f.play()},setDurationPercent(f){let R=v().duration*f;v().setTime(R)},setTime(f){let S=v(),R=s/1e3,w=typeof f=="function"?f(R):f,b=S.nextKeyframeIndex;if(R>w){h({visibleElements:{},currentPrime:null});let Ge=Object.keys(S.visibleElements);for(let Ze of Ge)t.emit("complex-timeline.exit",{id:Ze});R=0,b=0}let[C,D]=uo({currentTime:R,currentKeyFrameIndex:b,keyframes:S.complexTimeline.keyframes,targetTime:w});S.applyKeyframes(C,D),s=w*1e3;let Q=x.getState().visibleElements,jo=r,Ko=Object.keys(Q);for(let Ge of Ko){let Ze=Q[Ge];if(Ze){let gn=jo[Ge];gn&&(gn.currentTime=(s-Ze.time*1e3)/1e3)}}m(w)},setVolume(f){for(let S of l())S.volume=Math.min(1,Math.max(0,f/100));h({volume:f})},toggleMute(){let f=v();f.isMuted?(f.unmute(),h({isMuted:!1})):(f.mute(),h({isMuted:!0}))},clearProgressElement(){o.progress=null},setProgressElement(f){o.progress=f},setCurrentTimeElement(f){o.currentTime=f},clearCurrentTimeElement(){o.currentTime=null}}));return t.on("complex-timeline.enter",h=>{let v=x.getState(),f=h.id,S=r[f];S&&v.isPlaying&&S.play()}),t.on("complex-timeline.exit",h=>{let v=x.getState(),f=h.id,S=r[f];S&&(S.currentTime=0,S.pause())}),x.getState().setTime(n),{store:x,emitter:t}}var Ao=require("@atlas-viewer/atlas");var _e=require("react");var ho=require("@atlas-viewer/atlas"),vo=require("@iiif/parser/image-3");var K=$(require("react"),1),ie=require("react/jsx-runtime"),Ai=K.default.createContext("en"),Pi=K.default.createContext({}),Ti=K.default.createContext(null);function Ii(){return K.default.useContext(Ti)}function go(){return K.default.useContext(Ai)}function wi(){return K.default.useContext(Pi)}function po(e){return e.indexOf("-")!==-1?e.slice(0,e.indexOf("-")):e}function Mi({as:e,language:n,children:t,viewingDirection:r,...o}){let a=go();return(0,K.useMemo)(()=>po(a)===po(n),[a,n])?e?(0,ie.jsx)(e,{...o,children:t}):(0,ie.jsx)("span",{...o,children:t}):e?(0,ie.jsx)(e,{...o,lang:n,dir:r,children:t}):(0,ie.jsx)("span",{...o,lang:n,dir:r,children:t})}function Vi(e,n,t){if(n.length===0)return;if(n.length===1)return n[0];if(n.indexOf(e)!==-1)return e;let r=e.indexOf("-")!==-1?e.slice(0,e.indexOf("-")):null;if(r&&n.indexOf(r)!==-1)return r;for(let o of t)if(n.indexOf(o)!==-1)return o;return n.indexOf("none")!==-1?"none":n.indexOf("@none")!==-1?"@none":n[0]}var Ei=(e,n=[])=>{let t=go();return(0,K.useMemo)(()=>{let r=e();return Vi(t,r,[])},[t,...n])};function an(e,n,t,r){return n?t?t(e[n]||n,r||"none"):e[n]||n:""}function ki(e,n,t=`
`,r={}){let o=Ii(),a=Ei(()=>Object.keys(e||{}),[e]);return[(0,K.useMemo)(()=>{if(!e)return an(r,n,o)||"";if(typeof e=="string")return an(r,e,o);let i=a?e[a]:void 0;return i?typeof i=="string"?i:i.map(s=>an(r,s,o,a)).join(t):""},[a,n,e]),a]}function We({as:e,defaultText:n,enableDangerouslySetInnerHTML:t,children:r,separator:o,...a}){let i=wi(),[s,u]=ki(r,n,o,i);return u?(0,ie.jsx)(Mi,{...a,as:e,language:u,title:t?void 0:s,dangerouslySetInnerHTML:t?{__html:s}:void 0,children:t?void 0:s}):e?(0,ie.jsx)(e,{...a,children:s}):(0,ie.jsx)("span",{...a,title:t?void 0:s,dangerouslySetInnerHTML:t?{__html:s}:void 0,children:t?void 0:s})}var yo=require("@iiif/parser/image-3"),Mt=require("react"),de=require("react/jsx-runtime"),sn=e=>{let n=e.format||"jpg",t=e.width/(e.crop?.width||e.tiles.width),r=e.tiles.imageService.sizes||[],o=e.enableThumbnail,a=e.enableSizes,i=(0,Mt.useMemo)(()=>{let c=e.tiles.imageService.id||e.tiles.imageService["@id"];return c?.endsWith("/info.json")?c.slice(0,-1*10):c},[e.tiles.imageService.id,e.tiles.imageService["@id"]]),s=(0,Mt.useMemo)(()=>{let c=e.tiles.imageService.tiles||[];if(!c.length){let l=e.width,m=[1],p=1;for(;Math.pow(2,p)<l;)p=p*2,m.push(p);return(e.tiles.imageService.maxArea||e.tiles.imageService.maxWidth||e.tiles.imageService.maxHeight)&&(0,yo.isImageServiceLevel)(2,e.tiles.imageService)?[{width:256,height:256,scaleFactors:m}]:[]}return c},[e.tiles.imageService,e.width]),u=(0,Mt.useMemo)(()=>{let c=e.tiles.imageService;return(c?c["@context"]?Array.isArray(c["@context"])?c["@context"]:[c["@context"]]:[]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1},[e.tiles.imageService.id,e.tiles.imageService]);return(0,de.jsx)("world-object",{rotation:e.rotation,scale:t,height:e.crop?.height||e.tiles.height,width:e.crop?.width||e.tiles.width,x:e.x,y:e.y,onClick:e.onClick,children:(0,de.jsxs)("composite-image",{id:e.tiles.imageService.id,width:e.crop?.width||e.tiles.width,height:e.crop?.height||e.tiles.height,crop:e.crop,renderOptions:e.renderOptions,children:[o&&e.tiles.thumbnail?(0,de.jsx)("world-image",{priority:!0,uri:e.tiles.thumbnail.id,target:{width:e.tiles.width,height:e.tiles.height},display:{width:e.tiles.thumbnail.width,height:e.tiles.thumbnail.height},crop:e.crop}):null,a&&r.map((c,l)=>(0,de.jsx)("world-image",{uri:`${i}/full/${c.width},${u?c.height:""}/0/default.${n}`,target:{width:e.tiles.width,height:e.tiles.height},display:{width:c.width,height:c.height},crop:e.crop},l)),s.map(c=>(c.scaleFactors||[]).map(l=>(0,de.jsx)("tiled-image",{uri:e.tiles.imageService.id,display:{width:e.tiles.width,height:e.tiles.height},format:n,tile:c,scaleFactor:l,crop:e.crop,version3:u},`${e.tiles.imageService.id}-tile-${l}`)))]},e.tiles.imageService.id)},e.tiles.imageService.id)};var U=require("react/jsx-runtime");function Ni({resource:e,heading:n,note:t,extra:r}){return r?(0,U.jsx)(ho.HTMLPortal,{target:{x:0,y:0,width:r.target?.spatial.width,height:r.target?.spatial.height},backgroundColor:"#333",relative:!0,children:(0,U.jsx)("div",{style:{display:"flex",alignContent:"center",justifyContent:"center",alignItems:"center",height:"100%",width:"100%",background:"#444",color:"#BBB"},children:(0,U.jsxs)("div",{children:[(0,U.jsx)(We,{children:n||"Not authorised"}),t&&(0,U.jsx)("p",{children:(0,U.jsx)(We,{children:t})}),(0,U.jsx)("p",{children:e.id||e["@id"]||"unknown"})]})})}):null}function So({image:e,thumbnail:n,crop:t,enableSizes:r,enableThumbnail:o,renderOptions:a}){let i=Wn(),s=(0,vo.getId)(e.service),u=Fr(s),c=vt(),l=u?.service;c(e.service,e);let m=l&&u?.status==="done",p=(l?.preferredFormats||[])[0],y=n&&n.type==="fixed"&&n.id&&!n.id.includes("/full/full/")&&!n.id.includes("/max/")?n:void 0;if(m===!1)return null;if(!i){let g=e.service,d=g.width||e.width||0,x=g.height||e.height||0;return(0,U.jsx)(sn,{enableThumbnail:o,renderOptions:a,tiles:{id:g.id||g["@id"]||"unknown",height:x,width:d,imageService:g,thumbnail:y},enableSizes:r,x:0,y:0,format:p,width:e.target?.spatial.width,height:e.target?.spatial.height,crop:t})}return(0,U.jsx)(_n,{resource:e.service,errorComponent:Ni,extra:e,children:g=>{let d=g.width||e.width||0,x=g.height||e.height||0;return(0,U.jsx)(sn,{enableThumbnail:o,renderOptions:a,tiles:{id:g.id||g["@id"]||"unknown",height:x,width:d,imageService:g,thumbnail:y},format:p,enableSizes:r,x:0,y:0,width:e.target?.spatial.width,height:e.target?.spatial.height,crop:t})}},e.id)}var fe=require("react/jsx-runtime");function Ee({id:e,image:n,thumbnail:t,isStatic:r,x:o=0,y:a=0,children:i,selector:s,onClick:u,enableSizes:c}){let l=(0,_e.useMemo)(()=>{if(!(!s||s.spatial.x===0&&s.spatial.y===0))return s.spatial},[s]);return(0,fe.jsx)("world-object",{x:o+n.target.spatial.x,y:a+n.target.spatial.y,width:n.target.spatial.width,height:n.target.spatial.height,onClick:u,children:n.service?(0,fe.jsxs)(_e.Fragment,{children:[(0,fe.jsx)(So,{image:n,thumbnail:t,crop:l,enableSizes:c}),i]},"service"):(0,fe.jsxs)(_e.Fragment,{children:[(0,fe.jsx)("world-image",{onClick:u,uri:n.id,target:{x:0,y:0,width:n.target.spatial.width,height:n.target.spatial.height},display:n.width&&n.height?{width:n.width,height:n.height}:void 0,crop:l}),i]},"no-service")},e+(n.service?"server":"no-service"))}var un=require("zustand");var cn=require("react"),Li=require("zustand"),bo=require("react/jsx-runtime"),xo=(0,cn.createContext)(null);xo.displayName="ComplexTimeline";function Co({children:e,store:n}){return(0,bo.jsx)(xo.Provider,{value:n,children:e})}var Ro=require("@atlas-viewer/atlas");var J=require("react/jsx-runtime");function Vt({strategy:e,onClickPaintingAnnotation:n}){return(0,J.jsx)(J.Fragment,{children:e.items.map((t,r)=>(0,J.jsx)(J.Fragment,{children:(0,J.jsx)(Ro.HTMLPortal,{onClick:n?o=>{o.stopPropagation(),n(t.annotationId,t,o)}:void 0,target:t.target?.spatial||void 0,children:(0,J.jsx)("div",{"data-textual-content":!0,children:(0,J.jsx)(We,{enableDangerouslySetInnerHTML:!0,children:t.text})})},r)}))})}var ee=require("react/jsx-runtime");function Po({strategy:e,children:n}){let{store:t}=(0,Et.useMemo)(()=>fo({complexTimeline:e}),[e]),r=(0,un.useStore)(t,i=>i.isReady),o=(0,un.useStore)(t,i=>i.visibleElements);function a(i){return s=>{s&&t.getState().setElement(i,s)}}return(0,Et.useLayoutEffect)(()=>{if(r){let{startClock:i,stopClock:s}=t.getState();return i(),()=>{s()}}},[e,r]),L("portal","custom-controls",Co,{store:t,children:n},[r]),(0,ee.jsxs)(ee.Fragment,{children:[e.items.map(i=>i.type!=="Image"||!o[i.annotationId]?null:(0,ee.jsx)(Ee,{image:i,id:i.annotationId},i.id)),e.items.map((i,s)=>i.type!=="Text"||!o[i.annotationId]?null:(0,ee.jsx)(Vt,{strategy:{type:"textual-content",items:[i]}},s)),e.items.map((i,s)=>i.type!=="Video"||!i.target.spatial?null:(0,ee.jsx)(Ao.HTMLPortal,{target:i.target.spatial,children:(0,ee.jsx)("video",{ref:a(i.annotationId),src:i.url,style:{height:"100%",width:"100%",opacity:o[i.annotationId]?1:0}})},s))]})}var Io=require("react/jsx-runtime");function To(){let{strategy:e}=M(),{renderComplexTimelineControls:n}=H();return e.type!=="complex-timeline"?null:(0,Io.jsx)(Po,{strategy:e,children:n?n(e):null})}var ke=require("react/jsx-runtime");function wo({onClickPaintingAnnotation:e,children:n}){let{strategy:t}=M(),{renderViewerControls:r,viewControlsDeps:o}=H(),a=ct(),i=A();return L(a&&t.type==="textual-content"&&r?"overlay":"none",`canvas-portal-controls-${i?.id}`,ue.Provider,r?{value:a||null,children:r(t)}:{},[i,a,t,...o||[]]),t.type!=="textual-content"?null:(0,ke.jsxs)(ke.Fragment,{children:[(0,ke.jsx)(Vt,{strategy:t,onClickPaintingAnnotation:e}),n]})}var ae=require("react");var Mo=require("react"),Vo=(e,n=[])=>{let t=P();(0,Mo.useEffect)(()=>{e(t)},[t,...n])};var kt=$(require("react"),1),Eo=require("@iiif/helpers/image-service"),zi=kt.default.createContext(new Eo.ImageServiceLoader);function ko(){return(0,kt.useContext)(zi)}var No=require("@iiif/helpers/thumbnail");function Ne(e,n,{canvasId:t,manifestId:r}={}){let o=P(),a=ko(),i=(0,ae.useMemo)(()=>(0,No.createThumbnailHelper)(o,{imageServiceLoader:a}),[o,a]),[s,u]=(0,ae.useState)(),c=k(r?{id:r}:void 0),l=A(t?{id:t}:void 0),m=l||c,p=(0,ae.useRef)(!1);if((0,ae.useEffect)(()=>(p.current=!1,()=>{p.current=!0}),[]),!m)throw new Error("Must be called under a manifest or canvas context.");return Vo(y=>{i.getBestThumbnailAtSize(m,e,n).then(g=>{g.best&&!p.current&&u(g.best)})},[m]),s}var Le=require("react/jsx-runtime");function Lo({isStatic:e=!1,enableSizes:n=!1,onClickPaintingAnnotation:t,children:r}){let{strategy:o}=M(),{renderViewerControls:a,viewControlsDeps:i}=H(),s=A(),u=ct(),c=Ne({maxWidth:256,maxHeight:256});return L(u&&o.type==="images"&&a?"overlay":"none",`canvas-portal-controls-${s?.id}`,ue.Provider,a?{value:u||null,children:a(o)}:{},[s,u,o,...i||[]]),o.type!=="images"?null:(0,Le.jsxs)(Le.Fragment,{children:[o.images.map((l,m)=>(0,Le.jsx)(Ee,{isStatic:e,image:l,id:l.id,thumbnail:m===0?c:void 0,selector:l.selector,enableSizes:n,onClick:t?p=>{t(l.annotationId,l,p)}:void 0},l.id+m)),r]})}var se=require("react/jsx-runtime");function ln({model:e}){return(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)("style",{children:`
            .model-container {
              position: absolute;
              top: 0;
              bottom: 0;
              left: 0;
              right: 0;
              background: #000;
              z-index: 13;
              display: flex;
              justify-content: center;
              pointer-events: visible;
            }
          `}),(0,se.jsx)("div",{className:"model-container",children:(0,se.jsx)("model-viewer",{"interaction-prompt":"none",style:{width:"100%",height:"100%"},"camera-controls":"","ar-status":"not-presenting",src:e.id})})]})}function Nt({model:e,name:n}){return L("overlay",`model-${n}`,ln,{model:e},[e]),null}var Oo=require("react/jsx-runtime");function zo(){let{strategy:e}=M();return e.type!=="3d-model"?null:(0,Oo.jsx)(Nt,{model:e.model})}var pe=require("react/jsx-runtime");function Do({children:e}){let{strategy:n}=M(),[t]=mr();return n.type!=="images"?null:(0,pe.jsxs)(pe.Fragment,{children:[t?(0,pe.jsx)(Ue,{page:t}):null,n.annotations&&n.annotations.pages?n.annotations.pages.map(r=>(0,pe.jsx)(Ue,{page:r},r.id)):null,e]})}var Ye=require("react"),Lt=require("react/jsx-runtime"),Oi=(0,Ye.createContext)(null),Di=(0,Ye.createContext)(null),Fi=(0,Ye.createContext)(null);function zt({actions:e,state:n,children:t,currentTime:r,progress:o,element:a}){return(0,Lt.jsx)(Fi.Provider,{value:{currentTime:r,progress:o,element:a},children:(0,Lt.jsx)(Di.Provider,{value:e,children:(0,Lt.jsx)(Oi.Provider,{value:n,children:t})})})}var Fo=require("react");var Ho=require("@iiif/helpers");function Ot(){let e=k(),n=A();return(0,Fo.useMemo)(()=>{if(!e||!n||!e.start)return null;let t=(0,Ho.expandTarget)(e.start);return!t||t.source.id!==n.id||!t||!t.selector||t.selector.type!=="TemporalSelector"?null:t.selector.temporal},[e,n])}var Ft=require("react/jsx-runtime");function mn({media:e,startTime:n,children:t}){let[{element:r,currentTime:o,progress:a},i,s]=Ve({duration:e.duration}),u=n?`${e.url}#t=${n}`:e.url;return(0,Ft.jsxs)(zt,{state:i,actions:s,currentTime:o,progress:a,element:r,children:[(0,Ft.jsx)("audio",{ref:r,src:u}),t]},e.url)}function Dt({media:e,mediaControlsDeps:n,audioCopmonent:t=mn,children:r}){let o=Ot();return L("portal","audio",t,{media:e,startTime:o?o.startTime:null,children:r},[e,o,...n||[]]),null}var dn=require("react/jsx-runtime");function ze({x:e=0,y:n=0}){let t=A(),r=Ne({maxWidth:256,maxHeight:256});return!t||!r||r.type!=="fixed"?null:(0,dn.jsx)("world-object",{height:t.height,width:t.width,x:e,y:n,children:(0,dn.jsx)("world-image",{uri:r.id,target:{x:0,y:0,width:t.width,height:t.height},display:r.width&&r.height?{width:r.width,height:r.height}:void 0,crop:void 0})})}var ge=require("react/jsx-runtime");function Bo({as:e}){let{strategy:n}=M(),{renderMediaControls:t,mediaControlsDeps:r}=H();return n.type!=="media"||n.media.type!=="Sound"?null:(0,ge.jsx)(ge.Fragment,{children:(0,ge.jsxs)(Dt,{media:n.media,mediaControlsDeps:r,audioCopmonent:e,children:[(0,ge.jsx)(ze,{}),t?t(n):null]},n.media.url)})}var te=require("react/jsx-runtime");function $o(){let{strategy:e}=M(),{renderViewerControls:n,viewControlsDeps:t}=H(),r=A(),o=r?.accompanyingCanvas,a=r?.placeholderCanvas;return(0,te.jsxs)(te.Fragment,{children:[e.type==="media"&&e.media.type==="Sound"&&o?(0,te.jsx)(G,{canvas:o.id,children:(0,te.jsx)(ye,{renderViewerControls:n,viewControlsDeps:t})}):null,e.type==="media"&&e.media.type==="Sound"&&a&&!o?(0,te.jsx)(G,{canvas:a.id,children:(0,te.jsx)(ye,{renderViewerControls:n,viewControlsDeps:t})}):null]})}var je=require("react/jsx-runtime");function fn({element:e,media:n,startTime:t,playPause:r,poster:o}){let a="div",i=t?`${n.url}#t=${t}`:n.url;return(0,je.jsxs)(a,{className:"video-container",part:"video-container",onClick:r,children:[(0,je.jsx)("style",{children:`
            .video-container {
              position: absolute;
              top: 0;
              bottom: 0;
              left: 0;
              right: 0;
              background: #000;
              z-index: 13;
              display: flex;
              justify-content: center;
              pointer-events: visible;
            }
          `}),(0,je.jsx)("video",{poster:o,ref:e,src:i,style:{width:"100%",objectFit:"contain"}})]})}function Ht({media:e,mediaControlsDeps:n,children:t,videoComponent:r=fn,captions:o}){let a=A(),i=Ot(),s=a&&a.placeholderCanvas&&a.placeholderCanvas.id||void 0,u=Ne({},!1,{canvasId:s}),[{element:c,currentTime:l,progress:m},p,y]=Ve({duration:e.duration});return L("overlay","video-element",r,{element:c,media:e,playPause:y.playPause,poster:u?.id,canvas:a,startTime:i?i.startTime:null,captions:o},[u]),L("portal","custom-controls",zt,{state:p,actions:y,currentTime:l,progress:m,element:c,children:t},[l,p,e,...n||[]]),null}var Bt=require("react/jsx-runtime");function Uo({as:e}){let{strategy:n}=M(),{renderMediaControls:t,mediaControlsDeps:r}=H();return n.type!=="media"||n.media.type!=="Video"?null:(0,Bt.jsxs)(Ht,{captions:n.captions,media:n.media,mediaControlsDeps:r,videoComponent:e,children:[(0,Bt.jsx)(ze,{}),t?t(n):null]},n.media.url)}var qo=require("react"),Ke=require("react/jsx-runtime");function Hi({element:e,media:n,playPause:t}){let r=(0,qo.useRef)(null);return n.youTubeId?(0,Ke.jsxs)("div",{className:"video-container",part:"video-container",onClick:t,children:[(0,Ke.jsx)("style",{children:`
            .video-container {
              position: absolute;
              top: 0;
              bottom: 0;
              left: 0;
              right: 0;
              background: #000;
              z-index: 13;
              display: flex;
              justify-content: center;
              pointer-events: visible;
            }
            .video-yt {
              border: none;
              width: 100%;
              object-fit: contain;
            }
          `}),(0,Ke.jsx)("iframe",{className:"video-yt",ref:r,src:`https://www.youtube.com/embed/${n.youTubeId}?enablejsapi=1&origin=${window.location.host}`,referrerPolicy:"no-referrer",sandbox:"allow-scripts allow-same-origin allow-presentation"})]}):null}function Wo({media:e,mediaControlsDeps:n,children:t}){let[{element:r,currentTime:o,progress:a},i,s]=Ve({duration:e.duration});return L("overlay","video-element",Hi,{element:r,media:e,playPause:s.playPause}),null}var $t=require("react/jsx-runtime");function _o(){let{strategy:e}=M(),{renderMediaControls:n,mediaControlsDeps:t}=H();return e.type!=="media"||e.media.type!=="VideoYouTube"?null:(0,$t.jsxs)(Wo,{media:e.media,mediaControlsDeps:t,children:[(0,$t.jsx)(ze,{}),n?n(e):null]})}var B=require("react/jsx-runtime");function ye({x:e,y:n,onChoiceChange:t,registerActions:r,defaultChoices:o,isStatic:a,renderViewerControls:i,renderMediaControls:s,renderComplexTimelineControls:u,complexTimelineControlsDeps:c,viewControlsDeps:l,mediaControlsDeps:m,strategies:p,throwOnUnknown:y,backgroundStyle:g,alwaysShowBackground:d,keepCanvasScale:x=!1,enableSizes:h=!1,enableYouTube:v=!0,onClickPaintingAnnotation:f,components:S={},children:R}){return(0,B.jsxs)(to,{throwOnUnknown:y,onChoiceChange:t,registerActions:r,strategies:p,defaultChoices:o,mediaControlsDeps:m,renderMediaControls:s,renderViewerControls:i,renderComplexTimelineControls:u,complexTimelineControlsDeps:c,viewControlsDeps:l,children:[(0,B.jsxs)(ro,{keepCanvasScale:x,x:e,y:n,children:[(0,B.jsx)(ao,{alwaysShowBackground:d,backgroundStyle:g}),(0,B.jsx)(To,{}),(0,B.jsx)(wo,{}),(0,B.jsx)(Lo,{isStatic:a,enableSizes:h,onClickPaintingAnnotation:f}),(0,B.jsx)(Do,{}),(0,B.jsx)(zo,{}),(0,B.jsx)(Bo,{as:S.Audio}),(0,B.jsx)(Uo,{as:S.Video}),v?(0,B.jsx)(_o,{}):null,R]}),(0,B.jsx)($o,{})]})}var pn=require("react/jsx-runtime");function Yo(e){let n=A();return!n||!n.placeholderCanvas?null:(0,pn.jsx)(G,{canvas:n.placeholderCanvas.id,children:(0,pn.jsx)(ye,{renderViewerControls:e.renderViewerControls})})}var O=require("react/jsx-runtime"),Bi=(0,he.forwardRef)(function(n,t){let r=k(),o=nt(),a=Xn(),{ViewerControls:i,MediaControls:s,ComplexTimelineControls:u}=n.components||{};if((0,he.useImperativeHandle)(t,()=>a,[a]),!r)return(0,O.jsx)("div",{});let c=0,l=r.viewingDirection==="top-to-bottom",m=r.viewingDirection==="bottom-to-top",p=r.viewingDirection==="left-to-right",y=r.viewingDirection==="right-to-left",d=r.behavior.includes("continuous")?0:n.spacing||0,x=m||y,h=(0,he.useMemo)(()=>x?[...o].reverse():o,[o,x]);return(0,O.jsxs)(O.Fragment,{children:[n.header,(0,O.jsx)(N.Viewer,{height:n.height,mode:n.mode,renderPreset:n.renderPreset,runtimeOptions:n.runtimeOptions,children:h.map((v,f)=>{let S=0,R=0;return l?(S=c,c+=v.width+d):(R=c,c+=v.height+d),(0,O.jsx)(G,{canvas:v.id,children:(0,O.jsx)(N.RenderCanvas,{strategies:["3d-model","media","images","empty","textual-content","complex-timeline"],renderViewerControls:f===0&&i?()=>(0,O.jsx)(i,{}):void 0,renderMediaControls:f===0&&s?()=>(0,O.jsx)(s,{}):void 0,renderComplexTimelineControls:f===0&&u?()=>(0,O.jsx)(u,{}):void 0,x:S,y:R,...n.canvasProps||{},children:n.annotations},v.id)},v.id)})},n.reuseAtlas?"":a.currentSequenceIndex),n.children]})}),N=(0,he.forwardRef)(function({children:n,height:t,annotations:r,canvasProps:o,spacing:a,header:i,components:s,mode:u,reuseAtlas:c,renderPreset:l,runtimeOptions:m,...p},y){let g=xe();return(0,O.jsx)(Se,{vault:g,children:(0,O.jsx)(Zn,{...p,children:(0,O.jsx)(Bi,{ref:y,height:t,components:s,spacing:a,canvasProps:o,annotations:r,header:i,mode:u,reuseAtlas:c,renderPreset:l,runtimeOptions:m,children:n})})})});N.RenderImage=Ee;N.RenderCanvas=ye;N.RenderAnnotationPage=Ue;N.RenderAnnotation=ft;N.Viewer=vr;N.CanvasBackground=wt;N.Audio=Dt;N.Video=Ht;N.Model=Nt;N.AudioHTML=mn;N.VideoHTML=fn;N.ModelHTML=ln;N.PlaceholderCanvas=Yo;
