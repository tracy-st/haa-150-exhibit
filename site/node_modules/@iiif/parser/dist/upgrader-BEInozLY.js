import{_defineProperty as e,ensureArray as t,removeUndefinedProperties as n}from"./remove-undefined-properties-DKmVdOaS.js";import{level0Support as r,level2Support as i}from"./profiles-DU_UcLCg.js";const a=[`sc:Collection`,`sc:Manifest`,`sc:Canvas`,`sc:AnnotationList`,`oa:Annotation`,`sc:Range`,`sc:Layer`,`sc:Sequence`,`oa:Choice`,`Service`,`ContentResource`];function o(e){if(e==null)throw Error(`Null or undefined is not a valid entity.`);if(Array.isArray(e))throw Error(`Array is not a valid entity`);if(typeof e!=`object`)throw Error(`${typeof e} is not a valid entity`);if(typeof e[`@type`]==`string`){let t=a.indexOf(e[`@type`]);if(t!==-1)return a[t]}if(e.profile)return`Service`;if(e.format||e[`@type`])return`ContentResource`;throw Error(`Resource type is not known`)}var s=class t{constructor(t,n={}){e(this,`traversals`,void 0),e(this,`options`,void 0),this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...t},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...n}}static all(e){return new t({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){let t=[...(e.manifests||[]).map(e=>typeof e==`string`?{"@id":e,"@type":`sc:Manifest`}:e),...(e.collections||[]).map(e=>typeof e==`string`?{"@id":e,"@type":`sc:Collection`}:e),...e.members||[]],n=[],r=t.filter(e=>n.includes(e[`@id`])?!1:(n.push(e[`@id`]),!0));delete e.collections,delete e.manifests,e.members=r}return e.manifests&&=e.manifests.map(e=>this.traverseManifest(typeof e==`string`?{"@id":e,"@type":`sc:Manifest`}:e)),e.collections&&=e.collections.map(e=>this.traverseCollection(typeof e==`string`?{"@id":e,"@type":`sc:Collection`}:e)),e.members&&=e.members.map(e=>typeof e==`string`?e:e[`@type`]===`sc:Collection`?this.traverseCollection(e):e[`@type`]===`sc:Manifest`?this.traverseManifest(e):this.traverseUnknown(e)),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&=e.sequences.map(e=>this.traverseSequence(e)),e.structures&&=e.structures.map(e=>this.traverseRange(e)),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&=e.canvases.map(e=>this.traverseCanvas(e)),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&=e.images.map(e=>this.traverseAnnotation(e)),e.otherContent&&=e.otherContent.map(e=>this.traverseAnnotationList(e)),e}traverseRange(e){return e[`@type`]!==`sc:Range`&&(e[`@type`]=`sc:Range`),this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){let t=[...(e.ranges||[]).map(e=>typeof e==`string`?{"@id":e,"@type":`sc:Range`}:e),...(e.canvases||[]).map(e=>typeof e==`string`?{"@id":e,"@type":`sc:Canvas`}:e),...e.members||[]];delete e.ranges,delete e.canvases,e.members=t.length?t.map(e=>this.traverseUnknown(e)):void 0}return e}traverseAnnotationList(e){let t=typeof e==`string`?{"@id":e,"@type":`sc:AnnotationList`}:e;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(t)),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&=e.resources.map(e=>this.traverseAnnotation(e)),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(Array.isArray(e.resource)?e.resource=e.resource.map(e=>this.traverseContentResource(e)):e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&=e.otherContent.map(e=>this.traverseAnnotationList(e)),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&e.default!==`rdf:nil`&&(e.default=this.traverseContentResource(e.default)),e.item&&e.item!==`rdf:nil`&&(e.item=e.item.map(e=>this.traverseContentResource(e))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return e[`@type`]===`oa:Choice`?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e[`@type`]||typeof e==`string`)return e;switch(o(e)){case`sc:Collection`:return this.traverseCollection(e);case`sc:Manifest`:return this.traverseManifest(e);case`sc:Canvas`:return this.traverseCanvas(e);case`sc:Sequence`:return this.traverseSequence(e);case`sc:Range`:return this.traverseRange(e);case`oa:Annotation`:return this.traverseAnnotation(e);case`sc:AnnotationList`:return this.traverseAnnotationList(e);case`sc:Layer`:return this.traverseLayer(e);case`Service`:return this.traverseService(e);case`oa:Choice`:return this.traverseChoice(e);case`ContentResource`:return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){let t=Array.isArray(e),n=Array.isArray(e)?e:[e],r=[];for(let e of n)typeof e==`string`?r.push(this.traverseContentResource({"@id":e,"@type":`dctypes:Image`})):r.push(this.traverseContentResource(e));return!t&&!this.options.convertPropsToArray?r[0]:r}traverseDescriptive(e){return e.thumbnail&&=this.traverseImageResource(e.thumbnail),e.logo&&=this.traverseImageResource(e.logo),e}traverseOneOrMoreServices(e){let t=Array.isArray(e),n=Array.isArray(e)?e:[e],r=[];for(let e of n)r.push(this.traverseService(e));return!t&&!this.options.convertPropsToArray?r[0]:r}traverseLinking(e){return e.related&&=this.traverseOneOrManyType(e.related,this.traversals.contentResource),e.rendering&&=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource),e.service&&=this.traverseOneOrMoreServices(e.service),e.seeAlso&&=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource),e.within&&(typeof e.within==`string`||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&(typeof e.startCanvas==`string`?e.startCanvas=this.traverseType({"@id":e.startCanvas,"@type":`sc:Canvas`},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&(typeof e.contentLayer==`string`?e.contentLayer=this.traverseLayer({"@id":e.contentLayer,"@type":`sc:Layer`}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,t){if(!Array.isArray(e))if(this.options.convertPropsToArray)e=[e];else return this.traverseType(e,t);return e.map(e=>this.traverseType(e,t))}traverseType(e,t){return t.reduce((e,t)=>{let n=t(e);return n===void 0&&!this.options.allowUndefinedReturn?e:n},e)}};const c=[`http://iiif.io/api/image/2/level1`,`http://iiif.io/api/image/2/level2`,`http://library.stanford.edu/iiif/image-api/compliance.html#level1`,`http://library.stanford.edu/iiif/image-api/compliance.html#level2`,`http://library.stanford.edu/iiif/image-api/conformance.html#level1`,`http://library.stanford.edu/iiif/image-api/conformance.html#level2`,`http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1`,`http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2`,`http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1`,`http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2`,`http://iiif.io/api/image/1/level1.json`,`http://iiif.io/api/image/1/profiles/level1.json`,`http://iiif.io/api/image/1/level2.json`,`http://iiif.io/api/image/1/profiles/level2.json`,`http://iiif.io/api/image/2/level1.json`,`http://iiif.io/api/image/2/profiles/level1.json`,`http://iiif.io/api/image/2/level2.json`,`http://iiif.io/api/image/2/profiles/level2.json`,`level1`,`level2`],l={attributionLabel:`Attribution`,lang:`none`,providerId:`http://example.org/provider`,providerName:``};function u(e){if(typeof e==`string`)return[e];if(!e)return[];let t=Array.isArray(e)?e:[e],n=[];for(let e of t){if(typeof e==`string`){n.push(e);continue}n.push({"@language":e[`@language`]||e.language,"@value":e[`@value`]||e.value})}return n}function d(e,t=`none`){if(!e)return{none:[``]};let n=u(e),r={};for(let e of n){if(typeof e==`string`){r[t]=r[t]?r[t]:[],r[t].push(e||``);continue}if(!e[`@language`]){r[t]=r[t]?r[t]:[],r[t].push(e[`@value`]||``);continue}let n=e[`@language`];r[n]=r[n]?r[n]:[],r[n].push(e[`@value`]||``)}return Object.keys(r).length===0?{none:[``]}:r}function f(e){if(Array.isArray(e))return f(e.find(e=>typeof e==`string`));if(i.indexOf(e)!==-1)return`level2`;if(c.indexOf(e)!==-1)return`level1`;if(r.indexOf(e)!==-1)return`level0`;if(typeof e==`string`)return e}function p(e){let t=Array.isArray(e)?e:[e];for(let e of t)switch(e){case`http://iiif.io/api/image/2/context.json`:case`http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2`:return`ImageService2`;case`http://iiif.io/api/image/1/context.json`:case`http://library.stanford.edu/iiif/image-api/1.1/context.json`:return`ImageService1`;case`http://iiif.io/api/annex/openannotation/context.json`:return`ImageApiSelector`}}function m(e){switch(e){case`http://iiif.io/api/image/2/level0.json`:case`http://iiif.io/api/image/2/level1.json`:case`http://iiif.io/api/image/2/level2.json`:return`ImageService2`;case`http://iiif.io/api/auth/1/kiosk`:case`http://iiif.io/api/auth/1/login`:case`http://iiif.io/api/auth/1/clickthrough`:case`http://iiif.io/api/auth/1/external`:case`http://iiif.io/api/auth/0/kiosk`:case`http://iiif.io/api/auth/0/login`:case`http://iiif.io/api/auth/0/clickthrough`:case`http://iiif.io/api/auth/0/external`:return`AuthCookieService1`;case`http://iiif.io/api/auth/1/token`:case`http://iiif.io/api/auth/0/token`:return`AuthTokenService1`;case`http://iiif.io/api/auth/1/logout`:case`http://iiif.io/api/auth/0/logout`:return`AuthLogoutService1`;case`http://iiif.io/api/search/1/search`:case`http://iiif.io/api/search/0/search`:return`SearchService1`;case`http://iiif.io/api/search/1/autocomplete`:case`http://iiif.io/api/search/0/autocomplete`:return`AutoCompleteService1`}}function h(e){for(let t of[`sc`,`oa`,`dcterms`,`dctypes`,`iiif`])if(e.startsWith(`${t}:`))return e.slice(t.length+1);return e}const g=[`Collection`,`Manifest`,`Annotation`,`AnnotationPage`,`Range`,`Service`];function _(e){let t=e[`@id`]||e.id,n=e[`@type`]||e.type,r=e.profile||void 0,i=e[`@context`]||void 0;if(r){let e=m(r);if(e)return e}if(i){let e=p(i);if(e)return e}if(n){if(Array.isArray(n)){if(n.indexOf(`oa:CssStylesheet`)!==-1)return`CssStylesheet`;if(n.indexOf(`cnt:ContentAsText`)!==-1)return`TextualBody`;n=n[0]}for(let e of[`sc`,`oa`,`dcterms`,`dctypes`,`iiif`])if(n.startsWith(`${e}:`)){n=n.slice(e.length+1);break}switch(n){case`Layer`:return`AnnotationCollection`;case`AnnotationList`:return`AnnotationPage`;case`cnt:ContentAsText`:return`TextualBody`}}if(n&&g.indexOf(n)!==-1)return n;if(e.format){if(e.format.startsWith(`image/`))return`Image`;if(e.format.startsWith(`text/`)||e.format===`application/pdf`)return`Text`;if(e.format.startsWith(`application/`))return`Dataset`}return t&&(t.endsWith(`.jpg`)||t.endsWith(`.png`)||t.endsWith(`.jpeg`))?`Image`:n||`unknown`}const v=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function y(e){let t=e.match(v);return t?t[0]:e}function b(e,t=`Rights/License`,n=`none`){let r=null,i=[],a=Array.isArray(e)?e:[e];for(let e of a){let a=e?y(e):void 0;if(a&&(a.indexOf(`creativecommons.org`)!==-1||a.indexOf(`rightsstatements.org`)!==-1)){r=a.startsWith(`https://`)?`http://${a.slice(8)}`:a;continue}a&&i.push({label:{[n]:[t]},value:{[n]:[a]}})}return[r,i]}const x=[`http://iiif.io/api/presentation/2/context.json`,`http://iiif.io/api/image/2/context.json`,`http://iiif.io/api/image/1/context.json`,`http://library.stanford.edu/iiif/image-api/1.1/context.json`,`http://iiif.io/api/search/1/context.json`,`http://iiif.io/api/search/0/context.json`,`http://iiif.io/api/auth/1/context.json`,`http://iiif.io/api/auth/0/context.json`,`http://iiif.io/api/annex/openannotation/context.json`];function S(e){if(e){let t=Array.isArray(e)?e:[e],n=[];for(let e of t){if(e===`http://iiif.io/api/presentation/2/context.json`&&n.push(`http://iiif.io/api/presentation/3/context.json`),x.indexOf(e)!==-1)continue;n.push(e)}if(t.length)return n.length===1?n[0]:n}}function C(e){return e?e.map(e=>({label:d(e.label),value:d(e.value)})):[]}let w=0;function T(e,t){let n=encodeURI(e.id||e[`@id`]||``).trim();return n&&t?`${n}/${t}`:n||(w++,`http://example.org/${e[`@type`]}${t?`/${t}`:``}/${w}`)}function E(e){let t=[...e.behavior||[]];e.viewingHint&&t.push(e.viewingHint);let n;return Array.isArray(e.motivation)?n=e.motivation.map(h):e.motivation&&(n=h(e.motivation)),{"@context":e[`@context`]?S(e[`@context`]):void 0,id:(e[`@id`]||T(e)).trim(),type:_(e),behavior:t.length?t:void 0,height:e.height?e.height:void 0,width:e.width?e.width:void 0,motivation:n,viewingDirection:e.viewingDirection,profile:e.profile,format:e.format?e.format:void 0,duration:void 0,timeMode:void 0}}function D(e){let[t,n]=b(e.license),r=[...e.metadata?C(e.metadata):[],...n];return{rights:t,metadata:r.length?r:void 0,label:e.label?d(e.label):void 0,requiredStatement:e.attribution?{label:d(l.attributionLabel),value:d(e.attribution)}:void 0,navDate:e.navDate,summary:e.description?d(e.description):void 0,thumbnail:O(e.thumbnail)}}function O(e){if(e){let t=Array.isArray(e)?e:[e];return t.map(e=>typeof e==`string`?{id:e,type:`Image`}:(e.type===`unknown`&&(e.type=`Image`),e))}return e}function k(e){if(!e.within)return;let t=Array.isArray(e.within)?e.within:[e.within],n=[];for(let r of t)if(typeof r==`string`){if(r)switch(e[`@type`]){case`sc:Manifest`:n.push({id:r,type:`Collection`});break}}else r[`@id`]&&n.push({id:r[`@id`],type:_(r)});return n.length?n:void 0}function A(e){let n=e.related?Array.isArray(e.related)?e.related:[e.related]:[],r=e.contentLayer;return{provider:e.logo||n.length?[{id:l.providerId,type:`Agent`,homepage:n.length?[n[0]]:void 0,logo:e.logo?Array.isArray(e.logo)?e.logo:[e.logo]:void 0,label:d(l.providerName)}]:void 0,partOf:k(e),rendering:e.rendering,seeAlso:e.seeAlso,start:e.startCanvas,service:e.service?t(e.service):void 0,supplementary:r?[r]:void 0}}function j(e){return{chars:e.chars,format:e.format?e.format:void 0,language:e.language}}function M(e,t){return e?typeof e==`string`?{id:e,type:t}:typeof e?.[`@id`]==`string`?{id:e[`@id`],type:t}:typeof e.id==`string`?{id:e.id,type:t}:null:null}function N(e){let t={};if(e.first){let n=M(e.first,`Collection`);n&&(t.first=n)}if((e.total||e.total===0)&&(t.total=e.total),e.prev){let n=M(e.prev,`Collection`);n&&(t.prev=n)}if(e.next){let n=M(e.next,`Collection`);n&&(t.next=n)}return t}function P(e){let t=[];for(let n of e){let e={...n};e.items&&e.items.length===0&&delete e.items,t.push(e)}return t}function F(e){return n({...E(e),...D(e),...A(e),...N(e),items:P(e.members)})}function I(e){let t=[],r=[],i,a;for(let n of e.sequences||[])n.canvases.length&&t.push(...n.canvases),n.behavior&&r.push(...n.behavior),n.viewingDirection&&(a=n.viewingDirection),n.startCanvas&&(i=n.startCanvas);let o=E(e);return r.length&&(o.behavior?o.behavior.push(...r):o.behavior=r),n({...o,...D(e),...A(e),viewingDirection:a,start:i,items:t,structures:L(e.structures)})}function L(e){if(!e)return e;let t=new Map;for(let n of e)t.set(n.id,n);let n=[];for(let r of e)if(r.items){let e=r.items.map(e=>typeof e==`string`?(n.push(e),t.get(e)||e):e&&e.id?(n.push(e.id),t.get(e.id)||e):e);r.items=e}return e.filter(e=>n.indexOf(e.id)===-1)}function R(e){return n({...E(e),...D(e),...A(e),annotations:e.otherContent&&e.otherContent.length?e.otherContent:void 0,items:e.images&&e.images.length?[{id:T(e,`annotation-page`),type:`AnnotationPage`,items:e.images}]:void 0})}function z(e){return n({...E(e),...D(e),...A(e),items:e.resources&&e.resources.length?e.resources:void 0})}function B(e){return!e.canvases||e.canvases.length===0?{canvases:[],behavior:[]}:{canvases:e.canvases,behavior:e.viewingHint?[e.viewingHint]:[],viewingDirection:e.viewingDirection,startCanvas:e.startCanvas}}function V(e){function t(e){if(Array.isArray(e)){if(e.length>1)return{type:`List`,items:e.map(t)};e=e[0]}if(typeof e==`string`)return encodeURI(e).trim();if(`@type`in e){let t;if(typeof e.full==`string`)t=e.full;else if(e.full[`@type`]===`dctypes:Image`)t={id:e.full[`@id`],type:`Image`};else if(e.full[`@type`]===`sc:Canvas`)t={id:e.full[`@id`],type:`Canvas`};else throw Error(`Unsupported source type on annotation: ${e.full[`@type`]}`);return{type:`SpecificResource`,source:t,selector:X(e.selector)}}else return encodeURI(e[`@id`]).trim()}return n({...E(e),...D(e),...A(e),target:t(e.on),body:Array.isArray(e.resource)?e.resource.map(H):H(e.resource)})}function H(e){return e.type===`Choice`?e:U(e)}function U(e){let t=e;return n({...E(t),...D(t),...A(t),...j(t)})}function W(e){let t=[];return e.default&&e.default!==`rdf:nil`&&t.push(e.default),e.item&&e.item!==`rdf:nil`&&t.push(...e.item),n({...E(e),...D(e),items:t})}function G(e){return n({...E(e),...D(e),...A(e),items:e.members})}function K(e){let{"@id":t,"@type":r,"@context":i,profile:a,...o}=e,s={};return t&&(s[`@id`]=t),s[`@type`]=_(e),s[`@type`]===`unknown`&&(i&&i.length&&(s[`@context`]=i),s[`@type`]=`Service`),a&&(s.profile=f(a)),n({...s,...o})}function q(e){return n({...E(e),...D(e),...A(e)})}const J=new s({collection:[F],manifest:[I],canvas:[R],annotationList:[z],sequence:[B],annotation:[V],contentResource:[U],choice:[W],range:[G],service:[K],layer:[q]});function Y(e){return e&&e[`@context`]&&(e[`@context`]===`http://iiif.io/api/presentation/2/context.json`||e[`@context`].indexOf(`http://iiif.io/api/presentation/2/context.json`)!==-1||e[`@context`]===`http://www.shared-canvas.org/ns/context.json`)||e[`@context`]===`http://iiif.io/api/image/2/context.json`||e[`@id`]&&e[`@type`]===`sc:Collection`||e[`@id`]&&e[`@type`]===`sc:Manifest`?(e[`@context`]||=`http://iiif.io/api/presentation/2/context.json`,J.traverseUnknown(e)):e}function X(e){let t=(Array.isArray(e[`@type`])&&e[`@type`].includes(`oa:SvgSelector`)||e[`@type`]==`oa:SvgSelector`)&&(`chars`in e||`value`in e);if(t)return{type:`SvgSelector`,value:`chars`in e?e.chars:e.value};if(e[`@type`]===`oa:FragmentSelector`)return{type:`FragmentSelector`,value:e.value};if(e[`@type`]===`oa:Choice`)return[X(e.default),...(Array.isArray(e.item)?e.item:[e.item]).map(X)];if(e[`@type`]==`iiif:ImageApiSelector`)return{type:`ImageApiSelector`,region:`region`in e?e.region:void 0,rotation:`rotation`in e?e.rotation:void 0};throw Error(`Unsupported selector type: ${e[`@type`]}`)}export{s as Traverse,d as convertLanguageMapping,Y as convertPresentation2,f as getProfile,p as getTypeFromContext,o as identifyResource,J as presentation2to3,a as types};
//# sourceMappingURL=upgrader-BEInozLY.js.map