{"version":3,"file":"presentation-3-DKf1Nh0x.js","names":["reference: any","_typeHint?: T","object: any","resource: any","framing: any","newEntity: any","state: CompatibleStore","urlOrResource: any","parent?: any","fullEntity: any","t: any","emptyAnnotation: AnnotationNormalized","emptyAnnotationPage: AnnotationPageNormalized","emptyCanvas: CanvasNormalized","emptyCollection: CollectionNormalized","emptyManifest: ManifestNormalized","emptyRange: RangeNormalized","emptyAgent: ResourceProviderNormalized","emptyService: _ServiceNormalized","target: W3CAnnotationTarget | W3CAnnotationTarget[]","options: {\n    typeMap?: Record<string, string>;\n    typeHint?: string;\n  }","entityOrString: PolyEntity","type: string","entities: Record<string, Record<string, NormalizedEntity>>","topLevel: any","defaultStringType?: string","r: T","context: TraversalContext","existing: any","incoming: any","context?: { parent?: any; isTopLevel?: boolean }","added: string[]","unchanged: string[]","previouslyChangedValues: any","incomingChangedValues: any","newHasPart: any[]","part: any","r: any","existing: NormalizedEntity","mapping: Record<string, string>","_service: any","store: CompatibleStore['entities']","resource: Service","id: string","object: any","resource: T | string","defaultResource: R","resource: T","maybeArray: T | T[]","annotation: Annotation","target: string | Reference<any> | SpecificResource | Partial<Canvas>","selector: Selector | undefined","range: Range","manifest: Manifest","specificResource: SpecificResource","unknownEntity: unknown","fields: Field[] | [string]","object: any","state: CompatibleStore","subject: Reference","config: SerializeConfig","sub: Reference","parent?: any","requestToHydrate: Reference | Reference[]","next: any","nextList: any[]","target: undefined | SpecificResource","resource: any","value: InternationalString | null | undefined","target: any","oneOrArray: T[] | undefined","service: any","technicalProperties","props: Partial<TechnicalProperties>","type?: string","descriptiveProperties","prop: Partial<DescriptiveNormalized>","linkingProperties","prop: Partial<LinkingNormalized>","isSpecificResource","resource: unknown","resource: Reference<any> | SpecificResource","selector: Selector | undefined","serializeConfigPresentation2: SerializeConfig","entity: any","entity: Partial<TechnicalProperties>","item?: T[] | typeof UNSET","item","service: ImageService3 | ImageService","services?: any[]","entity: Partial<DescriptiveNormalized>","entity: Partial<LinkingNormalized>","parent?: any","serializeConfigPresentation3: SerializeConfig","context: any","resolvedBody: any","entity: any","entries: [string, any][]","object: any","item: any"],"sources":["../src/shared/to-ref.ts","../src/presentation-3/utilities.ts","../src/presentation-3/empty-types.ts","../src/shared/expand-target.ts","../src/presentation-3/normalize.ts","../src/presentation-3/serialize.ts","../src/shared/compress-specific-resource.ts","../src/presentation-3/serialize-presentation-2.ts","../src/presentation-3/serialize-presentation-3.ts"],"sourcesContent":["import { Reference } from '@iiif/presentation-3';\nimport { isSpecificResource } from './is-specific-resource';\n\nexport function toRef<T extends string = any>(reference: any, _typeHint?: T): Reference<T> | undefined {\n  const type = (_typeHint || 'unknown') as T;\n\n  if (!reference) {\n    return undefined;\n  }\n\n  if (typeof reference === 'string') {\n    return { id: reference, type };\n  }\n\n  if (isSpecificResource(reference)) {\n    return toRef(reference.source, _typeHint);\n  }\n\n  let _type = type && type !== 'unknown' ? type : (reference as any).type || (reference as any)['@type'];\n  const _id = (reference as any).id || (reference as any)['@id'];\n\n  if (_type && _type.indexOf(':') !== -1) {\n    _type = _type.split(':').pop();\n  }\n\n  if (_id && _type) {\n    return { id: _id, type: _type };\n  }\n\n  return undefined;\n}\n","import { CompatibleStore, NormalizedEntity } from './serialize';\nimport { toRef } from '../shared/to-ref';\n\nexport const WILDCARD = {};\nexport const HAS_PART = 'iiif-parser:hasPart';\nexport const PART_OF = 'iiif-parser:partOf';\nexport const IS_EXTERNAL = 'iiif-parser:isExternal';\nexport const UNSET = '__$UNSET$__';\nexport const UNWRAP = '__$UNWRAP$__';\nexport const EMPTY = [];\n\n// Prevent accidental mutation\nObject.freeze(EMPTY);\nObject.freeze(WILDCARD);\n\nexport function isWildcard(object: any) {\n  if (object === WILDCARD || Object.keys(object).length === 0) {\n    return true;\n  }\n  for (const i in object) {\n    return false;\n  }\n  return true;\n}\n\nexport function frameResource(resource: any, framing: any) {\n  if (framing && framing['@explicit']) {\n    const newEntity: any = {};\n    const keys = Object.keys(framing);\n    for (const key of keys) {\n      if (key === PART_OF || key === '@explicit') {\n        continue;\n      }\n      if (isWildcard(framing[key])) {\n        newEntity[key] = resource[key];\n      } else {\n        newEntity[key] = framing[key];\n      }\n    }\n    return newEntity;\n  }\n\n  return resource;\n}\n\nexport function resolveIfExists<T extends NormalizedEntity>(\n  state: CompatibleStore,\n  urlOrResource: any,\n  parent?: any\n): readonly [T | undefined, T | undefined] {\n  const ref = toRef(urlOrResource);\n  if (!ref) {\n    return [undefined, undefined];\n  }\n\n  const request = state.requests[ref.id];\n  // Return the resource.\n  const resourceType = ref.type || state.mapping[ref.id];\n  if (!resourceType || (request && request.resourceUri && (!state.entities[resourceType] || !state.entities[resourceType]![request.resourceUri]))) {\n    // Continue refetching resource, this is an invalid state.\n    return [undefined, undefined];\n  }\n\n  const fullEntity: any = state.entities[resourceType]![request ? request.resourceUri : ref.id] as T;\n\n  if (ref.type && !fullEntity) {\n    return resolveIfExists(state, { id: ref.id }, parent);\n  }\n\n  if (fullEntity && fullEntity[HAS_PART]) {\n    const framing = fullEntity[HAS_PART].find((t: any) => {\n      return parent ? t[PART_OF] === parent.id : t[PART_OF] === fullEntity.id;\n    });\n\n    const newEntity = frameResource(fullEntity, framing);\n    return [newEntity, fullEntity];\n  }\n\n  return [fullEntity, fullEntity];\n}\n","import {\n  AnnotationNormalized,\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n  ResourceProviderNormalized,\n} from '@iiif/presentation-3-normalized';\nimport { _ServiceNormalized } from './serialize';\nimport { EMPTY } from './utilities';\n\nexport const emptyAnnotation: AnnotationNormalized = {\n  id: 'https://iiif-parser/annotation',\n  type: 'Annotation',\n  behavior: EMPTY,\n  label: null,\n  thumbnail: EMPTY,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  accessibility: EMPTY,\n  audience: EMPTY,\n  body: EMPTY,\n  bodyValue: null,\n  canonical: null,\n  created: null,\n  creator: EMPTY,\n  generated: null,\n  generator: EMPTY,\n  modified: null,\n  motivation: EMPTY,\n  rights: null as any, // @todo bug? should not be array of strings.\n  stylesheet: null,\n  target: EMPTY,\n  timeMode: undefined, // @todo bug? should be null.\n  via: EMPTY,\n  partOf: EMPTY,\n};\n\nexport const emptyAnnotationPage: AnnotationPageNormalized = {\n  id: 'https://iiif-parser/annotation-page',\n  type: 'AnnotationPage',\n  behavior: EMPTY,\n  label: null,\n  thumbnail: EMPTY,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  provider: EMPTY,\n  items: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n};\n\nexport const emptyCanvas: CanvasNormalized = {\n  id: 'https://iiif-parser/empty-canvas',\n  type: 'Canvas',\n  label: null,\n  behavior: EMPTY,\n  thumbnail: EMPTY,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  duration: 0,\n  height: 0,\n  width: 0,\n};\n\nexport const emptyCollection: CollectionNormalized = {\n  id: 'https://iiif-parser/empty-collection',\n  type: 'Collection',\n  label: null,\n  viewingDirection: 'left-to-right',\n  behavior: EMPTY,\n  thumbnail: EMPTY,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  services: EMPTY,\n};\n\nexport const emptyManifest: ManifestNormalized = {\n  id: 'https://iiif-parser/empty-manifest',\n  type: 'Manifest',\n  annotations: EMPTY,\n  behavior: EMPTY,\n  homepage: EMPTY,\n  items: EMPTY,\n  label: null,\n  metadata: EMPTY,\n  navDate: null,\n  provider: EMPTY,\n  partOf: EMPTY,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  rendering: EMPTY,\n  requiredStatement: null,\n  rights: null,\n  seeAlso: EMPTY,\n  service: EMPTY,\n  services: EMPTY,\n  start: null,\n  structures: EMPTY,\n  summary: null,\n  thumbnail: EMPTY,\n  viewingDirection: 'left-to-right',\n};\n\nexport const emptyRange: RangeNormalized = {\n  id: 'https://iiif-parser/empty-canvas',\n  type: 'Range',\n  label: null,\n  behavior: EMPTY,\n  thumbnail: EMPTY,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  start: null,\n  supplementary: null,\n  viewingDirection: 'left-to-right',\n};\n\nexport const emptyAgent: ResourceProviderNormalized = {\n  id: 'https://iiif-parser/empty-agent',\n  type: 'Agent',\n  label: {},\n  logo: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n};\n\nexport const emptyService: _ServiceNormalized = {\n  id: 'https://iiif-parser/empty-service',\n  type: 'UnknownService',\n} as any;\n","import type { ExternalWebResource, SpecificResource, W3CAnnotationTarget } from '@iiif/presentation-3';\n\nexport function expandTargetToSpecificResource(\n  target: W3CAnnotationTarget | W3CAnnotationTarget[],\n  options: {\n    typeMap?: Record<string, string>;\n    typeHint?: string;\n  } = {}\n): SpecificResource {\n  if (Array.isArray(target)) {\n    // Don't support multiple targets for now.\n    return expandTargetToSpecificResource(target[0]!);\n  }\n\n  if (typeof target === 'string') {\n    const [id, fragment] = target.split('#');\n\n    if (!fragment) {\n      // This is an unknown selector.\n      return {\n        type: 'SpecificResource',\n        source: {\n          id,\n          type: (options.typeMap && (options.typeMap[id!] as any)) || options.typeHint || 'Unknown',\n        },\n      };\n    }\n\n    return {\n      type: 'SpecificResource',\n      source: { id, type: options.typeHint || 'Unknown' },\n      selector: {\n        type: 'FragmentSelector',\n        value: fragment,\n      },\n    };\n  }\n\n  // @todo, how do we want to support choices for targets.\n  if (\n    target.type === 'Choice' ||\n    target.type === 'List' ||\n    target.type === 'Composite' ||\n    target.type === 'Independents'\n  ) {\n    // we also don't support these, just choose the first.\n    return expandTargetToSpecificResource(target.items[0]!);\n  }\n\n  if (!target.type && 'source' in target) {\n    (target as any).type = 'SpecificResource';\n  }\n\n  if (target.type === 'SpecificResource') {\n    if (target.source.type === 'Canvas' && target.source.partOf && typeof target.source.partOf === 'string') {\n      target.source.partOf = [\n        {\n          id: target.source.partOf,\n          type: 'Manifest',\n        },\n      ];\n    }\n    const targetId = typeof target.source === 'string' ? target.source : target.source.id;\n    if (targetId?.includes('#')) {\n      const parsed = expandTargetToSpecificResource(targetId, options);\n      if (parsed) {\n        target.selector = parsed.selector;\n        target.source = parsed.source;\n      }\n    }\n\n    if (target.selector) {\n      return {\n        ...target,\n        type: 'SpecificResource',\n        source: target.source,\n        selector: target.selector,\n      };\n    }\n    return {\n      ...target,\n      type: 'SpecificResource',\n      source: target.source,\n    };\n  }\n\n  if (target.id) {\n    if ((target as any).type === 'Canvas' && (target as any).partOf && typeof (target as any).partOf === 'string') {\n      (target as any).partOf = [\n        {\n          id: (target as any).partOf,\n          type: 'Manifest',\n        },\n      ];\n    }\n\n    const [id, fragment] = target.id.split('#');\n    if (!fragment) {\n      // This is an unknown selector.\n      return {\n        type: 'SpecificResource',\n        source: {\n          ...(target as any),\n          id,\n        },\n      };\n    }\n\n    return {\n      type: 'SpecificResource',\n      source: {\n        ...(target as any),\n        id,\n      },\n      selector: {\n        type: 'FragmentSelector',\n        value: fragment,\n      },\n    };\n  }\n\n  return {\n    type: 'SpecificResource',\n    source: target as ExternalWebResource,\n  };\n}\n","import type {\n  Annotation,\n  AnnotationPage,\n  Canvas,\n  Collection,\n  Manifest,\n  PolyEntity,\n  Range,\n  Reference,\n  ResourceProvider,\n  Selector,\n  Service,\n  SpecificResource,\n} from '@iiif/presentation-3';\nimport type {\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n  ResourceProviderNormalized,\n} from '@iiif/presentation-3-normalized';\nimport { convertPresentation2 } from '../presentation-2';\nimport { expandTargetToSpecificResource } from '../shared/expand-target';\nimport { isSpecificResource } from '../shared/is-specific-resource';\nimport {\n  emptyAgent,\n  emptyAnnotationPage,\n  emptyCanvas,\n  emptyCollection,\n  emptyManifest,\n  emptyRange,\n  emptyService,\n} from './empty-types';\nimport type { CompatibleStore, NormalizedEntity } from './serialize';\nimport { type TraversalContext, Traverse } from './traverse';\nimport { EMPTY, HAS_PART, IS_EXTERNAL, PART_OF, WILDCARD } from './utilities';\n\nexport const defaultEntities = {\n  Collection: {},\n  Manifest: {},\n  Canvas: {},\n  AnnotationPage: {},\n  AnnotationCollection: {},\n  Annotation: {},\n  ContentResource: {},\n  Range: {},\n  Service: {},\n  Selector: {},\n  Agent: {},\n};\n\nexport function getDefaultEntities() {\n  return {\n    Collection: {},\n    Manifest: {},\n    Canvas: {},\n    AnnotationPage: {},\n    AnnotationCollection: {},\n    Annotation: {},\n    ContentResource: {},\n    Range: {},\n    Service: {},\n    Selector: {},\n    Agent: {},\n  };\n}\n\nfunction getResource(entityOrString: PolyEntity, type: string): Reference {\n  if (typeof entityOrString === 'string') {\n    return { id: entityOrString, type };\n  }\n  if (!entityOrString.id) {\n    throw new Error(`Invalid resource does not have an ID (${JSON.stringify(entityOrString)}, ${type})`);\n  }\n  return entityOrString as Reference;\n}\n\nfunction mapToEntities(entities: Record<string, Record<string, NormalizedEntity>>, topLevel: any) {\n  return <T extends Reference | string>(type: string, defaultStringType?: string) => {\n    const storeType = entities[type] ? entities[type]! : {};\n    return (r: T, context: TraversalContext): T => {\n      const resource = getResource(r, defaultStringType || type);\n      if (resource && resource.id && type) {\n        storeType[resource.id] = storeType[resource.id]\n          ? (mergeEntities(storeType[resource.id]!, resource, {\n              parent: context.parent,\n              isTopLevel: topLevel.id === resource.id,\n            }) as any)\n          : mergeEntities({ id: resource.id, type: resource.type } as any, resource, {\n              parent: context.parent,\n              isTopLevel: topLevel.id === resource.id,\n            });\n        return {\n          id: resource.id,\n          type: type === 'ContentResource' ? type : resource.type,\n        } as T;\n      }\n      return resource as T;\n    };\n  };\n}\n\nexport function merge(existing: any, incoming: any, context?: { parent?: any; isTopLevel?: boolean }): any {\n  if (!incoming) {\n    // Falsy values are ignored\n    return existing;\n  }\n  if (Array.isArray(existing)) {\n    if (!Array.isArray(incoming)) {\n      throw new Error('Cannot merge array with non-array');\n    }\n    // For arrays, we check if any of the incoming values are not already in the\n    // existing values and add them if this is not the case. If the incoming\n    // value is an entity that is already in the existing values, it will be\n    // merged with the existing value.\n    const merged = [...existing];\n    for (const item of incoming) {\n      if (item['@id'] && !item.id) {\n        item.id = item['@id'];\n      }\n      if (item['@type'] && !item.type) {\n        item.type = item['@type'];\n      }\n      if (item === null || item === undefined) {\n        continue;\n      }\n      if (Array.isArray(item)) {\n        // FIXME: How to handle this properly?\n        merged.push(item);\n      } else if (typeof item === 'object' && item.id && item.type) {\n        const existingIdx = merged.findIndex((e) => e.id === item.id && e.type === item.type);\n        if (existingIdx >= 0) {\n          merged[existingIdx] = merge(merged[existingIdx], item);\n        }\n      } else if (existing.indexOf(item) === -1) {\n        merged.push(item);\n      }\n    }\n    return merged;\n  } else if (typeof existing === 'object') {\n    if (Array.isArray(incoming) || typeof incoming !== 'object') {\n      throw new Error('Cannot merge object with non-object');\n    }\n    // For objects, we check the existing object for non-existing or \"empty\"\n    // properties and use the value from the incoming object for them\n    const merged = { ...existing };\n    const added: string[] = [];\n    const unchanged: string[] = [];\n    const existingKeys = Object.keys(existing).filter((key) => key !== HAS_PART && key !== 'id' && key !== 'type');\n    const previouslyChangedValues: any = {};\n    const incomingChangedValues: any = {};\n    for (const [key, val] of Object.entries(incoming)) {\n      if (key === HAS_PART || key === 'id' || key === 'type') {\n        continue;\n      }\n      const currentVal = merged[key];\n      if (currentVal === val) {\n        unchanged.push(key);\n      } else if (currentVal === EMPTY || !currentVal) {\n        added.push(key);\n        merged[key] = val;\n      } else {\n        if (currentVal && val) {\n          previouslyChangedValues[key] = currentVal;\n          incomingChangedValues[key] = val;\n        }\n        merged[key] = merge(currentVal, val);\n        if (merged[key] === previouslyChangedValues[key]) {\n          unchanged.push(key);\n          delete previouslyChangedValues[key];\n        }\n      }\n    }\n\n    if (context && ((context.parent && context.parent.id) || context.isTopLevel)) {\n      const newHasPart: any[] = [];\n      const part: any = {};\n      if (context.parent) {\n        part[PART_OF] = context.parent.id;\n      } else if (context.isTopLevel) {\n        part[PART_OF] = existing.id;\n      }\n\n      if (merged[HAS_PART] && merged[HAS_PART].length) {\n        const noExplicit = !(merged[HAS_PART] || []).find((r: any) => r['@explicit']);\n        const hasDiverged = added.length > 0 || unchanged.length !== existingKeys.length;\n        // We already have one, it may conflict here.\n        // 1. Fix the first part.\n        if (noExplicit && hasDiverged) {\n          for (const item of merged[HAS_PART]) {\n            const first = { ...item };\n            const changedKeys = Object.keys(previouslyChangedValues);\n            if (first) {\n              first['@explicit'] = true;\n              for (const addedProperty of existingKeys) {\n                if (addedProperty !== HAS_PART) {\n                  first[addedProperty] = WILDCARD;\n                }\n              }\n              for (const changedKey of changedKeys) {\n                first[changedKey] = previouslyChangedValues[changedKey];\n              }\n            }\n            newHasPart.push(first);\n          }\n        } else {\n          newHasPart.push(...merged[HAS_PART]);\n        }\n\n        if (hasDiverged) {\n          // Add the framing.\n          const changedKeys = Object.keys(incomingChangedValues);\n          part['@explicit'] = true;\n          for (const addedProperty of added) {\n            part[addedProperty] = WILDCARD;\n          }\n          for (const unchangedValue of unchanged) {\n            part[unchangedValue] = WILDCARD;\n          }\n          for (const changedKey of changedKeys) {\n            part[changedKey] = incomingChangedValues[changedKey];\n          }\n        }\n      }\n\n      part.id = merged.id;\n      part.type = merged.type;\n      newHasPart.push(part);\n\n      merged[HAS_PART] = newHasPart;\n    }\n\n    return merged;\n  } else if (existing) {\n    return existing;\n  }\n  return incoming;\n}\n\nexport function mergeEntities(\n  existing: NormalizedEntity,\n  incoming: any,\n  context?: { parent?: any; isTopLevel?: boolean }\n): NormalizedEntity {\n  if (typeof existing === 'string') {\n    return existing;\n  }\n\n  if (incoming.id !== (existing as any).id || incoming.type !== (existing as any).type) {\n    if (incoming.type === 'ImageService3') {\n      return incoming;\n    }\n    if ((existing as any).type === 'ImageService3') {\n      return existing;\n    }\n\n    throw new Error(\n      `Can only merge entities with identical identifiers and type! ${incoming.type}(${incoming.id}) => ${\n        (existing as any).type\n      }(${(existing as any).id})`\n    );\n  }\n  return merge({ ...existing }, incoming, context);\n}\n\nfunction recordTypeInMapping(mapping: Record<string, string>) {\n  return <T extends Reference | string>(type: string, defaultStringType?: string) => {\n    return (r: T): T => {\n      const { id, type: foundType } = getResource(r, defaultStringType || type);\n      if (typeof id === 'undefined') {\n        throw new Error('Found invalid entity without an ID.');\n      }\n      if (type === 'ContentResource' || type === 'Service') {\n        mapping[id] = type;\n      } else {\n        mapping[id] = foundType as any;\n      }\n      return r;\n    };\n  };\n}\n\nfunction normalizeService(_service: any): any {\n  const service = Object.assign({}, _service);\n  if (service['@id']) {\n    service.id = service['@id'];\n  }\n\n  if (service['@type']) {\n    service.type = service['@type'];\n  }\n\n  if (service.service) {\n    const serviceReferences = [];\n    service.service = Array.isArray(service.service) ? service.service : [service.service];\n    for (const innerService of service.service) {\n      serviceReferences.push({\n        id: innerService['@id'] || innerService.id,\n        type: innerService['@type'] || innerService.type,\n      });\n    }\n    service.service = serviceReferences;\n  }\n\n  return Object.assign({}, emptyService, service);\n}\n\nfunction recordServiceForLoading(store: CompatibleStore['entities']) {\n  return (resource: Service) => {\n    store.Service = store.Service ? store.Service : {};\n    const id: string = (resource as any).id || (resource as any)['@id'];\n    const normalizedResource = normalizeService(resource);\n\n    // @todo add loading status for image services.\n\n    if (normalizedResource && normalizedResource.id) {\n      if (store.Service[normalizedResource.id]) {\n        // We need to merge.\n        store.Service[id] = mergeEntities(store.Service[id]!, normalizedResource);\n      } else {\n        store.Service[id] = normalizedResource as any;\n      }\n    }\n\n    // Keep original on resource - this is a parallel copy for READING\n    return resource;\n  };\n}\n\n/**\n * A string hashing function based on Daniel J. Bernstein's popular 'times 33' hash algorithm.\n * @author MatthewBarker <mrjbarker@hotmail.com>\n */\nfunction hash(object: any): string {\n  const text = JSON.stringify(object);\n\n  let numHash = 5381,\n    index = text.length;\n\n  while (index) {\n    numHash = (numHash * 33) ^ text.charCodeAt(--index);\n  }\n\n  const num = numHash >>> 0;\n\n  const hexString = num.toString(16);\n  if (hexString.length % 2) {\n    return '0' + hexString;\n  }\n  return hexString;\n}\n\nfunction addMissingIdToContentResource<T extends Partial<Reference>>(type: string) {\n  return (resource: T | string): T => {\n    if (typeof resource === 'string') {\n      return { id: resource, type } as T;\n    }\n    if (!resource.id) {\n      return { id: `vault://${hash(resource)}`, type, ...resource };\n    }\n    if (!resource.type) {\n      return { type, ...resource };\n    }\n    return resource;\n  };\n}\n\nfunction ensureDefaultFields<T, R>(defaultResource: R) {\n  return (resource: T): R => {\n    return {\n      ...defaultResource,\n      ...resource,\n    };\n  };\n}\n\nfunction ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n\nfunction ensureArrayOnAnnotation(annotation: Annotation): Annotation {\n  if (annotation.body) {\n    annotation.body = ensureArray(annotation.body);\n  }\n  if (annotation.seeAlso) {\n    annotation.seeAlso = ensureArray(annotation.seeAlso);\n  }\n  if (annotation.audience) {\n    annotation.audience = ensureArray(annotation.audience);\n  }\n  if (annotation.accessibility) {\n    annotation.accessibility = ensureArray(annotation.accessibility);\n  }\n  if (annotation.motivation) {\n    annotation.motivation = ensureArray(annotation.motivation);\n  }\n\n  return annotation;\n}\n\nfunction toSpecificResource(\n  target: string | Reference<any> | SpecificResource | Partial<Canvas>,\n  { typeHint, partOfTypeHint }: { typeHint?: string; partOfTypeHint?: string } = {}\n): SpecificResource {\n  if (typeof target === 'string') {\n    target = { id: target, type: typeHint || 'unknown' };\n  }\n\n  if (isSpecificResource(target)) {\n    if (typeof target.source === 'string') {\n      target.source = { id: target.source, type: typeHint || 'unknown' };\n    }\n\n    if (target.source.type === 'Canvas' && target.source.partOf && typeof target.source.partOf === 'string') {\n      target.source.partOf = [\n        {\n          id: target.source.partOf,\n          type: partOfTypeHint || 'Manifest', // Most common is manifest.\n        },\n      ];\n    }\n\n    return target;\n  }\n\n  let selector: Selector | undefined;\n  if ((target.id || '').indexOf('#') !== -1) {\n    const [id, fragment] = (target.id || '').split('#');\n    target.id = id;\n    if (fragment) {\n      selector = {\n        type: 'FragmentSelector',\n        value: fragment,\n      };\n    }\n  }\n\n  return {\n    type: 'SpecificResource',\n    source: target,\n    selector,\n  };\n}\n\nfunction rangeItemToSpecificResource(range: Range): Range {\n  const _range = Object.assign({}, range);\n  if (range && range.items) {\n    _range.items = range.items.map((rangeItem) => {\n      if (typeof rangeItem === 'string' || rangeItem.type === 'Canvas') {\n        return toSpecificResource(rangeItem);\n      }\n      return rangeItem;\n    });\n  }\n  return _range;\n}\n\nfunction startCanvasToSpecificResource(manifest: Manifest): Manifest {\n  const _manifest = Object.assign({}, manifest);\n  if (_manifest.start) {\n    _manifest.start = toSpecificResource(_manifest.start, {\n      typeHint: 'Canvas',\n    }) as any;\n    return _manifest;\n  }\n  return manifest;\n}\n\nfunction annotationTargetToSpecificResource(annotation: Annotation): Annotation {\n  const _annotation = Object.assign({}, annotation);\n  if (_annotation.target) {\n    _annotation.target = expandTargetToSpecificResource(_annotation.target as any, { typeHint: 'Canvas' }) as any;\n    return _annotation;\n  }\n  return annotation;\n}\n\nexport function traverseSpecificResource(specificResource: SpecificResource): SpecificResource {\n  return specificResource;\n}\n\nexport function addFlagForExternalResource<T extends AnnotationPage | Manifest | Collection>(resource: T): T {\n  if (typeof resource.items === 'undefined') {\n    (resource as any)[IS_EXTERNAL] = true;\n  }\n  return resource;\n}\n\nexport function normalize(unknownEntity: unknown) {\n  const entity = convertPresentation2(unknownEntity);\n  const entities = getDefaultEntities();\n  const mapping = {};\n  const addToEntities = mapToEntities(entities, entity);\n  const addToMapping = recordTypeInMapping(mapping);\n\n  const traversal = new Traverse({\n    collection: [\n      addFlagForExternalResource,\n      ensureDefaultFields<Collection, CollectionNormalized>(emptyCollection),\n      addToMapping<Collection>('Collection'),\n      addToEntities<Collection>('Collection'),\n    ],\n    manifest: [\n      addFlagForExternalResource,\n      ensureDefaultFields<Manifest, ManifestNormalized>(emptyManifest),\n      startCanvasToSpecificResource,\n      addToMapping<Manifest>('Manifest'),\n      addToEntities<Manifest>('Manifest'),\n    ],\n    canvas: [\n      ensureDefaultFields<Canvas, CanvasNormalized>(emptyCanvas),\n      addToMapping<Canvas>('Canvas'),\n      addToEntities<Canvas>('Canvas'),\n    ],\n    annotationPage: [\n      addFlagForExternalResource,\n      addMissingIdToContentResource('AnnotationPage'),\n      ensureDefaultFields<AnnotationPage, AnnotationPageNormalized>(emptyAnnotationPage),\n      addToMapping<AnnotationPage>('AnnotationPage'),\n      addToEntities<AnnotationPage>('AnnotationPage'),\n    ],\n    annotation: [\n      // This won't be normalized before going into the state.\n      // It will be normalized through selectors and pattern matching.\n      addMissingIdToContentResource('Annotation'),\n      ensureArrayOnAnnotation,\n      annotationTargetToSpecificResource,\n      addToMapping<Annotation>('Annotation'),\n      addToEntities<Annotation>('Annotation'),\n    ],\n    contentResource: [\n      // This won't be normalized before going into the state.\n      // It will be normalized through selectors and pattern matching.\n      addMissingIdToContentResource<any>('ContentResource'),\n      addToMapping<any>('ContentResource'),\n      addToEntities<any>('ContentResource'),\n    ],\n    range: [\n      // This will add a LOT to the state, maybe this will be configurable down the line.\n      ensureDefaultFields<Range, RangeNormalized>(emptyRange),\n      rangeItemToSpecificResource,\n      addToMapping<Range>('Range', 'Canvas'),\n      addToEntities<Range>('Range', 'Canvas'),\n    ],\n    agent: [\n      ensureDefaultFields<ResourceProvider, ResourceProviderNormalized>(emptyAgent),\n      addToMapping<ResourceProvider>('Agent'),\n      addToEntities<ResourceProvider>('Agent'),\n    ],\n    specificResource: [\n      // Special-case changes to this type of resource.\n      traverseSpecificResource,\n    ],\n    service: [\n      // Only record, don't replace.\n      recordServiceForLoading(entities),\n    ],\n  });\n  const resource = traversal.traverseUnknown(entity) as Reference;\n\n  return { entities, resource, mapping };\n}\n","import { AnnotationCollection, ContentResource, Reference, Selector } from '@iiif/presentation-3';\nimport {\n  AnnotationCollectionNormalized,\n  AnnotationNormalized,\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n  ResourceProviderNormalized,\n  ServiceNormalized,\n} from '@iiif/presentation-3-normalized';\nimport { resolveIfExists, UNSET, UNWRAP } from './utilities';\n\nexport type Field = any[];\n\nexport type CompatibleStore<T extends string = string> = {\n  requests: {\n    [url: string]: { resourceUri?: string } & any;\n  };\n  entities: {\n    [type in T]: {\n      [id: string]: NormalizedEntity;\n    };\n  };\n  mapping: {\n    [id: string]: T;\n  };\n};\n\nexport type _ServiceNormalized = ServiceNormalized & { id: string; type: string };\n\nexport type NormalizedEntity =\n  | CollectionNormalized\n  | ManifestNormalized\n  | CanvasNormalized\n  | AnnotationPageNormalized\n  | AnnotationCollectionNormalized\n  | AnnotationCollection\n  | AnnotationNormalized\n  | ContentResource\n  | RangeNormalized\n  | _ServiceNormalized\n  | Selector\n  | ResourceProviderNormalized\n  | { id?: string; '@id'?: string; type?: string; '@type'?: string; [key: string]: any };\n\ntype SerializerContext = {\n  isTopLevel?: boolean;\n  parent?: any;\n  fullResource?: any;\n};\n\nexport type Serializer<Type extends NormalizedEntity> = (\n  entity: Type,\n  state: any,\n  context: SerializerContext\n) => Generator<Reference | Reference[], typeof UNSET | Field[], any>;\n\nexport type SerializeConfig = {\n  Collection?: Serializer<CollectionNormalized>;\n  Manifest?: Serializer<ManifestNormalized>;\n  Canvas?: Serializer<CanvasNormalized>;\n  AnnotationPage?: Serializer<AnnotationPageNormalized>;\n  AnnotationCollection?: Serializer<AnnotationCollectionNormalized>;\n  Annotation?: Serializer<AnnotationNormalized>;\n  ContentResource?: Serializer<ContentResource>;\n  Range?: Serializer<RangeNormalized>;\n  Service?: Serializer<_ServiceNormalized>;\n  Selector?: Serializer<Selector>;\n  Agent?: Serializer<ResourceProviderNormalized>;\n};\n\nexport function serializedFieldsToObject<T>(fields: Field[] | [string]): T {\n  const object: any = {};\n\n  for (const [key, value] of fields) {\n    if (key === UNWRAP && value !== UNSET) {\n      return value as T;\n    }\n    if (value !== UNSET && typeof value !== 'undefined' && value !== null) {\n      object[key] = value;\n    }\n  }\n\n  return object as T;\n}\n\nexport function serialize<Return>(state: CompatibleStore, subject: Reference, config: SerializeConfig): Return {\n  if (!subject.type || !subject.id) {\n    throw new Error('Unknown entity');\n  }\n\n  if (!config[subject.type as keyof SerializeConfig]) {\n    throw new Error(`Serializer not found for ${subject.type}`);\n  }\n\n  function flatten(sub: Reference, parent?: any, depth = 0) {\n    const generator = config[sub.type as keyof SerializeConfig];\n    if (!generator) {\n      return UNSET;\n    }\n    if (depth > 20) {\n      throw new Error('Circular reference: ' + sub.id + ' ' + sub.type);\n    }\n    const [resource, fullResource] =\n      resolveIfExists(state, sub.type ? sub : sub.id, parent) || (sub.id && sub.type ? sub : null);\n    if (!resource) {\n      return UNSET;\n    }\n    const iterator = generator(resource as any, state, {\n      parent,\n      isTopLevel: subject.id === sub.id,\n      fullResource,\n    });\n    let current = iterator.next();\n    while (!current.done) {\n      const requestToHydrate: Reference | Reference[] = current.value as any;\n      let next: any = UNSET;\n\n      if (requestToHydrate) {\n        if (Array.isArray(requestToHydrate)) {\n          const nextList: any[] = [];\n          for (const req of requestToHydrate) {\n            nextList.push(flatten(req, sub, depth + 1));\n          }\n          next = nextList;\n        } else {\n          next = flatten(requestToHydrate, sub, depth + 1);\n        }\n      }\n      current = iterator.next(next);\n    }\n\n    if (current.value === UNSET) {\n      return UNSET;\n    }\n\n    return serializedFieldsToObject(current.value);\n  }\n\n  return flatten(subject) as Return;\n}\n","import { SpecificResource } from '@iiif/presentation-3';\n\nexport function compressSpecificResource(\n  target: undefined | SpecificResource,\n  { allowSourceString = true, allowString = false, allowedStringType }: { allowString?: boolean; allowSourceString?: boolean; allowedStringType?: string } = {}\n): any {\n  const fixSource = (resource: any) => {\n    if (allowSourceString && resource && resource.source && typeof resource.source !== 'string') {\n      const keys = Object.keys(resource.source);\n      if (resource.source.id && resource.source.type && keys.length === 2) {\n        return { ...resource, source: resource.source.id };\n      }\n    }\n    return resource;\n  };\n\n  if (target) {\n    if (target.source && target.source.partOf) {\n      // Ignore if we have a partOf\n      return fixSource(target);\n    }\n    const keys = Object.keys(target);\n    if (\n      (keys.length === 2 && target.type && target.source) ||\n      (keys.length === 3 && target.type && target.source && keys.indexOf('selector') !== -1 && !target.selector)\n    ) {\n      if (allowString && (!allowedStringType || allowedStringType === target.source.type)) {\n        return target.source.id;\n      }\n\n      if (target.source.type === 'ContentResource') {\n        return { type: 'SpecificResource', source: target.source.id };\n      }\n\n      // If all we have is the wrapped source, just return the ID.\n      return target.source;\n    }\n    if (target.selector) {\n      if (\n        !Array.isArray(target.selector) &&\n        typeof target.selector !== 'string' &&\n        target.selector.type === 'FragmentSelector'\n      ) {\n        const newId = `${target.source.id}#${target.selector.value}`;\n        return allowString ? newId : { id: newId, type: target.source.type };\n      }\n    }\n  }\n  return fixSource(target);\n}\n","import { SerializeConfig } from './serialize';\nimport {\n  FragmentSelector,\n  InternationalString,\n  Reference,\n  Selector,\n  SpecificResource,\n  TechnicalProperties,\n} from '@iiif/presentation-3';\nimport { DescriptiveNormalized, LinkingNormalized } from '@iiif/presentation-3-normalized';\nimport * as Presentation2 from '@iiif/presentation-2';\nimport { compressSpecificResource } from '../shared/compress-specific-resource';\n\nexport function languageString2to3(\n  value: InternationalString | null | undefined\n): Presentation2.LanguageProperty | Presentation2.LanguageProperty[] | undefined {\n  if (!value) {\n    return undefined;\n  }\n\n  const languages = Object.keys(value);\n\n  if (languages.length === 0) {\n    return undefined;\n  }\n\n  // If there is only one, then return it as a string.\n  if (languages.length === 1) {\n    const language = languages[0];\n    if (!language) {\n      return '';\n    }\n\n    const singleValue = (value[language] || []).join('');\n\n    if (language === '@none' || language === 'none' || language === 'en') {\n      return singleValue;\n    }\n\n    return {\n      '@language': language,\n      '@value': singleValue,\n    };\n  }\n\n  return languages.map((language) => {\n    return {\n      '@language': language,\n      '@value': (value[language] || []).join(''),\n    };\n  });\n}\n\nfunction parseCanvasTarget(target: any): any {\n  if (Array.isArray(target)) {\n    return target.map((t) => parseCanvasTarget(t));\n  }\n\n  if (typeof target === 'string') {\n    return target;\n  }\n\n  if (target.type && target.type === 'Canvas') {\n    return target.id;\n  }\n\n  return target;\n}\n\nfunction unNestArray<T>(oneOrArray: T[] | undefined, onlyOne = false): T | T[] | undefined {\n  if (!oneOrArray) {\n    return undefined;\n  }\n\n  if (oneOrArray.length > 1 && !onlyOne) {\n    return oneOrArray;\n  }\n  return oneOrArray[0] || undefined;\n}\n\nfunction convertService(service: any) {\n  if (!service) {\n    return undefined;\n  }\n\n  if (typeof service === 'string') {\n    return {\n      '@id': service,\n    };\n  }\n\n  if ('@id' in service) {\n    const newService = { ...service };\n    delete newService['@type'];\n    return newService;\n  }\n\n  // @todo support auth.\n  return {\n    '@context': 'http://iiif.io/api/image/2/context.json',\n    '@id': service.id,\n    profile: `http://iiif.io/api/image/2/profiles/${service.profile}.json`,\n  };\n}\n\nfunction technicalProperties(props: Partial<TechnicalProperties>, type?: string) {\n  return [\n    ['@id', props.id],\n    ['@type', type],\n    ['format', props.format],\n    ['height', props.height],\n    ['width', props.width],\n    ['viewingDirection', props.viewingDirection !== 'left-to-right' ? props.viewingDirection : undefined],\n\n    // Non-standard property.\n    ['license', (props as any).license ? (props as any).license : undefined],\n    // @todo Viewing hint is merged with behavior\n    // ['viewingHint', props.]\n  ];\n}\n\nfunction* descriptiveProperties(prop: Partial<DescriptiveNormalized>): Generator<any, any, any> {\n  const provider = prop.provider ? yield prop.provider[0] : undefined;\n\n  return [\n    ['label', languageString2to3(prop.label)],\n    [\n      'metadata',\n      prop.metadata && prop.metadata.length\n        ? prop.metadata.map((item) => ({\n            label: languageString2to3(item.label) || '',\n            value: languageString2to3(item.value) || '',\n          }))\n        : undefined,\n    ],\n    ['description', languageString2to3(prop.summary)],\n    ['thumbnail', unNestArray(yield prop.thumbnail)],\n    ['navDate', prop.navDate],\n    // @todo these needs consideration if the way provider is parsed changes.\n    ['logo', provider ? unNestArray(provider.logo) : undefined],\n    ['homepage', provider ? provider.homepage : undefined],\n    ['attribution', prop.requiredStatement ? languageString2to3(prop.requiredStatement.value) : undefined],\n  ];\n}\n\nfunction* linkingProperties(prop: Partial<LinkingNormalized>) {\n  const startProp =\n    prop.start && prop.start.type && (prop.start as any).type === 'SpecificResource'\n      ? compressSpecificResource(prop.start as any)\n      : prop.start;\n\n  return [\n    ['seeAlso', unNestArray(yield prop.seeAlso)],\n    // @todo support more services (like auth)\n    ['service', unNestArray((prop.service || []).map(convertService))],\n    ['rendering', unNestArray(yield prop.rendering)],\n    // @todo part of to within\n    // ['within', unNestArray(yield prop.partOf)],\n    // @todo this may not work completely.\n    ['startCanvas', startProp ? startProp.id : undefined],\n  ];\n}\n\nfunction isSpecificResource(resource: unknown): resource is SpecificResource {\n  return (resource as any).type === 'SpecificResource';\n}\nfunction isFragmentSelector(resource: unknown): resource is FragmentSelector {\n  return (resource as any) && (resource as any).type === 'FragmentSelector';\n}\n\nfunction specificResourceToString(resource: Reference<any> | SpecificResource) {\n  if (resource && isSpecificResource(resource)) {\n    let id = resource.id;\n    const selector: Selector | undefined = resource.selector\n      ? Array.isArray(resource.selector)\n        ? resource.selector[0]\n        : resource.selector\n      : undefined;\n\n    if (isFragmentSelector(selector)) {\n      id += '#' + selector.value;\n    }\n    return id;\n  }\n  return resource?.id;\n}\n\nexport const serializeConfigPresentation2: SerializeConfig = {\n  Manifest: function* (entity, state, { isTopLevel }) {\n    return [\n      ...(isTopLevel ? [['@context', 'http://iiif.io/api/presentation/2/context.json']] : []),\n      ...technicalProperties(entity, 'sc:Manifest'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      // Structural.\n      // @todo structures\n      [\n        'sequences',\n        [\n          {\n            '@id': `${entity.id}/sequence0`,\n            '@type': 'sc:Sequence',\n            canvases: yield entity.items,\n          },\n        ],\n      ],\n      ['structures', yield entity.structures],\n    ];\n  },\n\n  Canvas: function* (entity) {\n    const paintingPage = yield entity.items;\n    const resources = paintingPage[0];\n    return [\n      // Items.\n      ...technicalProperties(entity, 'sc:Canvas'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['images', resources ? [resources.resources] : undefined],\n      [\n        // @todo use otherContent if they are inlined\n        'annotations',\n        entity.annotations && entity.annotations.length ? unNestArray(yield entity.annotations) : undefined,\n      ],\n    ];\n  },\n\n  AnnotationPage: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:AnnotationList'),\n      ...(yield* descriptiveProperties(entity)),\n      ['resources', entity.items && entity.items.length ? unNestArray(yield entity.items) : undefined],\n    ];\n  },\n\n  Annotation: function* (entity) {\n    return [\n      ['@id', entity.id],\n      ['@type', 'oa:Annotation'],\n      // This could be improved.\n      ['motivation', 'sc:painting'],\n      ['on', parseCanvasTarget(entity.target)],\n      ['resource', unNestArray(yield entity.body, true)],\n    ];\n  },\n\n  ContentResource: function* (entity: any) {\n    switch (entity.type) {\n      case 'Image':\n        return [\n          // Image properties.\n          ...technicalProperties(entity, 'dctypes:Image'),\n          ...(yield* descriptiveProperties(entity)),\n          ...(yield* linkingProperties(entity)),\n        ];\n      case 'Text':\n      case 'Dataset':\n      default:\n        return [...technicalProperties(entity, undefined), ...(yield* descriptiveProperties(entity))];\n    }\n  },\n\n  AnnotationCollection: function* (entity) {\n    return [\n      // @todo expand properties if they are actually used.\n      ['@id', entity.id],\n      ['@type', 'sc:Layer'],\n      ['label', languageString2to3(entity.label)],\n    ];\n  },\n\n  Collection: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:Collection'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['members', yield* entity.items],\n    ];\n  },\n\n  Range: function* (entity) {\n    const members = [];\n    const canvases = [];\n\n    if (entity.items) {\n      for (const _item of entity.items) {\n        const item = _item.type === 'SpecificResource' ? _item.source : _item;\n        if (item) {\n          const canvas = yield item;\n          members.push({\n            '@id': specificResourceToString(_item),\n            '@type': item.type,\n            label: canvas ? canvas.label : undefined,\n            within: entity.id,\n          });\n          if (item.type === 'Canvas') {\n            canvases.push(item.id);\n          }\n        }\n      }\n    }\n\n    return [\n      ...technicalProperties(entity, 'sc:Range'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['canvases', canvases.length === members.length ? canvases : undefined],\n      ['members', canvases.length !== members.length ? members : undefined],\n    ];\n  },\n};\n","import { SerializeConfig } from './serialize';\nimport {\n  ImageService,\n  ImageService2,\n  ImageService3,\n  ResourceProvider,\n  TechnicalProperties,\n} from '@iiif/presentation-3';\nimport { compressSpecificResource } from '../shared/compress-specific-resource';\nimport { DescriptiveNormalized, LinkingNormalized } from '@iiif/presentation-3-normalized';\nimport { HAS_PART, IS_EXTERNAL, PART_OF, UNSET, UNWRAP } from './utilities';\nimport { isSpecificResource } from '../shared/is-specific-resource';\n\nfunction technicalProperties(entity: Partial<TechnicalProperties>): Array<[keyof TechnicalProperties, any]> {\n  return [\n    // Technical\n    ['id', !entity.id?.startsWith('vault://') ? entity.id : undefined],\n    ['type', entity.type],\n    ['format', entity.format],\n    ['profile', entity.profile],\n    ['height', entity.height || undefined],\n    ['width', entity.width || undefined],\n    ['duration', entity.duration || undefined],\n    ['viewingDirection', entity.viewingDirection !== 'left-to-right' ? entity.viewingDirection : undefined],\n    ['behavior', entity.behavior && entity.behavior.length ? entity.behavior : undefined],\n    ['timeMode', entity.timeMode],\n    ['motivation', Array.isArray(entity.motivation) ? entity.motivation[0] : entity.motivation],\n    [HAS_PART as any, UNSET],\n  ];\n}\n\nfunction filterEmpty<T>(item?: T[] | typeof UNSET): T[] | undefined | typeof UNSET {\n  if (item === UNSET) {\n    return undefined;\n  }\n\n  if (!item || item.length === 0) {\n    return undefined;\n  }\n  const filtered = item.filter((item) => (item as any) !== UNSET);\n\n  if (filtered.length === 0) {\n    return undefined;\n  }\n\n  return filtered;\n}\n\nfunction service2compat(service: ImageService3 | ImageService): ImageService2 | ImageService3 {\n  if (service && service.type && service.type === 'ImageService2') {\n    const { id, type, profile: _profile, ..._service } = service as any;\n\n    const profile =\n      typeof _profile === 'string'\n        ? _profile\n        : Array.isArray(_profile)\n          ? _profile.find((p) => typeof p === 'string')\n          : '';\n\n    return {\n      '@id': id,\n      '@type': type,\n      profile: profile\n        ? profile.startsWith('http')\n          ? profile\n          : `http://iiif.io/api/image/2/${profile}.json`\n        : 'http://iiif.io/api/image/2/level0.json',\n      ..._service,\n    } as any;\n  }\n\n  return service as ImageService3;\n}\n\nfunction filterService2Compat(services?: any[]) {\n  if (!Array.isArray(services)) {\n    services = services ? [services] : [];\n  }\n\n  if (!services || services.length === 0) {\n    return undefined;\n  }\n\n  return (services as any[]).map(service2compat);\n}\n\nfunction* descriptiveProperties(\n  entity: Partial<DescriptiveNormalized>\n): Generator<any, any, Array<[keyof DescriptiveNormalized, any]>> {\n  return [\n    ['label', entity.label],\n    ['metadata', filterEmpty(entity.metadata)],\n    ['summary', entity.summary],\n    ['requiredStatement', entity.requiredStatement],\n    ['rights', Array.isArray(entity.rights) ? entity.rights[0] || undefined : entity.rights || undefined],\n    ['navDate', entity.navDate],\n    ['language', entity.language],\n    // We yield these fully as they are embedded in here.\n    ['thumbnail', filterEmpty(yield entity.thumbnail)],\n    ['placeholderCanvas', yield entity.placeholderCanvas],\n    ['accompanyingCanvas', yield entity.accompanyingCanvas],\n\n    // @todo need to test this one.\n    ['provider', filterEmpty(yield entity.provider)],\n  ];\n}\n\nfunction* linkingProperties(\n  entity: Partial<LinkingNormalized>,\n  parent?: any\n): Generator<any, any, Array<[keyof LinkingNormalized, any]>> {\n  let filteredPartOf = [];\n  for (let partOf of entity.partOf || []) {\n    if (partOf.type === 'Manifest' && parent.type === 'Manifest') continue;\n    filteredPartOf.push(yield partOf);\n  }\n\n  return [\n    ['seeAlso', filterEmpty(yield entity.seeAlso)],\n    ['service', filterEmpty(filterService2Compat(entity.service))],\n    ['services', filterEmpty(filterService2Compat(entity.services))],\n    ['rendering', filterEmpty(yield entity.rendering)],\n    ['supplementary', filterEmpty(yield entity.supplementary)],\n    ['homepage', filterEmpty(yield entity.homepage)],\n    ['logo', filterEmpty(yield (entity as ResourceProvider).logo)],\n\n    // Don't yield these, they are references.\n    ['partOf', filterEmpty(filteredPartOf)],\n    [\n      'start',\n      // @todo remove once types updated.\n      entity.start ? compressSpecificResource(entity.start) : entity.start,\n    ],\n  ];\n}\n\nexport const serializeConfigPresentation3: SerializeConfig = {\n  Manifest: function* (entity, state, { isTopLevel }) {\n    if (!isTopLevel) {\n      return [\n        // Only a snippet.\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n        ['navPlace', (entity as any).navPlace],\n      ];\n    }\n\n    let context: any = 'http://iiif.io/api/presentation/3/context.json';\n\n    if (entity.navPlace || itemsHaveNavPlace(entity)) {\n      context = [\n        'http://iiif.io/api/presentation/3/context.json',\n        'http://iiif.io/api/extension/navplace/context.json',\n      ];\n    }\n\n    return [\n      [\n        '@context',\n        (entity as any)['@context'] ? (entity as any)['@context'] : context,\n      ],\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n      ['structures', filterEmpty(yield entity.structures)],\n      ['annotations', filterEmpty(yield entity.annotations)],\n      ['navPlace', (entity as any).navPlace], // @todo remove when types are updated\n    ];\n  },\n\n  Canvas: function* (entity, state, { parent }) {\n    if (parent && parent.type !== 'Manifest' && parent.type !== 'Canvas') {\n      return [['id', entity.id]];\n    }\n\n    return [\n      // Items.\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity, parent)),\n      ['items', yield entity.items],\n      ['annotations', filterEmpty(yield entity.annotations)],\n      ['navPlace', (entity as any).navPlace], // @todo remove when types are updated\n    ];\n  },\n\n  Agent: function* (entity) {\n    return [\n      //\n      ['id', entity.id],\n      ['type', 'Agent'],\n      ['label', entity.label],\n      ...(yield* linkingProperties(entity as any)),\n    ];\n  },\n\n  AnnotationPage: function* (entity) {\n    const entries = Object.entries(entity)\n      .map(([key, item]) => {\n        return [key, Array.isArray(item) ? filterEmpty(item as any) : item];\n      })\n      .filter(([key, value]) => {\n        return key !== 'items' && key !== 'id' && key !== HAS_PART && key !== PART_OF && key !== IS_EXTERNAL;\n      });\n\n    const items = yield entity.items;\n\n    return [\n      // Any more properties?\n      ['id', !entity.id?.startsWith('vault://') ? entity.id : undefined],\n      ...entries,\n      ...(yield* linkingProperties(entity)),\n      ['items', items.length || (entity as any)[IS_EXTERNAL] === false ? items : UNSET],\n    ];\n  },\n\n  Service: function* (entity) {\n    // Are there other properties on a service?\n    return [[UNWRAP, service2compat(entity as any)]];\n  },\n\n  Annotation: function* (entity) {\n    const entries = Object.entries(entity)\n      .map(([key, item]) => {\n        if (key === 'motivation') {\n          // Annotation non-array items can be added here.\n          return [key, Array.isArray(item) ? item[0] : item];\n        }\n\n        if (key === 'target') {\n          return [\n            key,\n            compressSpecificResource(item, { allowString: true, allowSourceString: true, allowedStringType: 'Canvas' }),\n          ];\n        }\n\n        return [key, Array.isArray(item) ? filterEmpty(item as any) : item];\n      })\n      .filter(([key]) => {\n        return key !== 'body' && key !== HAS_PART && key !== IS_EXTERNAL;\n      });\n\n    let resolvedBody: any = undefined;\n\n    if (Array.isArray(entity.body)) {\n      const resolved = [];\n      for (const body of entity.body as any[]) {\n        if (body && isSpecificResource(body)) {\n          const single = {\n            ...(body as any),\n          };\n\n          if (body.source.type !== 'Canvas') {\n            single.source = yield body.source;\n          } else {\n            single.source = body.source;\n          }\n\n          resolved.push(compressSpecificResource(single, { allowSourceString: true }));\n        } else {\n          resolved.push(yield body);\n        }\n      }\n      resolvedBody = resolved;\n    } else {\n      if (entity.body && isSpecificResource(entity.body)) {\n        resolvedBody = {\n          ...(entity.body as any),\n        };\n        resolvedBody.source = yield (entity.body as any).source;\n      } else {\n        resolvedBody = yield entity.body;\n      }\n    }\n\n    // const resolvedBody = yield entity.body;\n\n    return [\n      ...entries,\n      ...(yield* descriptiveProperties(entity as any)),\n      ...(yield* linkingProperties(entity)),\n      ['body', resolvedBody.length === 1 ? resolvedBody[0] : resolvedBody],\n    ];\n  },\n\n  ContentResource: function* (entity: any) {\n    return mergeRemainingProperties(\n      [\n        // Image properties.\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n        ...(yield* linkingProperties(entity)),\n        ['annotations', filterEmpty(yield entity.annotations)],\n        ['items', filterEmpty(yield entity.items)],\n      ],\n      entity\n    );\n  },\n\n  AnnotationCollection: function* (entity) {\n    return [\n      // @todo expand properties if they are actually used.\n      ['id', entity.id],\n      ['type', 'AnnotationCollection'],\n      ['label', entity.label],\n    ];\n  },\n\n  Collection: function* (entity, state, { isTopLevel }) {\n    if (isTopLevel) {\n      let context: any = 'http://iiif.io/api/presentation/3/context.json';\n\n      if (entity.navPlace || itemsHaveNavPlace(entity)) {\n        context = [\n          'http://iiif.io/api/extension/navplace/context.json',\n          'http://iiif.io/api/presentation/3/context.json',\n        ];\n      }\n\n      return [\n        ['@context', context],\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n        ...(yield* linkingProperties(entity)),\n        ['items', filterEmpty(yield entity.items)],\n        ['navPlace', (entity as any).navPlace], // @todo remove when types are updated\n      ];\n    }\n    return [\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ['navPlace', (entity as any).navPlace],\n    ];\n  },\n\n  Range: function* (entity) {\n    const rangeItems = [];\n\n    for (const item of entity.items) {\n      if (item.type === 'Range') {\n        // Resolve the full range\n        rangeItems.push(yield item);\n      } else {\n        // Just push the reference.\n        // @todo could also push in the label of the item?\n        if (item && item.type === 'SpecificResource') {\n          rangeItems.push(compressSpecificResource(item));\n        } else {\n          rangeItems.push(item);\n        }\n      }\n    }\n\n    return [\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', rangeItems],\n      ['annotations', filterEmpty(yield entity.annotations)],\n      ['navPlace', (entity as any).navPlace], // @todo remove when types are updated\n    ];\n  },\n};\n\nfunction mergeRemainingProperties(entries: [string, any][], object: any): [string, any][] {\n  const keys = Object.keys(object);\n  const alreadyParsed = entries.map(([a]) => a);\n\n  for (const key of keys) {\n    if (key === HAS_PART || key === IS_EXTERNAL) {\n      continue;\n    }\n    if (alreadyParsed.indexOf(key) === -1 && typeof object[key] !== 'undefined') {\n      entries.push([key, object[key]]);\n    }\n  }\n  return entries;\n}\n\n\nfunction itemsHaveNavPlace(item: any) {\n  if (!item.items || !Array.isArray(item.items)) {\n    return false;\n  }\n\n  for (const singleItem of item.items) {\n    if (singleItem.navPlace) {\n      return true;\n    }\n  }\n\n  return false;\n}\n"],"mappings":"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"}