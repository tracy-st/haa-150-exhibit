{"version":3,"file":"upgrader-BEInozLY.js","names":["types: TraversableEntityTypes[]","resource: any","traversals: Partial<TraversalMap>","options: Partial<TraverseOptions>","traversal: (resource: any) => any","collection: Collection","seenIds: string[]","manifest: Manifest","sequence: Sequence","canvas: Canvas","range: Range","innerRange: any","canvas: any","annotationList: AnnotationList","annotation: Annotation","layer: Layer","choice: ChoiceEmbeddedContent","service: Service","contentResource: CommonContentResource","item: any","contentResource: OneOrMany<string | ContentResource>","newResourceList: any[]","resource: T","allServices: OneOrMany<any>","object: T | T[]","traversals: Array<Traversal<T>>","object: T","acc: T","traversal: Traversal<T>","inputLangProperty?: unknown","languageArray: Presentation2.LanguageProperty[]","inputLangProperty?: Presentation2.OneOrMany<Presentation2.LanguageProperty>","languageMap: Presentation3.InternationalString","profile: any | any[]","inputContexts: string | string[]","contexts: string[]","inputProfile: string","str: string","resource: any","oldType: string | string[]","profile: any","context: any","license: string","license: Presentation2.RightsProperties['license']","rights: Presentation3.DescriptiveProperties['rights']","metadata: Presentation3.DescriptiveProperties['metadata']","inputContext: string | string[] | undefined","metadata: Presentation2.DescriptiveProperties['metadata']","resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'>","subResource?: string","resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'> & {\n    motivation?: string | string[] | null;\n    format?: string;\n    profile?: any;\n    '@context'?: string | string[] | undefined;\n  }","motivation: string | string[] | undefined","resource: Presentation2.DescriptiveProperties &\n    Presentation2.RightsProperties &\n    Partial<Presentation2.TechnicalProperties>","thumb: any","resource: Presentation2.AbstractResource","returnPartOf: Presentation3.LinkingProperties['partOf']","resource: Presentation2.LinkingProperties & Presentation2.RightsProperties","resource: Presentation2.CharsEmbeddedContent","object: any","type: string","collection: Presentation2.Collection","additionalProperties: any","resources: any[]","manifest: Presentation2.Manifest","structures: Presentation3.Range[]","found: string[]","canvas: Presentation2.Canvas","annotationPage: Presentation2.AnnotationList","sequence: Presentation2.Sequence","annotation: Presentation2.Annotation","target: typeof annotation.on","source: string | Presentation3.Reference<'Canvas'> | Presentation3.Reference<'Image'>","resource: Presentation2.ContentResource | Presentation2.ChoiceEmbeddedContent","inputContentResource: Presentation2.ContentResource","choice: Presentation2.ChoiceEmbeddedContent","range: Presentation2.Range","service: Presentation2.Service","newService: any","layer: Presentation2.Layer","entity: any","selector: Presentation2.ContentResourceSelector"],"sources":["../src/presentation-2/traverse.ts","../src/shared/image-api-profiles.ts","../src/presentation-2/upgrader.ts"],"sourcesContent":["import type {\n  Annotation,\n  AnnotationList,\n  Canvas,\n  ChoiceEmbeddedContent,\n  Collection,\n  CommonContentResource,\n  ContentResource,\n  DescriptiveProperties,\n  Layer,\n  LinkingProperties,\n  Manifest,\n  OneOrMany,\n  Range,\n  RightsProperties,\n  Sequence,\n  Service,\n  TraversableEntityTypes,\n  Traversal,\n  TraversalMap,\n} from '@iiif/presentation-2';\n\nexport const types: TraversableEntityTypes[] = [\n  'sc:Collection',\n  'sc:Manifest',\n  'sc:Canvas',\n  'sc:AnnotationList',\n  'oa:Annotation',\n  'sc:Range',\n  'sc:Layer',\n  'sc:Sequence',\n  'oa:Choice',\n  // Opaque.\n  'Service',\n  'ContentResource',\n];\n\nexport type TraverseOptions = {\n  convertPropsToArray: boolean;\n  mergeMemberProperties: boolean;\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): TraversableEntityTypes {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource['@type'] === 'string') {\n    const hasType = types.indexOf(resource['@type'] as any);\n    if (hasType !== -1) {\n      return types[hasType]!;\n    }\n  }\n\n  if (resource.profile) {\n    return 'Service';\n  }\n\n  if (resource.format) {\n    return 'ContentResource';\n  }\n\n  // Big o'l fallback.\n  if (resource['@type']) {\n    return 'ContentResource';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse<\n  T extends {\n    Collection: any;\n    Manifest: any;\n    Canvas: any;\n    AnnotationList: any;\n    Sequence: any;\n    Annotation: any;\n    ContentResource: any;\n    Choice: any;\n    Range: any;\n    Service: any;\n    Layer: any;\n  } = {\n    Collection: Collection;\n    Manifest: Manifest;\n    Canvas: Canvas;\n    AnnotationList: AnnotationList;\n    Sequence: Sequence;\n    Annotation: Annotation;\n    ContentResource: CommonContentResource;\n    Choice: ChoiceEmbeddedContent;\n    Range: Range;\n    Service: Service;\n    Layer: Layer;\n  },\n> {\n  private traversals: Required<TraversalMap>;\n  private options: TraverseOptions;\n\n  constructor(traversals: Partial<TraversalMap>, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationList: [],\n      sequence: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      layer: [],\n      ...traversals,\n    };\n    this.options = {\n      convertPropsToArray: true,\n      mergeMemberProperties: true,\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationList: [traversal],\n      sequence: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n      layer: [traversal],\n    });\n  }\n\n  traverseCollection(collection: Collection): T['Collection'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(collection))),\n      this.traversals.collection\n    );\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(collection.manifests || []).map((manifest) => {\n          if (typeof manifest === 'string') {\n            return { '@id': manifest, '@type': 'sc:Manifest' };\n          }\n          return manifest;\n        }),\n        ...(collection.collections || []).map((subCollection) => {\n          if (typeof subCollection === 'string') {\n            return { '@id': subCollection, '@type': 'sc:Collection' };\n          }\n          return subCollection;\n        }),\n        ...(collection.members || []),\n      ];\n\n      const seenIds: string[] = [];\n      const filteredMembers = members.filter((resource) => {\n        if (seenIds.includes(resource['@id'])) {\n          return false;\n        }\n        seenIds.push(resource['@id']);\n        return true;\n      });\n\n      delete collection.collections;\n      delete collection.manifests;\n      collection.members = filteredMembers;\n    }\n\n    if (collection.manifests) {\n      collection.manifests = collection.manifests.map((manifest) =>\n        this.traverseManifest(\n          typeof manifest === 'string'\n            ? ({ '@id': manifest, '@type': 'sc:Manifest' } as Manifest)\n            : (manifest as Manifest)\n        )\n      );\n    }\n\n    if (collection.collections) {\n      collection.collections = collection.collections.map((subCollection) =>\n        this.traverseCollection(\n          typeof subCollection === 'string'\n            ? ({ '@id': subCollection, '@type': 'sc:Collection' } as Collection)\n            : (subCollection as Collection)\n        )\n      );\n    }\n\n    if (collection.members) {\n      collection.members = collection.members.map((member) => {\n        if (typeof member === 'string') {\n          return member;\n        }\n        if (member['@type'] === 'sc:Collection') {\n          return this.traverseCollection(member);\n        }\n        if (member['@type'] === 'sc:Manifest') {\n          return this.traverseManifest(member as any);\n        }\n        return this.traverseUnknown(member);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseManifest(manifest: Manifest): T['Manifest'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest))),\n      this.traversals.manifest\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.sequences) {\n      manifest.sequences = manifest.sequences.map((sequence) => this.traverseSequence(sequence));\n    }\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((structure) => this.traverseRange(structure));\n    }\n    return manifest;\n  }\n\n  traverseSequence(sequence: Sequence): T['Sequence'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(sequence))),\n      this.traversals.sequence\n    );\n  }\n\n  traverseSequenceItems(sequence: Sequence): Sequence {\n    if (sequence.canvases) {\n      sequence.canvases = sequence.canvases.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return sequence;\n  }\n\n  traverseCanvas(canvas: Canvas): T['Canvas'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))),\n      this.traversals.canvas\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    if (canvas.images) {\n      canvas.images = canvas.images.map((image) => this.traverseAnnotation(image));\n    }\n    if (canvas.otherContent) {\n      canvas.otherContent = canvas.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return canvas;\n  }\n\n  traverseRange(range: Range): T['Range'] {\n    if (range['@type'] !== 'sc:Range') {\n      range['@type'] = 'sc:Range';\n    }\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(range))),\n      this.traversals.range\n    );\n  }\n\n  traverseRangeItems(range: Range): Range {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(range.ranges || []).map((innerRange: any) => {\n          if (typeof innerRange === 'string') {\n            return { '@id': innerRange, '@type': 'sc:Range' };\n          }\n          return innerRange;\n        }),\n        ...(range.canvases || []).map((canvas: any) => {\n          if (typeof canvas === 'string') {\n            return { '@id': canvas, '@type': 'sc:Canvas' };\n          }\n          return canvas;\n        }),\n        ...(range.members || []),\n      ];\n\n      delete range.ranges;\n      delete range.canvases;\n      range.members = members.length\n        ? members.map((member) => {\n            // Enable if seen.\n            // if (\n            //   member.type === 'sc:Canvas' &&\n            //   (('canvases' in member && member.canvases?.length) ||\n            //     ('ranges' in member && member.ranges?.length) ||\n            //     ('members' in member && member.members?.length))\n            // ) {\n            //   // This is likely a Range, not a canvas.\n            //   member['@type'] = 'sc:Range';\n            // }\n\n            return this.traverseUnknown(member);\n          })\n        : undefined;\n    }\n    return range;\n  }\n\n  traverseAnnotationList(annotationList: AnnotationList): T['AnnotationList'] {\n    const list =\n      typeof annotationList === 'string'\n        ? ({ '@id': annotationList, '@type': 'sc:AnnotationList' } as any)\n        : annotationList;\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseAnnotationListItems(list)),\n      this.traversals.annotationList\n    );\n  }\n\n  traverseAnnotationListItems(annotationList: AnnotationList): AnnotationList {\n    if (annotationList.resources) {\n      annotationList.resources = annotationList.resources.map((annotation) => this.traverseAnnotation(annotation));\n    }\n\n    return annotationList;\n  }\n\n  traverseAnnotation(annotation: Annotation): T['Annotation'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(annotation))),\n      this.traversals.annotation\n    );\n  }\n\n  traverseAnnotationItems(annotation: Annotation): Annotation {\n    if (annotation.resource) {\n      if (Array.isArray(annotation.resource)) {\n        annotation.resource = annotation.resource.map((res) =>\n          this.traverseContentResource(res as CommonContentResource)\n        );\n      } else {\n        annotation.resource = this.traverseContentResource(annotation.resource as CommonContentResource);\n      }\n    }\n\n    if (annotation.on) {\n      // selector - just traverse the annotations.\n      // annotation.on = this.traverseSelector(annotation.on);\n    }\n\n    return annotation;\n  }\n\n  traverseLayer(layer: Layer): T['Layer'] {\n    return this.traverseType(this.traverseLinking(this.traverseLayerItems(layer)), this.traversals.layer);\n  }\n\n  traverseLayerItems(layer: Layer): Layer {\n    if (layer.otherContent) {\n      layer.otherContent = layer.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return layer;\n  }\n\n  traverseChoice(choice: ChoiceEmbeddedContent): T['Choice'] {\n    return this.traverseType(this.traverseChoiceItems(choice), this.traversals.choice);\n  }\n\n  traverseChoiceItems(choice: ChoiceEmbeddedContent) {\n    if (choice.default && choice.default !== 'rdf:nil') {\n      choice.default = this.traverseContentResource(choice.default);\n    }\n    if (choice.item && choice.item !== 'rdf:nil') {\n      choice.item = choice.item.map((item) => this.traverseContentResource(item));\n    }\n\n    return choice;\n  }\n\n  traverseService(service: Service): T['Service'] {\n    return this.traverseType(this.traverseLinking(service as any), this.traversals.service);\n  }\n\n  traverseContentResource(contentResource: CommonContentResource): T['ContentResource'] {\n    if (contentResource['@type'] === 'oa:Choice') {\n      return this.traverseChoice(contentResource as any);\n    }\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(contentResource as any)),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseUnknown(item: any) {\n    if (!item['@type'] || typeof item === 'string') {\n      // Unknown item.\n      return item;\n    }\n    switch (identifyResource(item)) {\n      case 'sc:Collection':\n        return this.traverseCollection(item);\n      case 'sc:Manifest':\n        return this.traverseManifest(item);\n      case 'sc:Canvas':\n        return this.traverseCanvas(item);\n      case 'sc:Sequence':\n        return this.traverseSequence(item);\n      case 'sc:Range':\n        return this.traverseRange(item);\n      case 'oa:Annotation':\n        return this.traverseAnnotation(item);\n      case 'sc:AnnotationList':\n        return this.traverseAnnotationList(item);\n      case 'sc:Layer':\n        return this.traverseLayer(item);\n      case 'Service':\n        return this.traverseService(item);\n      case 'oa:Choice':\n        return this.traverseChoice(item);\n      case 'ContentResource':\n        return this.traverseContentResource(item);\n    }\n\n    if (item.profile) {\n      return this.traverseService(item);\n    }\n\n    return item;\n  }\n\n  traverseImageResource(contentResource: OneOrMany<string | ContentResource>) {\n    const wasArray = Array.isArray(contentResource);\n    const resourceList = Array.isArray(contentResource) ? contentResource : [contentResource];\n    const newResourceList: any[] = [];\n\n    for (const singleResource of resourceList) {\n      if (typeof singleResource === 'string') {\n        newResourceList.push(\n          this.traverseContentResource({\n            '@id': singleResource,\n            '@type': 'dctypes:Image',\n          })\n        );\n      } else {\n        newResourceList.push(this.traverseContentResource(singleResource as any));\n      }\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newResourceList[0];\n    }\n\n    return newResourceList;\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties & RightsProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = this.traverseImageResource(resource.thumbnail);\n    }\n\n    if (resource.logo) {\n      resource.logo = this.traverseImageResource(resource.logo);\n    }\n\n    return resource;\n  }\n\n  traverseOneOrMoreServices(allServices: OneOrMany<any>) {\n    const wasArray = Array.isArray(allServices);\n    const services = Array.isArray(allServices) ? allServices : [allServices];\n    const newServices = [];\n    for (const service of services) {\n      newServices.push(this.traverseService(service));\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newServices[0];\n    }\n\n    return newServices;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.related) {\n      resource.related = this.traverseOneOrManyType(resource.related, this.traversals.contentResource);\n    }\n    if (resource.rendering) {\n      resource.rendering = this.traverseOneOrManyType(resource.rendering, this.traversals.contentResource);\n    }\n    if (resource.service) {\n      resource.service = this.traverseOneOrMoreServices(resource.service);\n    }\n    if (resource.seeAlso) {\n      resource.seeAlso = this.traverseOneOrManyType(resource.seeAlso, this.traversals.contentResource);\n    }\n    if (resource.within) {\n      if (typeof resource.within === 'string') {\n        // I don't know. skip?\n      } else {\n        resource.within = this.traverseOneOrManyType(\n          resource.within as CommonContentResource,\n          this.traversals.contentResource\n        );\n      }\n    }\n    if (resource.startCanvas) {\n      if (typeof resource.startCanvas === 'string') {\n        resource.startCanvas = this.traverseType(\n          { '@id': resource.startCanvas, '@type': 'sc:Canvas' } as Canvas,\n          this.traversals.canvas\n        );\n      } else if (resource.startCanvas) {\n        this.traverseType(resource.startCanvas as any, this.traversals.canvas);\n      }\n    }\n    if (resource.contentLayer) {\n      if (typeof resource.contentLayer === 'string') {\n        resource.contentLayer = this.traverseLayer({\n          '@id': resource.contentLayer,\n          '@type': 'sc:Layer',\n        });\n      } else {\n        resource.contentLayer = this.traverseLayer(resource.contentLayer);\n      }\n    }\n    return resource;\n  }\n\n  traverseOneOrManyType<T, Return = T>(object: T | T[], traversals: Array<Traversal<T>>): Return {\n    if (!Array.isArray(object)) {\n      if (this.options.convertPropsToArray) {\n        object = [object] as T[];\n      } else {\n        return this.traverseType(object, traversals);\n      }\n    }\n    return object.map((singleObj) => this.traverseType(singleObj, traversals)) as any;\n  }\n\n  traverseType<T, Return = T>(object: T, traversals: Array<Traversal<T>>): Return {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object) as any;\n  }\n}\n","export const STANFORD_IIIF_IMAGE_COMPLIANCE_0 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level0';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_1 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level1';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_2 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level2';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_0 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level0';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_1 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level1';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_2 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2';\nexport const IIIF_1_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/1/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/1/profiles/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/1/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/1/profiles/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/1/level2.json';\nexport const IIIF_1_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/1/profiles/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/2/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/2/profiles/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/2/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/2/profiles/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/2/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/2/profiles/level2.json';\nexport const IIIF_3_IMAGE_LEVEL_0 = 'level0';\nexport const IIIF_3_IMAGE_LEVEL_1 = 'level1';\nexport const IIIF_3_IMAGE_LEVEL_2 = 'level2';\n\n// Non-standard\nexport const IIIF_2_IMAGE_LEVEL_0_NO_JSON = 'http://iiif.io/api/image/2/level0';\nexport const IIIF_2_IMAGE_LEVEL_1_NO_JSON = 'http://iiif.io/api/image/2/level1';\nexport const IIIF_2_IMAGE_LEVEL_2_NO_JSON = 'http://iiif.io/api/image/2/level2';\n\nexport const level1Support = [\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n\nexport const imageServiceProfiles = [\n  IIIF_2_IMAGE_LEVEL_0_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_0,\n  IIIF_1_IMAGE_LEVEL_0_PROFILE,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_0,\n  IIIF_2_IMAGE_LEVEL_0_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_0,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n","import * as Presentation3 from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\nimport { imageServiceProfiles, level1Support } from '../shared/image-api-profiles';\nimport { Traverse } from './traverse';\nimport { ensureArray } from '../shared/ensure-array';\nimport { removeUndefinedProperties } from '../shared/remove-undefined-properties';\nimport { level0Support, level2Support } from '../image-3/profiles/profiles';\n\nconst configuration = {\n  attributionLabel: 'Attribution',\n  lang: 'none',\n  providerId: 'http://example.org/provider',\n  providerName: '',\n};\n\nfunction compatLanguageMap(inputLangProperty?: unknown): Array<Presentation2.LanguageProperty> {\n  if (typeof inputLangProperty === 'string') {\n    return [inputLangProperty];\n  }\n  if (!inputLangProperty) {\n    return [];\n  }\n  const arrayOfValues = Array.isArray(inputLangProperty) ? inputLangProperty : [inputLangProperty];\n\n  const languageArray: Presentation2.LanguageProperty[] = [];\n  for (const language of arrayOfValues) {\n    if (typeof language === 'string') {\n      languageArray.push(language);\n      continue;\n    }\n    languageArray.push({\n      '@language': language['@language'] || language.language,\n      '@value': language['@value'] || language.value,\n    });\n  }\n  return languageArray;\n}\n\nexport function convertLanguageMapping(\n  inputLangProperty?: Presentation2.OneOrMany<Presentation2.LanguageProperty>,\n  defaultLang = 'none'\n): Presentation3.InternationalString {\n  if (!inputLangProperty) {\n    return { none: [''] };\n  }\n\n  const arrayOfValues = compatLanguageMap(inputLangProperty);\n\n  const languageMap: Presentation3.InternationalString = {};\n\n  for (const language of arrayOfValues) {\n    // For strings \"label\": [\"a value\"]\n    if (typeof language === 'string') {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language || '');\n      continue;\n    }\n\n    // For maps without a language\n    if (!language['@language']) {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language['@value'] || '');\n      continue;\n    }\n\n    // Default case with language.\n    const lang = language['@language'];\n    languageMap[lang] = languageMap[lang] ? languageMap[lang] : [];\n    (languageMap[lang] as string[]).push(language['@value'] || '');\n  }\n\n  if (Object.keys(languageMap).length === 0) {\n    return { none: [''] };\n  }\n\n  return languageMap;\n}\n\nexport function getProfile(profile: any | any[]): string | undefined {\n  if (Array.isArray(profile)) {\n    return getProfile(profile.find((s) => typeof s === 'string'));\n  }\n\n  if (level2Support.indexOf(profile) !== -1) {\n    return 'level2';\n  }\n\n  if (level1Support.indexOf(profile) !== -1) {\n    return 'level1';\n  }\n\n  if (level0Support.indexOf(profile) !== -1) {\n    return 'level0';\n  }\n\n  if (typeof profile !== 'string') {\n    return undefined;\n  }\n\n  return profile;\n}\n\nexport function getTypeFromContext(inputContexts: string | string[]): string | undefined {\n  const contexts: string[] = Array.isArray(inputContexts) ? inputContexts : [inputContexts];\n\n  for (const context of contexts) {\n    switch (context) {\n      case 'http://iiif.io/api/image/2/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2':\n        return 'ImageService2';\n      case 'http://iiif.io/api/image/1/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/context.json':\n        return 'ImageService1';\n      case 'http://iiif.io/api/annex/openannotation/context.json':\n        return 'ImageApiSelector';\n    }\n  }\n\n  return undefined;\n}\n\nfunction getTypeFromProfile(inputProfile: string): string | undefined {\n  switch (inputProfile) {\n    case 'http://iiif.io/api/image/2/level0.json':\n    case 'http://iiif.io/api/image/2/level1.json':\n    case 'http://iiif.io/api/image/2/level2.json':\n      return 'ImageService2';\n\n    case 'http://iiif.io/api/auth/1/kiosk':\n    case 'http://iiif.io/api/auth/1/login':\n    case 'http://iiif.io/api/auth/1/clickthrough':\n    case 'http://iiif.io/api/auth/1/external':\n    case 'http://iiif.io/api/auth/0/kiosk':\n    case 'http://iiif.io/api/auth/0/login':\n    case 'http://iiif.io/api/auth/0/clickthrough':\n    case 'http://iiif.io/api/auth/0/external':\n      return 'AuthCookieService1';\n\n    case 'http://iiif.io/api/auth/1/token':\n    case 'http://iiif.io/api/auth/0/token':\n      return 'AuthTokenService1';\n    case 'http://iiif.io/api/auth/1/logout':\n    case 'http://iiif.io/api/auth/0/logout':\n      return 'AuthLogoutService1';\n\n    case 'http://iiif.io/api/search/1/search':\n    case 'http://iiif.io/api/search/0/search':\n      return 'SearchService1';\n    case 'http://iiif.io/api/search/1/autocomplete':\n    case 'http://iiif.io/api/search/0/autocomplete':\n      return 'AutoCompleteService1';\n  }\n\n  return undefined;\n}\n\nfunction removePrefix(str: string) {\n  for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n    if (str.startsWith(`${prefix}:`)) {\n      return str.slice(prefix.length + 1);\n    }\n  }\n\n  return str;\n}\n\nconst knownTypes = ['Collection', 'Manifest', 'Annotation', 'AnnotationPage', 'Range', 'Service'];\n\nfunction getNewType(resource: any): string {\n  const id = resource['@id'] || resource.id;\n  let oldType: string | string[] = resource['@type'] || resource.type;\n  const profile: any = resource.profile || undefined;\n  const context: any = resource['@context'] || undefined;\n\n  if (profile) {\n    const possibleType = getTypeFromProfile(profile);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (context) {\n    const possibleType = getTypeFromContext(context);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (oldType) {\n    if (Array.isArray(oldType)) {\n      if (oldType.indexOf('oa:CssStylesheet') !== -1) {\n        return 'CssStylesheet';\n      }\n      if (oldType.indexOf('cnt:ContentAsText') !== -1) {\n        return 'TextualBody';\n      }\n      // Nothing we can do?\n      oldType = oldType[0]!;\n    }\n\n    for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n      if (oldType.startsWith(`${prefix}:`)) {\n        oldType = oldType.slice(prefix.length + 1);\n        break;\n      }\n    }\n\n    switch (oldType) {\n      case 'Layer':\n        return 'AnnotationCollection';\n      case 'AnnotationList':\n        return 'AnnotationPage';\n      case 'cnt:ContentAsText':\n        return 'TextualBody';\n      // @todo There are definitely some missing annotation types here.\n    }\n  }\n\n  if (oldType && knownTypes.indexOf(oldType) !== -1) {\n    return oldType;\n  }\n\n  if (resource.format) {\n    if (resource.format.startsWith('image/')) {\n      return 'Image';\n    }\n    if (resource.format.startsWith('text/')) {\n      return 'Text';\n    }\n    if (resource.format === 'application/pdf') {\n      return 'Text';\n    }\n    if (resource.format.startsWith('application/')) {\n      return 'Dataset';\n    }\n  }\n\n  if (id && (id.endsWith('.jpg') || id.endsWith('.png') || id.endsWith('.jpeg'))) {\n    return 'Image';\n  }\n\n  if (!oldType) {\n    return 'unknown';\n  }\n\n  // Again, nothing we can do.\n  return oldType as string;\n}\n\nconst licenseRegex = /http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;\n\nfunction extractLicense(license: string) {\n  const matches = license.match(licenseRegex);\n  if (matches) {\n    return matches[0];\n  }\n\n  return license;\n}\n\nasync function getContentTypeOfRemoteResource(resourceId: string): Promise<string | undefined> {\n  try {\n    const response = await fetch(resourceId, { method: 'HEAD' });\n    const headers = response.headers;\n\n    return headers.get('content-type') || undefined;\n  } catch (e) {\n    // do nothing.\n  }\n\n  return undefined;\n}\n\nfunction fixLicense(\n  license: Presentation2.RightsProperties['license'],\n  licenseLabel = 'Rights/License',\n  lang = 'none'\n): [Presentation3.DescriptiveProperties['rights'], Presentation3.DescriptiveProperties['metadata']] {\n  let rights: Presentation3.DescriptiveProperties['rights'] = null;\n  const metadata: Presentation3.DescriptiveProperties['metadata'] = [];\n\n  const licenseList = Array.isArray(license) ? license : [license];\n\n  for (const rawLicense of licenseList) {\n    const singleLicense = rawLicense ? extractLicense(rawLicense) : undefined;\n\n    if (\n      singleLicense &&\n      (singleLicense.indexOf('creativecommons.org') !== -1 || singleLicense.indexOf('rightsstatements.org') !== -1)\n    ) {\n      if (singleLicense.startsWith('https://')) {\n        rights = `http://${singleLicense.slice(8)}`;\n      } else {\n        rights = singleLicense;\n      }\n      continue;\n    }\n    if (singleLicense) {\n      metadata.push({\n        label: { [lang]: [licenseLabel] },\n        value: { [lang]: [singleLicense] },\n      });\n    }\n  }\n\n  return [rights, metadata];\n}\n\nconst removeContexts = [\n  'http://iiif.io/api/presentation/2/context.json',\n  'http://iiif.io/api/image/2/context.json',\n  'http://iiif.io/api/image/1/context.json',\n  'http://library.stanford.edu/iiif/image-api/1.1/context.json',\n  'http://iiif.io/api/search/1/context.json',\n  'http://iiif.io/api/search/0/context.json',\n  'http://iiif.io/api/auth/1/context.json',\n  'http://iiif.io/api/auth/0/context.json',\n  'http://iiif.io/api/annex/openannotation/context.json',\n];\n\nfunction fixContext(inputContext: string | string[] | undefined): string | string[] | undefined {\n  if (inputContext) {\n    const contexts = Array.isArray(inputContext) ? inputContext : [inputContext];\n\n    const newContexts = [];\n    for (const context of contexts) {\n      if (context === 'http://iiif.io/api/presentation/2/context.json') {\n        newContexts.push('http://iiif.io/api/presentation/3/context.json');\n      }\n      if (removeContexts.indexOf(context) !== -1) {\n        continue;\n      }\n      newContexts.push(context);\n    }\n\n    if (contexts.length) {\n      return newContexts.length === 1 ? newContexts[0] : newContexts;\n    }\n  }\n\n  return undefined;\n}\n\nfunction convertMetadata(\n  metadata: Presentation2.DescriptiveProperties['metadata']\n): Presentation3.DescriptiveProperties['metadata'] {\n  if (!metadata) {\n    return [];\n  }\n\n  return metadata.map((item): Presentation3.MetadataItem => {\n    return {\n      label: convertLanguageMapping(item.label),\n      value: convertLanguageMapping(item.value),\n    };\n  });\n}\n\nlet mintedIdCounter = 0;\n\nfunction mintNewIdFromResource(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'>,\n  subResource?: string\n) {\n  const origId = encodeURI((resource as { id?: string }).id || resource['@id'] || '').trim();\n\n  if (origId && subResource) {\n    return `${origId}/${subResource}`;\n  }\n\n  if (origId) {\n    return origId;\n  }\n\n  mintedIdCounter++;\n\n  // @todo.\n  return `http://example.org/${resource['@type']}${subResource ? `/${subResource}` : ''}/${mintedIdCounter}`;\n}\n\n// @todo this was removed due to identifiers not being able to be used externally after upgrading.\nfunction resolveDecodedURI(uri: string) {\n  return encodeURI(decodeURIComponent(uri)).trim();\n}\n\nfunction technicalProperties<T extends Partial<Presentation3.TechnicalProperties>>(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'> & {\n    motivation?: string | string[] | null;\n    format?: string;\n    profile?: any;\n    '@context'?: string | string[] | undefined;\n  }\n) {\n  const allBehaviors = [...(resource.behavior || [])];\n\n  if (resource.viewingHint) {\n    allBehaviors.push(resource.viewingHint);\n  }\n\n  let motivation: string | string[] | undefined;\n  if (Array.isArray(resource.motivation)) {\n    motivation = resource.motivation.map(removePrefix);\n  } else if (resource.motivation) {\n    motivation = removePrefix(resource.motivation);\n  }\n\n  return {\n    '@context': resource['@context'] ? fixContext(resource['@context']) : undefined,\n    id: (resource['@id'] || mintNewIdFromResource(resource)).trim(),\n    type: getNewType(resource) as any,\n    behavior: allBehaviors.length ? allBehaviors : undefined,\n    // format: This will be an optional async post-process step.\n    height: resource.height ? resource.height : undefined,\n    width: resource.width ? resource.width : undefined,\n    motivation,\n    viewingDirection: resource.viewingDirection,\n    profile: resource.profile,\n    format: resource.format ? resource.format : undefined,\n    duration: undefined,\n    timeMode: undefined,\n  } as any;\n}\n\nfunction descriptiveProperties<T extends Partial<Presentation3.DescriptiveProperties>>(\n  resource: Presentation2.DescriptiveProperties &\n    Presentation2.RightsProperties &\n    Partial<Presentation2.TechnicalProperties>\n): T {\n  const [rights, extraMetadata] = fixLicense(resource.license);\n  const allMetadata = [...(resource.metadata ? convertMetadata(resource.metadata) : []), ...extraMetadata];\n\n  return {\n    rights,\n    metadata: allMetadata.length ? allMetadata : undefined,\n    label: resource.label ? convertLanguageMapping(resource.label) : undefined,\n    requiredStatement: resource.attribution\n      ? {\n        label: convertLanguageMapping(configuration.attributionLabel),\n        value: convertLanguageMapping(resource.attribution),\n      }\n      : undefined,\n    navDate: resource.navDate,\n    summary: resource.description ? convertLanguageMapping(resource.description) : undefined,\n    thumbnail: compatThumbnail(resource.thumbnail as any),\n  } as T;\n}\n\nfunction compatThumbnail(thumb: any) {\n  if (thumb) {\n    const arrayOfThumbs = Array.isArray(thumb) ? thumb : [thumb];\n    return arrayOfThumbs.map((t) => {\n      if (typeof t === 'string') {\n        return { id: t, type: 'Image' };\n      }\n      if (t.type === 'unknown') {\n        t.type = 'Image';\n      }\n      return t;\n    });\n  }\n  return thumb;\n}\n\nfunction parseWithin(resource: Presentation2.AbstractResource): undefined | Presentation3.LinkingProperties['partOf'] {\n  if (!resource.within) {\n    return undefined;\n  }\n\n  const withinProperties = Array.isArray(resource.within) ? resource.within : [resource.within];\n  const returnPartOf: Presentation3.LinkingProperties['partOf'] = [];\n\n  for (const within of withinProperties) {\n    if (typeof within === 'string') {\n      if (within) {\n        switch (resource['@type']) {\n          case 'sc:Manifest':\n            returnPartOf.push({ id: within, type: 'Collection' });\n            break;\n          // @todo are there more cases?\n        }\n      }\n    } else if ((within as any)['@id']) {\n      returnPartOf.push({\n        id: (within as any)['@id'], // as any since content resources don't require an `@id`\n        type: getNewType(within) as any,\n      });\n    } else {\n      // Content resource.\n    }\n  }\n\n  return returnPartOf.length ? returnPartOf : undefined;\n}\n\nfunction linkingProperties(resource: Presentation2.LinkingProperties & Presentation2.RightsProperties) {\n  // @todo related links to metadata.\n\n  const related = resource.related ? (Array.isArray(resource.related) ? resource.related : [resource.related]) : [];\n  const layer = resource.contentLayer as Presentation2.Layer;\n\n\n  return {\n    provider:\n      resource.logo || related.length\n        ? [\n          {\n            id: configuration.providerId,\n            type: 'Agent' as const,\n            homepage: related.length ? [related[0] as any] : undefined,\n            logo: resource.logo ? (Array.isArray(resource.logo) ? resource.logo : [resource.logo]) : undefined,\n            label: convertLanguageMapping(configuration.providerName),\n          },\n        ]\n        : undefined,\n    partOf: parseWithin(resource),\n    rendering: resource.rendering,\n    seeAlso: resource.seeAlso,\n    start: resource.startCanvas as any,\n    service: resource.service ? ensureArray(resource.service as any) : undefined,\n    supplementary: layer ? [layer as any] : undefined,\n  };\n}\n\n// FIXME: Is this function really needed?\nfunction embeddedContentProperties(resource: Presentation2.CharsEmbeddedContent) {\n  return {\n    chars: resource.chars,\n    format: resource.format ? resource.format : undefined,\n    language: resource.language,\n  };\n}\n\nfunction stringOrRefToRef(object: any, type: string) {\n  if (!object) return null;\n  if (typeof object === 'string') {\n    return {\n      id: object,\n      type,\n    };\n  }\n\n  if (typeof object?.['@id'] === 'string') {\n    return {\n      id: object['@id'],\n      type,\n    };\n  }\n\n  if (typeof object.id === 'string') {\n    return {\n      id: object.id,\n      type,\n    };\n  }\n\n  return null;\n}\n\nfunction paginationProperties(collection: Presentation2.Collection) {\n  // This is a sort of \"IIIF Presentation 3.1\" upgrade before 4.0 adds Collections and CollectionPages.\n  // v2 supports paged Collections, so this is a stop-gap solution. Strict implementations can ignore it.\n  // Properties:\n  //  - first\n  //  - total\n  //  - prev\n  //  - next\n  const additionalProperties: any = {};\n\n  if ((collection as any).first) {\n    // Note: This is a stop-gap solution for \"v3.1\", which does not have CollectionPages.\n    const ref = stringOrRefToRef((collection as any).first, 'Collection');\n    if (ref) {\n      additionalProperties.first = ref;\n    }\n  }\n\n  if ((collection as any).total || (collection as any).total === 0) {\n    additionalProperties.total = (collection as any).total;\n  }\n\n  if ((collection as any).prev) {\n    const ref = stringOrRefToRef((collection as any).prev, 'Collection');\n    if (ref) {\n      additionalProperties.prev = ref;\n    }\n  }\n\n  if ((collection as any).next) {\n    const ref = stringOrRefToRef((collection as any).next, 'Collection');\n    if (ref) {\n      additionalProperties.next = ref;\n    }\n  }\n\n  return additionalProperties as any;\n}\n\nfunction removeEmptyItems(resources: any[]) {\n  const toReturn = [];\n  for (const originalResource of resources) {\n    const resource = {...originalResource};\n    if (resource.items && resource.items.length === 0) {\n      delete resource.items;\n    }\n    toReturn.push(resource);\n  }\n  return toReturn;\n}\n\nfunction upgradeCollection(collection: Presentation2.Collection): Presentation3.Collection {\n  return removeUndefinedProperties({\n    ...technicalProperties(collection),\n    ...descriptiveProperties<Presentation3.SomeRequired<Presentation3.CollectionDescriptive, 'label'>>(collection),\n    ...linkingProperties(collection),\n    ...paginationProperties(collection),\n    items: removeEmptyItems(collection.members as any),\n  });\n}\n\nfunction flattenArray<T>(array: T[][]): T[] {\n  const returnArr: T[] = [];\n  for (const arr of array || []) {\n    returnArr.push(...arr);\n  }\n  return returnArr;\n}\n\nfunction upgradeManifest(manifest: Presentation2.Manifest): Presentation3.Manifest {\n  const allCanvases = [];\n  const behavior = [];\n  let start = undefined;\n  let viewingDirection = undefined;\n  for (const sequence of manifest.sequences || []) {\n    if (sequence.canvases.length) {\n      allCanvases.push(...sequence.canvases);\n    }\n    if (sequence.behavior) {\n      behavior.push(...sequence.behavior);\n    }\n    if (sequence.viewingDirection) {\n      viewingDirection = sequence.viewingDirection;\n    }\n    if (sequence.startCanvas) {\n      start = sequence.startCanvas;\n    }\n  }\n\n  // This comes from the sequence.\n  const technical = technicalProperties(manifest);\n  if (behavior.length) {\n    if (technical.behavior) {\n      technical.behavior.push(...behavior);\n    } else {\n      technical.behavior = behavior;\n    }\n  }\n\n  return removeUndefinedProperties({\n    ...technical,\n    ...descriptiveProperties(manifest),\n    ...linkingProperties(manifest),\n    viewingDirection,\n    start: start,\n    items: allCanvases,\n    structures: flattenStructures(manifest.structures as any),\n  });\n}\n\nfunction flattenStructures(structures: Presentation3.Range[]): Presentation3.Range[] {\n  if (!structures) {\n    return structures;\n  }\n  const ranges = new Map<string, Presentation3.Range>();\n  for (const range of structures) {\n    ranges.set(range.id, range);\n  }\n\n  let found: string[] = [];\n\n  for (const range of structures) {\n    if (range.items) {\n      const items = range.items.map((item) => {\n        if (typeof item === 'string') {\n          found.push(item);\n          return ranges.get(item) || item;\n        }\n        if (item && item.id) {\n          found.push(item.id);\n          return ranges.get(item.id) || item;\n        }\n        return item;\n      });\n      range.items = items;\n    }\n  }\n\n  return structures.filter((range) => found.indexOf(range.id) === -1);\n}\n\nfunction upgradeCanvas(canvas: Presentation2.Canvas): Presentation3.Canvas {\n  return removeUndefinedProperties({\n    ...technicalProperties(canvas),\n    ...descriptiveProperties(canvas),\n    ...linkingProperties(canvas),\n    annotations: canvas.otherContent && canvas.otherContent.length ? (canvas.otherContent as any[]) : undefined,\n    items:\n      canvas.images && canvas.images.length\n        ? [\n          {\n            id: mintNewIdFromResource(canvas, 'annotation-page'),\n            type: 'AnnotationPage',\n            items: canvas.images as any,\n          },\n        ]\n        : undefined,\n  });\n}\n\nfunction upgradeAnnotationList(annotationPage: Presentation2.AnnotationList): Presentation3.AnnotationPage {\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotationPage) as any),\n    ...(descriptiveProperties(annotationPage) as any),\n    ...(linkingProperties(annotationPage) as any),\n    items: annotationPage.resources && annotationPage.resources.length ? (annotationPage.resources as any) : undefined,\n  });\n}\n\nfunction upgradeSequence(sequence: Presentation2.Sequence): {\n  canvases: Presentation3.Canvas[];\n  behavior?: string[];\n  startCanvas?: Presentation3.Reference<'Canvas'> | undefined;\n  viewingDirection?: 'left-to-right' | 'right-to-left' | 'top-to-bottom' | 'bottom-to-top';\n} {\n  /*\n    rng = {\"id\": s.get('@id', self.mint_uri()), \"type\": \"Range\"}\n    rng['behavior'] = ['sequence']\n    rng['items'] = []\n    for c in s['canvases']:\n      if type(c) == dict:\n        rng['items'].append({\"id\": c['@id'], \"type\": \"Canvas\"})\n      elif type(c) in STR_TYPES:\n        rng['items'].append({\"id\": c, \"type\": \"Canvas\"})\n    # Copy other properties and hand off to _generic\n    del s['canvases']\n    for k in s.keys():\n      if not k in ['@id', '@type']:\n        rng[k] = s[k]\n    self.process_generic(rng)\n    what['_structures'].append(rng)\n   */\n\n  if (!sequence.canvases || sequence.canvases.length === 0) {\n    return {\n      canvases: [],\n      behavior: [],\n    };\n  }\n  // @todo possibly return some ranges too.\n  return {\n    canvases: sequence.canvases as any[],\n    behavior: sequence.viewingHint ? [sequence.viewingHint] : [],\n    viewingDirection: sequence.viewingDirection,\n    startCanvas: sequence.startCanvas as any,\n  };\n}\n\nfunction upgradeAnnotation(annotation: Presentation2.Annotation): Presentation3.Annotation {\n  function upgradeTarget(target: typeof annotation.on): Presentation3.AnnotationTarget {\n    if (Array.isArray(target)) {\n      if (target.length > 1) {\n        return { type: 'List', items: target.map(upgradeTarget) as Presentation3.Target[] };\n      }\n      target = target[0]!;\n    }\n    if (typeof target === 'string') {\n      return encodeURI(target).trim();\n    } else if ('@type' in target) {\n      let source: string | Presentation3.Reference<'Canvas'> | Presentation3.Reference<'Image'>;\n      if (typeof target.full === 'string') {\n        source = target.full;\n      } else if (target.full['@type'] === 'dctypes:Image') {\n        source = { id: target.full['@id'], type: 'Image' };\n      } else if (target.full['@type'] === 'sc:Canvas') {\n        source = { id: target.full['@id'], type: 'Canvas' };\n      } else {\n        throw new Error(`Unsupported source type on annotation: ${target.full['@type']}`);\n      }\n      return {\n        type: 'SpecificResource',\n        source,\n        selector: upgradeSelector(target.selector),\n      };\n    } else {\n      return encodeURI(target['@id']).trim();\n    }\n  }\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotation) as any),\n    ...(descriptiveProperties(annotation) as any),\n    ...(linkingProperties(annotation) as any),\n    target: upgradeTarget(annotation.on),\n    body: Array.isArray(annotation.resource)\n      ? annotation.resource.map(upgradeContentResourceOrChoice)\n      : upgradeContentResourceOrChoice(annotation.resource),\n    // @todo stylesheet upgrade.\n  });\n}\n\nfunction upgradeContentResourceOrChoice(\n  resource: Presentation2.ContentResource | Presentation2.ChoiceEmbeddedContent\n): Presentation3.ContentResource | Presentation3.ChoiceBody {\n  if ((resource as any).type === 'Choice') {\n    return resource as any;\n  }\n  return upgradeContentResource(resource);\n}\n\nfunction upgradeContentResource(inputContentResource: Presentation2.ContentResource): Presentation3.ContentResource {\n  const contentResource = inputContentResource as Presentation2.CommonContentResource;\n\n  // @todo there might be some field dropped here.\n  return removeUndefinedProperties({\n    ...(technicalProperties(contentResource) as any),\n    ...(descriptiveProperties(contentResource) as any),\n    ...(linkingProperties(contentResource as any) as any),\n    ...(embeddedContentProperties(contentResource as any) as any),\n  });\n}\n\nfunction upgradeChoice(choice: Presentation2.ChoiceEmbeddedContent): Presentation3.ChoiceBody {\n  const items = [];\n\n  if (choice.default && choice.default !== 'rdf:nil') {\n    items.push(choice.default);\n  }\n\n  if (choice.item && choice.item !== 'rdf:nil') {\n    items.push(...choice.item);\n  }\n\n  return removeUndefinedProperties({\n    ...technicalProperties(choice),\n    ...descriptiveProperties(choice),\n    items: items as any,\n  });\n}\n\nfunction upgradeRange(range: Presentation2.Range): Presentation3.Range {\n  // range.members;\n  // range.canvases;\n  // Range.\n  // At the moment a range only references other ranges by id.\n  // So we need to first get\n  return removeUndefinedProperties({\n    ...technicalProperties(range),\n    ...descriptiveProperties(range),\n    ...linkingProperties(range),\n    items: range.members as any,\n  } as Presentation3.Range);\n}\n\nfunction upgradeService(service: Presentation2.Service): Presentation3.Service {\n  const { '@id': id, '@type': type, '@context': context, profile, ...additionalProps } = service as any;\n\n  const newService: any = {};\n\n  if (id) {\n    newService['@id'] = id;\n  }\n\n  newService['@type'] = getNewType(service);\n\n  if (newService['@type'] === 'unknown') {\n    // @todo handle case where there might be multiple contexts.\n    if (context && context.length) {\n      newService['@context'] = context;\n    }\n    newService['@type'] = 'Service'; // optional on services.\n  }\n\n  if (profile) {\n    newService.profile = getProfile(profile);\n  }\n\n  return removeUndefinedProperties({\n    ...newService,\n    ...additionalProps,\n  });\n}\n\nfunction upgradeLayer(layer: Presentation2.Layer): Presentation3.AnnotationCollection {\n  return removeUndefinedProperties({\n    ...technicalProperties(layer),\n    ...descriptiveProperties(layer),\n    ...linkingProperties(layer),\n  });\n}\n\nexport const presentation2to3 = new Traverse<{\n  Collection: Presentation3.Collection;\n  Manifest: Presentation3.Manifest;\n  Canvas: Presentation3.Canvas;\n  AnnotationList: Presentation3.AnnotationPage;\n  Sequence: Presentation3.Canvas[];\n  Annotation: Presentation3.Annotation;\n  ContentResource: Presentation3.ContentResource;\n  Choice: Presentation3.ChoiceBody;\n  Range: Presentation3.Range;\n  Service: Presentation3.Service;\n  Layer: Presentation3.AnnotationCollection;\n}>({\n  collection: [upgradeCollection],\n  manifest: [upgradeManifest],\n  canvas: [upgradeCanvas],\n  annotationList: [upgradeAnnotationList],\n  sequence: [upgradeSequence],\n  annotation: [upgradeAnnotation],\n  contentResource: [upgradeContentResource],\n  choice: [upgradeChoice],\n  range: [upgradeRange],\n  service: [upgradeService],\n  layer: [upgradeLayer],\n});\n\nexport function convertPresentation2(entity: any): Presentation3.Manifest | Presentation3.Collection {\n  if (\n    (entity &&\n      entity['@context'] &&\n      (entity['@context'] === 'http://iiif.io/api/presentation/2/context.json' ||\n        entity['@context'].indexOf('http://iiif.io/api/presentation/2/context.json') !== -1 ||\n        // Yale context.\n        entity['@context'] === 'http://www.shared-canvas.org/ns/context.json')) ||\n    entity['@context'] === 'http://iiif.io/api/image/2/context.json' ||\n    // No-context is possible.\n    (entity['@id'] && entity['@type'] === 'sc:Collection') ||\n    (entity['@id'] && entity['@type'] === 'sc:Manifest')\n  ) {\n    if (!entity['@context']) {\n      entity['@context'] = 'http://iiif.io/api/presentation/2/context.json';\n    }\n    return presentation2to3.traverseUnknown(entity);\n  }\n  return entity;\n}\n\nfunction upgradeSelector(\n  selector: Presentation2.ContentResourceSelector\n): Presentation3.Selector | Presentation3.Selector[] {\n  const isSvgSelector =\n    ((Array.isArray(selector['@type']) && selector['@type'].includes('oa:SvgSelector')) ||\n      selector['@type'] == 'oa:SvgSelector') &&\n    ('chars' in selector || 'value' in selector);\n  if (isSvgSelector) {\n    return {\n      type: 'SvgSelector',\n      value: 'chars' in selector ? selector.chars : selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:FragmentSelector') {\n    return {\n      type: 'FragmentSelector',\n      value: selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:Choice') {\n    return [\n      upgradeSelector(selector.default) as Presentation3.Selector,\n      ...((Array.isArray(selector.item) ? selector.item : [selector.item]).map(\n        upgradeSelector\n      ) as Presentation3.Selector[]),\n    ];\n  }\n  if (selector['@type'] == 'iiif:ImageApiSelector') {\n    return {\n      type: 'ImageApiSelector',\n      region: 'region' in selector ? selector.region : undefined,\n      rotation: 'rotation' in selector ? selector.rotation : undefined,\n    };\n  }\n  throw new Error(`Unsupported selector type: ${selector['@type']}`);\n}\n"],"mappings":"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"}