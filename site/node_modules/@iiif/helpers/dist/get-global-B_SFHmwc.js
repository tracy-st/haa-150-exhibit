import{_defineProperty as e}from"./defineProperty-C901nNqu.js";import{mitt_default as t}from"./mitt-BnbXAJlg.js";import{BATCH_ACTIONS as n,batchActions as r,entityActions as i}from"./batch-actions-BILnVnlf.js";import{metaActions as a}from"./meta-actions-D2Y8oeA0.js";import{areInputsEqual as o,createFetchHelper as s}from"./create-fetch-helper-Ty--oKG3.js";import{createStore as c}from"./store-B7swNE6p.js";import{HAS_PART as l,PART_OF as u,frameResource as d,isSpecificResource as f,serialize as p,serializeConfigPresentation2 as m,serializeConfigPresentation3 as h}from"@iiif/parser";function g(e,t,n,r=!0){t[y]=t[y]||[],t[y].push(e);let i=new Map;Object.defineProperty(t,e,{enumerable:r,get(){if(t[_][e]===void 0)return;let r=t[_][e];if(!r)return r;let a=n.get(t[_][e],{parent:this.id?{id:this.id,type:this.type}:void 0});return i.has(a)||(i.clear(),i.set(a,w(a,n))),i.get(a)},set(r){let i=t[_][e];i!==r&&(this[v]?n.modifyEntityField({id:this.id,type:this.type},e,C(r)):this[_][e]=r)}})}const _=Symbol.for(`_refs_`),v=Symbol.for(`_reactive_`),y=Symbol.for(`_defined_`),b=Symbol.for(`_parent_`);function x(e,t=!1,n){let r={id:``,type:`unknown`,[y]:[],[_]:{},[b]:n||null,[v]:null,is(e){return typeof e==`string`?this.id===e:e.id?e.id===this.id:!1},reactive(){if(!this[v])return this[v]=this.subscribe(()=>this.refresh(),!0),()=>{this.unreactive()}},refresh(){if(this.id){let e=this.unwrap();for(let t of Object.keys(e||{}))this[y].includes(t)?this[_][t]=e[t]:this[t]=e[t]}},unreactive(){this[v]&&(this[v](),this[v]=null)},unwrap(){if(!this.id)throw Error(`Invalid object`);let t=this[b];return e.get(this.id,{parent:t?{id:t,type:`unknown`}:void 0})},toPresentation3(){return e.toPresentation3(this.unwrap())},toPresentation2(){return e.toPresentation2(this.unwrap())},valueOf(){return this.unwrap()},toJSON(){let e=this;return{...e,items:e.items,annotations:e.annotations,structures:e.structures,seeAlso:e.seeAlso,service:e.service,services:e.services,rendering:e.rendering,partOf:e.partOf,start:e.start,supplementary:e.supplementary,homepage:e.homepage,thumbnail:e.thumbnail,placeholderCanvas:e.placeholderCanvas,accompanyingCanvas:e.accompanyingCanvas,provider:e.provider}},subscribe(t,n=!0){return e.subscribe(()=>this.id?e.get(this.id):null,t,n)}};return g(`items`,r,e),g(`annotations`,r,e),g(`structures`,r,e),g(`seeAlso`,r,e),g(`rendering`,r,e),g(`partOf`,r,e),g(`start`,r,e,!1),g(`supplementary`,r,e),g(`homepage`,r,e),g(`thumbnail`,r,e),g(`placeholderCanvas`,r,e,!1),g(`accompanyingCanvas`,r,e,!1),g(`provider`,r,e),g(`body`,r,e),g(`logo`,r,e),r}function S(e){return!!e[y]}function C(e){return Array.isArray(e)?e.map(e=>C(e)):!e||!e.type?e:{id:e.id,type:e.type}}function w(e,t,n=!1,r){if(Array.isArray(e))return e.map(e=>w(e,t,n));if(!e||!e.type||!e.id)return e;let i=x(t,n),a=Object.create(i),o=Object.assign(a,e);return n&&o.reactive(),o}function T(e){switch(e){case`Image`:case`Video`:case`Sound`:case`Dataset`:case`Text`:case`Composite`:case`List`:case`Independents`:case`Audience`:return`ContentResource`;case`ImageService1`:case`ImageService2`:case`ImageService3`:return`Service`}return e}var E=class{constructor(n,r){e(this,`options`,void 0),e(this,`store`,void 0),e(this,`emitter`,void 0),e(this,`isBatching`,!1),e(this,`batchQueue`,[]),e(this,`remoteFetcher`,void 0),e(this,`staticFetcher`,void 0),e(this,`defaultFetcher`,e=>fetch(e).then(e=>{if(e.status===200)return e.json();{let t=Error(`${e.status} ${e.statusText}`);throw t.name=`HTTPError`,t}})),this.options=Object.assign({reducers:{},customFetcher:this.defaultFetcher,enableDevtools:!0},n||{}),this.store=r||c({customReducers:this.options.reducers,defaultState:this.options.defaultState,enableDevtools:this.options.enableDevtools}),this.emitter=t(),this.remoteFetcher=s(this,this.options.customFetcher),this.staticFetcher=s(this,(e,t)=>t)}batch(e){this.isBatching=!0;try{e(this),this.isBatching=!1,this.dispatch(r({actions:this.batchQueue}))}catch(e){throw this.batchQueue=[],this.isBatching=!1,e}this.batchQueue=[]}async asyncBatch(e){this.isBatching=!0;try{await e(this),this.isBatching=!1,this.dispatch(r({actions:this.batchQueue}))}catch(e){throw this.batchQueue=[],this.isBatching=!1,e}this.batchQueue=[]}modifyEntityField(e,t,n){this.dispatch(i.modifyEntityField({id:e.id,type:e.type,key:t,value:n}))}dispatch(e){if(this.isBatching)this.batchQueue.push(e);else{if(e.type===n){for(let t of e.payload.actions)this.emitter.emit(t.type,{action:t,state:this.store.getState()});this.store.dispatch(e);let t=this.getState();for(let n of e.payload.actions)this.emitter.emit(`after:${n.type}`,{action:n,state:t});return}this.emitter.emit(e.type,{action:e,state:this.store.getState()}),this.store.dispatch(e);let t=this.store.getState();this.emitter.emit(`after:${e.type}`,{action:e,state:t});return}}on(e,t){return this.emitter.on(e,t),()=>{this.emitter.off(e,t)}}serialize(e,t){return p(this.getState().iiif,e,t)}toPresentation2(e){return this.serialize(e,m)}toPresentation3(e){return this.serialize(e,h)}hydrate(e,t,n={}){return this.get(e,t,{...n,skipSelfReturn:!1})}get(e,t,n={}){typeof t!=`string`&&(n=t||{},t=void 0);let{skipSelfReturn:r=!0}=n||{},i=n.parent?typeof n.parent==`string`?n.parent:n.parent.id:void 0;if(Array.isArray(e))return e.map(e=>this.get(e,n));let a=this.getState();if(f(e)&&!n.preserveSpecificResources&&(e=e.source),typeof e==`string`){let n=T(t||a.iiif.mapping[e]);if(!n)return r?null:{id:e,type:`unknown`};e={id:e,type:n}}if(e&&e.partOf&&!i&&!n.skipPartOfCheck){let t=Array.isArray(e.partOf)?e.partOf[0]:e.partOf;t&&(typeof t==`string`&&(i=t),typeof t.id==`string`&&(i=t.id))}let o=T(t||e?.type),s=e?.id,c=a.iiif.entities[o];if(!c){let t=a.iiif.requests[s];return t&&t.resourceUri!==s?this.get(t.resourceUri,n):r?null:e}let p=c[e.id];if(p&&p[l]){let e=p[l].find(e=>i?e[u]===i:e[u]===p.id);return d(p,e)}return c[e.id]||(r?null:e)}select(e){return e(this.getState())}getStore(){return this.store}getState(){return this.store.getState()}deep(e,t){if(e===void 0)return this.get(t,{skipSelfReturn:!1});if(typeof e==`function`)try{let n=e(this.get(t,{skipSelfReturn:!1})),r=e=>this.deep(e,n);return r.size=Array.isArray(n)?n.length:1,r}catch{let e=e=>this.deep(e,void 0);return e.size=0,e}let n=t=>this.deep(t,e);return n.size=Array.isArray(e)?e.length:1,n}loadManifest(e,t,n){let r=typeof e==`string`?e:e.id;return this.load(r,t,n)}loadCollection(e,t,n){let r=typeof e==`string`?e:e.id;return this.load(r,t,n)}load(e,t,n){let r=typeof e==`string`?e:e.id;return t?Promise.resolve(this.staticFetcher(r,t,n)):Promise.resolve(this.remoteFetcher(r,{},n))}loadSync(e,t,n){let r=typeof e==`string`?e:e.id;return this.staticFetcher(r,t,n)}loadManifestSync(e,t,n){let r=typeof e==`string`?e:e.id;return this.loadSync(r,t,n)}loadCollectionSync(e,t,n){let r=typeof e==`string`?e:e.id;return this.loadSync(r,t,n)}areInputsEqual(e,t){return o(e,t)}subscribe(e,t,n){return n===void 0&&(t===void 0||t===!1||t===!0)&&(n=t,t=e,e=e=>e),this.store.subscribe(e,e=>t(e,this),{equalityFn:o,fireImmediately:!n})}async ensureLoaded(e){let t=typeof e==`string`?e:e.id;this.requestStatus(t)||await this.load(t)}requestStatus(e){return this.select(t=>t.iiif.requests[e])}getPaginationState(e){let t=typeof e==`string`?e:e.id;if(!t)return null;let n=this.getResourceMeta(t,`@vault/pagination`);if(n?.state)return n.state;let r=this.get(e);if(r.first){let e={currentPage:null,currentPageIndex:null,isFetching:!1,isFullyLoaded:!1,next:r.first,page:1,pages:[],previous:null,totalItems:r.total,currentLength:0};return this.setMetaValue([t,`@vault/pagination`,`state`],e),e}return null}async loadNextPage(e,t){let n=typeof e==`string`?e:e.id;if(!n)return[null,null];let r=this.getPaginationState(e);if(!r||r.isFullyLoaded||!r.next)return[null,null];if(r.isFetching)return[r,null];let i=typeof r.next==`string`?r.next:r.next.id,a=r.currentPage,o={...r,isFetching:!0};this.setMetaValue([n,`@vault/pagination`,`state`],o);let s;try{s=await this.loadCollection(i,t,e=>{let{id:t,"@id":n,...r}=e||{};return n?{"@id":i,...r}:{id:i,...r}})}catch(e){let t={...r,isFetching:!1,error:e};return this.setMetaValue([n,`@vault/pagination`,`state`],t),[t,null]}if(!s){let e={...r,isFetching:!1,error:Error(`Collection not found`)};return this.setMetaValue([n,`@vault/pagination`,`state`],e),[e,null]}let c=this.get(n),l=[...c.items||[],...s.items||[]].map(e=>({id:e.id,type:e.type}));this.modifyEntityField({id:n,type:`Collection`},`items`,l);let u=this.getPaginationState(e);if(!u)throw Error(`Pagination state not found`);let d={...u,isFetching:!1,error:null,currentPage:s.id,next:s.next?.id||null,currentPageIndex:u.pages.length,currentLength:l.length,pages:[...u.pages,{id:s.id,type:`Collection`,startIndex:c.items.length,pageLength:s.items.length,order:typeof u.currentPageIndex==`number`?u.currentPageIndex+1:0}],isFullyLoaded:!s.next,previous:a,page:u.pages.length+1};return this.setMetaValue([n,`@vault/pagination`,`state`],d),[d,s]}getResourceMeta(e,t){let n=this.getState().iiif.meta[e];if(n)return t?n[t]:n}getObject(e,t,n={}){let{reactive:r,...i}=n;return w(this.get(e,t,i),this,r)}async loadObject(e,t){return w(await this.load(e,t),this)}async loadManifestObject(e,t){return w(await this.loadManifest(e,t),this)}async loadCollectionObject(e,t){return w(await this.loadCollection(e,t),this)}wrapObject(e){return w(this.get(e,{skipSelfReturn:!1}),this)}isWrapped(e){return S(e)}setMetaValue([e,t,n],r){this.dispatch(typeof r==`function`?a.setMetaValueDynamic({id:e,meta:t,key:n,updateValue:r}):a.setMetaValue({id:e,meta:t,key:n,value:r}))}};function D(){return typeof self<`u`?self:typeof window<`u`?window:typeof global<`u`?global:{}}export{E as Vault,D as getGlobal};
//# sourceMappingURL=get-global-B_SFHmwc.js.map