const e=require(`./chunk-DEHCWMz8.cjs`),t=require(`./defineProperty-65gtPnTc.cjs`),n=require(`./mitt-o3zmbM37.cjs`),r=require(`./batch-actions-X7z9ogvf.cjs`),i=require(`./meta-actions-BmpamiE1.cjs`),a=require(`./create-fetch-helper-CdGgcQvm.cjs`),o=require(`./store-B7mjPXcB.cjs`),s=e.__toESM(require(`@iiif/parser`));function c(e,t,n,r=!0){t[d]=t[d]||[],t[d].push(e);let i=new Map;Object.defineProperty(t,e,{enumerable:r,get(){if(t[l][e]===void 0)return;let r=t[l][e];if(!r)return r;let a=n.get(t[l][e],{parent:this.id?{id:this.id,type:this.type}:void 0});return i.has(a)||(i.clear(),i.set(a,g(a,n))),i.get(a)},set(r){let i=t[l][e];i!==r&&(this[u]?n.modifyEntityField({id:this.id,type:this.type},e,h(r)):this[l][e]=r)}})}const l=Symbol.for(`_refs_`),u=Symbol.for(`_reactive_`),d=Symbol.for(`_defined_`),f=Symbol.for(`_parent_`);function p(e,t=!1,n){let r={id:``,type:`unknown`,[d]:[],[l]:{},[f]:n||null,[u]:null,is(e){return typeof e==`string`?this.id===e:e.id?e.id===this.id:!1},reactive(){if(!this[u])return this[u]=this.subscribe(()=>this.refresh(),!0),()=>{this.unreactive()}},refresh(){if(this.id){let e=this.unwrap();for(let t of Object.keys(e||{}))this[d].includes(t)?this[l][t]=e[t]:this[t]=e[t]}},unreactive(){this[u]&&(this[u](),this[u]=null)},unwrap(){if(!this.id)throw Error(`Invalid object`);let t=this[f];return e.get(this.id,{parent:t?{id:t,type:`unknown`}:void 0})},toPresentation3(){return e.toPresentation3(this.unwrap())},toPresentation2(){return e.toPresentation2(this.unwrap())},valueOf(){return this.unwrap()},toJSON(){let e=this;return{...e,items:e.items,annotations:e.annotations,structures:e.structures,seeAlso:e.seeAlso,service:e.service,services:e.services,rendering:e.rendering,partOf:e.partOf,start:e.start,supplementary:e.supplementary,homepage:e.homepage,thumbnail:e.thumbnail,placeholderCanvas:e.placeholderCanvas,accompanyingCanvas:e.accompanyingCanvas,provider:e.provider}},subscribe(t,n=!0){return e.subscribe(()=>this.id?e.get(this.id):null,t,n)}};return c(`items`,r,e),c(`annotations`,r,e),c(`structures`,r,e),c(`seeAlso`,r,e),c(`rendering`,r,e),c(`partOf`,r,e),c(`start`,r,e,!1),c(`supplementary`,r,e),c(`homepage`,r,e),c(`thumbnail`,r,e),c(`placeholderCanvas`,r,e,!1),c(`accompanyingCanvas`,r,e,!1),c(`provider`,r,e),c(`body`,r,e),c(`logo`,r,e),r}function m(e){return!!e[d]}function h(e){return Array.isArray(e)?e.map(e=>h(e)):!e||!e.type?e:{id:e.id,type:e.type}}function g(e,t,n=!1,r){if(Array.isArray(e))return e.map(e=>g(e,t,n));if(!e||!e.type||!e.id)return e;let i=p(t,n),a=Object.create(i),o=Object.assign(a,e);return n&&o.reactive(),o}function _(e){switch(e){case`Image`:case`Video`:case`Sound`:case`Dataset`:case`Text`:case`Composite`:case`List`:case`Independents`:case`Audience`:return`ContentResource`;case`ImageService1`:case`ImageService2`:case`ImageService3`:return`Service`}return e}var v=e.__toESM(t.require_defineProperty(),1),y=class{constructor(e,t){(0,v.default)(this,`options`,void 0),(0,v.default)(this,`store`,void 0),(0,v.default)(this,`emitter`,void 0),(0,v.default)(this,`isBatching`,!1),(0,v.default)(this,`batchQueue`,[]),(0,v.default)(this,`remoteFetcher`,void 0),(0,v.default)(this,`staticFetcher`,void 0),(0,v.default)(this,`defaultFetcher`,e=>fetch(e).then(e=>{if(e.status===200)return e.json();{let t=Error(`${e.status} ${e.statusText}`);throw t.name=`HTTPError`,t}})),this.options=Object.assign({reducers:{},customFetcher:this.defaultFetcher,enableDevtools:!0},e||{}),this.store=t||o.createStore({customReducers:this.options.reducers,defaultState:this.options.defaultState,enableDevtools:this.options.enableDevtools}),this.emitter=n.mitt_default(),this.remoteFetcher=a.createFetchHelper(this,this.options.customFetcher),this.staticFetcher=a.createFetchHelper(this,(e,t)=>t)}batch(e){this.isBatching=!0;try{e(this),this.isBatching=!1,this.dispatch(r.batchActions({actions:this.batchQueue}))}catch(e){throw this.batchQueue=[],this.isBatching=!1,e}this.batchQueue=[]}async asyncBatch(e){this.isBatching=!0;try{await e(this),this.isBatching=!1,this.dispatch(r.batchActions({actions:this.batchQueue}))}catch(e){throw this.batchQueue=[],this.isBatching=!1,e}this.batchQueue=[]}modifyEntityField(e,t,n){this.dispatch(r.entityActions.modifyEntityField({id:e.id,type:e.type,key:t,value:n}))}dispatch(e){if(this.isBatching)this.batchQueue.push(e);else{if(e.type===r.BATCH_ACTIONS){for(let t of e.payload.actions)this.emitter.emit(t.type,{action:t,state:this.store.getState()});this.store.dispatch(e);let t=this.getState();for(let n of e.payload.actions)this.emitter.emit(`after:${n.type}`,{action:n,state:t});return}this.emitter.emit(e.type,{action:e,state:this.store.getState()}),this.store.dispatch(e);let t=this.store.getState();this.emitter.emit(`after:${e.type}`,{action:e,state:t});return}}on(e,t){return this.emitter.on(e,t),()=>{this.emitter.off(e,t)}}serialize(e,t){return(0,s.serialize)(this.getState().iiif,e,t)}toPresentation2(e){return this.serialize(e,s.serializeConfigPresentation2)}toPresentation3(e){return this.serialize(e,s.serializeConfigPresentation3)}hydrate(e,t,n={}){return this.get(e,t,{...n,skipSelfReturn:!1})}get(e,t,n={}){typeof t!=`string`&&(n=t||{},t=void 0);let{skipSelfReturn:r=!0}=n||{},i=n.parent?typeof n.parent==`string`?n.parent:n.parent.id:void 0;if(Array.isArray(e))return e.map(e=>this.get(e,n));let a=this.getState();if((0,s.isSpecificResource)(e)&&!n.preserveSpecificResources&&(e=e.source),typeof e==`string`){let n=_(t||a.iiif.mapping[e]);if(!n)return r?null:{id:e,type:`unknown`};e={id:e,type:n}}if(e&&e.partOf&&!i&&!n.skipPartOfCheck){let t=Array.isArray(e.partOf)?e.partOf[0]:e.partOf;t&&(typeof t==`string`&&(i=t),typeof t.id==`string`&&(i=t.id))}let o=_(t||e?.type),c=e?.id,l=a.iiif.entities[o];if(!l){let t=a.iiif.requests[c];return t&&t.resourceUri!==c?this.get(t.resourceUri,n):r?null:e}let u=l[e.id];if(u&&u[s.HAS_PART]){let e=u[s.HAS_PART].find(e=>i?e[s.PART_OF]===i:e[s.PART_OF]===u.id);return(0,s.frameResource)(u,e)}return l[e.id]||(r?null:e)}select(e){return e(this.getState())}getStore(){return this.store}getState(){return this.store.getState()}deep(e,t){if(e===void 0)return this.get(t,{skipSelfReturn:!1});if(typeof e==`function`)try{let n=e(this.get(t,{skipSelfReturn:!1})),r=e=>this.deep(e,n);return r.size=Array.isArray(n)?n.length:1,r}catch{let e=e=>this.deep(e,void 0);return e.size=0,e}let n=t=>this.deep(t,e);return n.size=Array.isArray(e)?e.length:1,n}loadManifest(e,t,n){let r=typeof e==`string`?e:e.id;return this.load(r,t,n)}loadCollection(e,t,n){let r=typeof e==`string`?e:e.id;return this.load(r,t,n)}load(e,t,n){let r=typeof e==`string`?e:e.id;return t?Promise.resolve(this.staticFetcher(r,t,n)):Promise.resolve(this.remoteFetcher(r,{},n))}loadSync(e,t,n){let r=typeof e==`string`?e:e.id;return this.staticFetcher(r,t,n)}loadManifestSync(e,t,n){let r=typeof e==`string`?e:e.id;return this.loadSync(r,t,n)}loadCollectionSync(e,t,n){let r=typeof e==`string`?e:e.id;return this.loadSync(r,t,n)}areInputsEqual(e,t){return a.areInputsEqual(e,t)}subscribe(e,t,n){return n===void 0&&(t===void 0||t===!1||t===!0)&&(n=t,t=e,e=e=>e),this.store.subscribe(e,e=>t(e,this),{equalityFn:a.areInputsEqual,fireImmediately:!n})}async ensureLoaded(e){let t=typeof e==`string`?e:e.id;this.requestStatus(t)||await this.load(t)}requestStatus(e){return this.select(t=>t.iiif.requests[e])}getPaginationState(e){let t=typeof e==`string`?e:e.id;if(!t)return null;let n=this.getResourceMeta(t,`@vault/pagination`);if(n?.state)return n.state;let r=this.get(e);if(r.first){let e={currentPage:null,currentPageIndex:null,isFetching:!1,isFullyLoaded:!1,next:r.first,page:1,pages:[],previous:null,totalItems:r.total,currentLength:0};return this.setMetaValue([t,`@vault/pagination`,`state`],e),e}return null}async loadNextPage(e,t){let n=typeof e==`string`?e:e.id;if(!n)return[null,null];let r=this.getPaginationState(e);if(!r||r.isFullyLoaded||!r.next)return[null,null];if(r.isFetching)return[r,null];let i=typeof r.next==`string`?r.next:r.next.id,a=r.currentPage,o={...r,isFetching:!0};this.setMetaValue([n,`@vault/pagination`,`state`],o);let s;try{s=await this.loadCollection(i,t,e=>{let{id:t,"@id":n,...r}=e||{};return n?{"@id":i,...r}:{id:i,...r}})}catch(e){let t={...r,isFetching:!1,error:e};return this.setMetaValue([n,`@vault/pagination`,`state`],t),[t,null]}if(!s){let e={...r,isFetching:!1,error:Error(`Collection not found`)};return this.setMetaValue([n,`@vault/pagination`,`state`],e),[e,null]}let c=this.get(n),l=[...c.items||[],...s.items||[]].map(e=>({id:e.id,type:e.type}));this.modifyEntityField({id:n,type:`Collection`},`items`,l);let u=this.getPaginationState(e);if(!u)throw Error(`Pagination state not found`);let d={...u,isFetching:!1,error:null,currentPage:s.id,next:s.next?.id||null,currentPageIndex:u.pages.length,currentLength:l.length,pages:[...u.pages,{id:s.id,type:`Collection`,startIndex:c.items.length,pageLength:s.items.length,order:typeof u.currentPageIndex==`number`?u.currentPageIndex+1:0}],isFullyLoaded:!s.next,previous:a,page:u.pages.length+1};return this.setMetaValue([n,`@vault/pagination`,`state`],d),[d,s]}getResourceMeta(e,t){let n=this.getState().iiif.meta[e];if(n)return t?n[t]:n}getObject(e,t,n={}){let{reactive:r,...i}=n;return g(this.get(e,t,i),this,r)}async loadObject(e,t){return g(await this.load(e,t),this)}async loadManifestObject(e,t){return g(await this.loadManifest(e,t),this)}async loadCollectionObject(e,t){return g(await this.loadCollection(e,t),this)}wrapObject(e){return g(this.get(e,{skipSelfReturn:!1}),this)}isWrapped(e){return m(e)}setMetaValue([e,t,n],r){this.dispatch(typeof r==`function`?i.metaActions.setMetaValueDynamic({id:e,meta:t,key:n,updateValue:r}):i.metaActions.setMetaValue({id:e,meta:t,key:n,value:r}))}};function b(){return typeof self<`u`?self:typeof window<`u`?window:typeof global<`u`?global:{}}Object.defineProperty(exports,`Vault`,{enumerable:!0,get:function(){return y}}),Object.defineProperty(exports,`getGlobal`,{enumerable:!0,get:function(){return b}});