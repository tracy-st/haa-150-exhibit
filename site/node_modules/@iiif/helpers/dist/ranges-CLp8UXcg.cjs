const e=require(`./chunk-DEHCWMz8.cjs`),t=require(`./compat-DSoLY7GO.cjs`),n=e.__toESM(require(`@iiif/parser`));function r(e){let t=JSON.stringify(e),n=5381,r=t.length;for(;r;)n=n*33^t.charCodeAt(--r);let i=n>>>0,a=i.toString(16);return a.length%2?`0`+a:a}function i(e=t.compatVault){return{findFirstCanvasFromRange:t=>a(e,t),findAllCanvasesInRange:t=>s(e,t),findManifestSelectedRange:(t,n)=>c(e,t,n),findSelectedRange:(t,n)=>l(e,t,n),rangesToTableOfContentsTree:(t,n,r={})=>u(e,t,n,r),rangeToTableOfContentsTree:(t,n={})=>d(e,t,[],n),isContiguous:(t,n,r={})=>p(e,t,n,r)}}function a(e,t){for(let n of t.items){if(typeof n==`string`)return{id:n,type:`Canvas`};if(n.type===`Canvas`)return n;if(n.type===`SpecificResource`&&n.source?.type===`Canvas`)return n.source;if(n.type===`Range`){let t=a(e,e.get(n));if(t)return t}}return null}function o(e,t){for(let n of t.items){if(typeof n==`string`)return{type:`SpecificResource`,source:{id:n,type:`Canvas`}};if(n.type===`Canvas`)return{type:`SpecificResource`,source:n};if(n.type===`SpecificResource`&&n.source?.type===`Canvas`)return n;if(n.type===`Range`){let t=o(e,e.get(n));if(t)return t}}return null}function s(e,t){let n=[];for(let r of t.items)if(r.type===`SpecificResource`&&r.source?.type===`Canvas`&&(r.source.id.indexOf(`#`)===-1?n.push(r.source):n.push({id:r.source.id.split(`#`)[0],type:`Canvas`})),r.type===`Range`&&n.push(...s(e,e.get(r))),r.type===`SpecificResource`){let e=typeof r.source==`string`?r.source:r.source.id;n.push({id:e,type:`Canvas`})}return n}function c(e,t,n){for(let r of t.structures){let t=l(e,e.get(r),n);if(t)return t}return null}function l(e,t,n){for(let r of t.items){let i=r?.source?.id?.split(`#`)[0];if(r.type===`SpecificResource`&&r.source===n||r.type===`SpecificResource`&&r.source?.type===`Canvas`&&n===i)return t;if(r.type===`Range`){let t=l(e,e.get(r),n);if(t)return t}}return null}function u(e,t,n,i={}){if(t.length===0)return null;let a=e.get(t);if(a.length===1)return d(e,a[0],[],i);let o={id:`vault://virtual-root/${r(a)}`,type:`Range`,label:n||{en:[`Table of Contents`]},items:a};return d(e,o,[],i)}function d(e,t,i=[],a={}){if(!t)return null;let s=e.get(t,{skipSelfReturn:!1}),c={id:s.id,type:`Range`,label:s.label,untitled:!s.label,isCanvasLeaf:!1,isRangeLeaf:!1,isVirtual:s.id.startsWith(`vault://virtual-root/`),items:[]};if(i.indexOf(c.id)!==-1&&(c.id=`vault://${r(s)}`),s.behavior&&s.behavior.includes(`no-nav`))if(a.showNoNav)c.isNoNav=!0;else return null;if(!s.items)return c;for(let t of s.items){if(typeof t==`string`){let n=e.get({id:t,type:`Canvas`},{skipSelfReturn:!1}),a={id:t,type:`Canvas`,isCanvasLeaf:!0,isRangeLeaf:!1,isNoNav:s.behavior&&s.behavior.includes(`no-nav`),label:n.label||{none:[`Untitled`]},untitled:!n.label,resource:{type:`SpecificResource`,source:{id:t,type:`Canvas`}}};i.indexOf(a.id)!==-1&&(a.id=`vault://${r(t)}`),i.push(a.id),c.items.push(a);continue}if(t.type===`SpecificResource`&&t.source?.type===`Canvas`){let a=e.get(t.source),o=(0,n.compressSpecificResource)(t);if(!a)continue;let s={id:o.type===`Canvas`?o.id:t.source.id,type:`Canvas`,isCanvasLeaf:!0,isRangeLeaf:!1,label:a.label||{none:[`Untitled`]},untitled:!a.label,resource:t};i.indexOf(s.id)!==-1&&(s.id=`vault://${r(t)}`),i.push(s.id),c.items.push(s);continue}if(t.type===`Canvas`){let e={id:t.id,type:`Canvas`,label:t.label,isCanvasLeaf:!0,isRangeLeaf:!1,resource:{type:`SpecificResource`,source:t}};i.indexOf(e.id)!==-1&&(e.id=`vault://${r(t)}`),i.push(e.id),c.items.push(e);continue}if(t.type===`Range`){let n=d(e,t,i,a);n&&c.items.push(n)}}return c.firstCanvas=o(e,s),c.isRangeLeaf=c.items?c.items.filter(e=>e.type===`Range`).length===0:!0,c}function f(e,t,n=[]){let r=e.get(t),i=[],a=r.id?[...n,r.id]:n;if(!r.items)return i;for(let t of r.items)if(typeof t==`string`)i.push({canvas:{id:t,type:`Canvas`},path:a});else if(t.type===`SpecificResource`){let e=t.source;e?.type===`Canvas`&&i.push({canvas:e,path:a})}else t.type===`Range`&&i.push(...f(e,t,a));return i}function p(e,t,n,r={}){let i=n.map(t=>e.get(t,{skipSelfReturn:!1})),a=e.get(t),o=i.map(e=>e.id),s=f(e,a),c={isContiguous:!0,startIndex:-1,endIndex:-1,gaps:[],invalidRanges:[],invalidCanvases:[],reason:null};if(s.length===0)return r.detail?[!0,c]:[!0,null];let l=s.map(({canvas:e})=>o.indexOf(e.id)),u=!0,d=-1,p=new Map,m=(e,t)=>{p.has(e)||p.set(e,[]);let n=p.get(e);n.includes(t)||n.push(t)};for(let e=0;e<l.length;e++){let t=l[e],n=s[e],i=n.path[n.path.length-1];if(t===-1){u=!1,i&&m(i,`Canvas not found`),c.invalidCanvases.push(n.canvas.id);continue}if(e>0&&d!==-1)if(t<=d)u=!1,i&&m(i,`Canvas out of order`);else{let e=t-d;e>1&&(r.allowGaps||(u=!1),r.detail&&c.gaps.push({startIndex:d,endIndex:t,canvasIds:o.slice(d+1,t)})),d=t}else d=t}if(!r.allowSubset)if(s.length!==o.length)u=!1;else{let e=o.every(e=>s.some(t=>t.canvas.id===e));e||(u=!1)}if(!r.detail)return[u,null];let h=Array.from(p.keys());h.length>0&&(c.invalidRanges=h.map(e=>({id:e,reasons:p.get(e)||[]})));let g={...c,isContiguous:u},_=l.filter(e=>e!==-1);return _.length>0&&(g.startIndex=_[0],g.endIndex=_[_.length-1]),[u,g]}Object.defineProperty(exports,`createRangeHelper`,{enumerable:!0,get:function(){return i}}),Object.defineProperty(exports,`findAllCanvasesInRange`,{enumerable:!0,get:function(){return s}}),Object.defineProperty(exports,`findFirstCanvasFromRange`,{enumerable:!0,get:function(){return a}}),Object.defineProperty(exports,`findFirstCanvasFromRangeWithSelector`,{enumerable:!0,get:function(){return o}}),Object.defineProperty(exports,`findManifestSelectedRange`,{enumerable:!0,get:function(){return c}}),Object.defineProperty(exports,`findSelectedRange`,{enumerable:!0,get:function(){return l}}),Object.defineProperty(exports,`isRangeContiguous`,{enumerable:!0,get:function(){return p}}),Object.defineProperty(exports,`rangeToTableOfContentsTree`,{enumerable:!0,get:function(){return d}}),Object.defineProperty(exports,`rangesToTableOfContentsTree`,{enumerable:!0,get:function(){return u}});