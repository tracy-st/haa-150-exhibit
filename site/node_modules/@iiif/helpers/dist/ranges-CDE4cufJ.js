import{compatVault as e}from"./compat-167ipRuK.js";import{compressSpecificResource as t}from"@iiif/parser";function n(e){let t=JSON.stringify(e),n=5381,r=t.length;for(;r;)n=n*33^t.charCodeAt(--r);let i=n>>>0,a=i.toString(16);return a.length%2?`0`+a:a}function r(t=e){return{findFirstCanvasFromRange:e=>i(t,e),findAllCanvasesInRange:e=>o(t,e),findManifestSelectedRange:(e,n)=>s(t,e,n),findSelectedRange:(e,n)=>c(t,e,n),rangesToTableOfContentsTree:(e,n,r={})=>l(t,e,n,r),rangeToTableOfContentsTree:(e,n={})=>u(t,e,[],n),isContiguous:(e,n,r={})=>f(t,e,n,r)}}function i(e,t){for(let n of t.items){if(typeof n==`string`)return{id:n,type:`Canvas`};if(n.type===`Canvas`)return n;if(n.type===`SpecificResource`&&n.source?.type===`Canvas`)return n.source;if(n.type===`Range`){let t=i(e,e.get(n));if(t)return t}}return null}function a(e,t){for(let n of t.items){if(typeof n==`string`)return{type:`SpecificResource`,source:{id:n,type:`Canvas`}};if(n.type===`Canvas`)return{type:`SpecificResource`,source:n};if(n.type===`SpecificResource`&&n.source?.type===`Canvas`)return n;if(n.type===`Range`){let t=a(e,e.get(n));if(t)return t}}return null}function o(e,t){let n=[];for(let r of t.items)if(r.type===`SpecificResource`&&r.source?.type===`Canvas`&&(r.source.id.indexOf(`#`)===-1?n.push(r.source):n.push({id:r.source.id.split(`#`)[0],type:`Canvas`})),r.type===`Range`&&n.push(...o(e,e.get(r))),r.type===`SpecificResource`){let e=typeof r.source==`string`?r.source:r.source.id;n.push({id:e,type:`Canvas`})}return n}function s(e,t,n){for(let r of t.structures){let t=c(e,e.get(r),n);if(t)return t}return null}function c(e,t,n){for(let r of t.items){let i=r?.source?.id?.split(`#`)[0];if(r.type===`SpecificResource`&&r.source===n||r.type===`SpecificResource`&&r.source?.type===`Canvas`&&n===i)return t;if(r.type===`Range`){let t=c(e,e.get(r),n);if(t)return t}}return null}function l(e,t,r,i={}){if(t.length===0)return null;let a=e.get(t);if(a.length===1)return u(e,a[0],[],i);let o={id:`vault://virtual-root/${n(a)}`,type:`Range`,label:r||{en:[`Table of Contents`]},items:a};return u(e,o,[],i)}function u(e,r,i=[],o={}){if(!r)return null;let s=e.get(r,{skipSelfReturn:!1}),c={id:s.id,type:`Range`,label:s.label,untitled:!s.label,isCanvasLeaf:!1,isRangeLeaf:!1,isVirtual:s.id.startsWith(`vault://virtual-root/`),items:[]};if(i.indexOf(c.id)!==-1&&(c.id=`vault://${n(s)}`),s.behavior&&s.behavior.includes(`no-nav`))if(o.showNoNav)c.isNoNav=!0;else return null;if(!s.items)return c;for(let r of s.items){if(typeof r==`string`){let t=e.get({id:r,type:`Canvas`},{skipSelfReturn:!1}),a={id:r,type:`Canvas`,isCanvasLeaf:!0,isRangeLeaf:!1,isNoNav:s.behavior&&s.behavior.includes(`no-nav`),label:t.label||{none:[`Untitled`]},untitled:!t.label,resource:{type:`SpecificResource`,source:{id:r,type:`Canvas`}}};i.indexOf(a.id)!==-1&&(a.id=`vault://${n(r)}`),i.push(a.id),c.items.push(a);continue}if(r.type===`SpecificResource`&&r.source?.type===`Canvas`){let a=e.get(r.source),o=t(r);if(!a)continue;let s={id:o.type===`Canvas`?o.id:r.source.id,type:`Canvas`,isCanvasLeaf:!0,isRangeLeaf:!1,label:a.label||{none:[`Untitled`]},untitled:!a.label,resource:r};i.indexOf(s.id)!==-1&&(s.id=`vault://${n(r)}`),i.push(s.id),c.items.push(s);continue}if(r.type===`Canvas`){let e={id:r.id,type:`Canvas`,label:r.label,isCanvasLeaf:!0,isRangeLeaf:!1,resource:{type:`SpecificResource`,source:r}};i.indexOf(e.id)!==-1&&(e.id=`vault://${n(r)}`),i.push(e.id),c.items.push(e);continue}if(r.type===`Range`){let t=u(e,r,i,o);t&&c.items.push(t)}}return c.firstCanvas=a(e,s),c.isRangeLeaf=c.items?c.items.filter(e=>e.type===`Range`).length===0:!0,c}function d(e,t,n=[]){let r=e.get(t),i=[],a=r.id?[...n,r.id]:n;if(!r.items)return i;for(let t of r.items)if(typeof t==`string`)i.push({canvas:{id:t,type:`Canvas`},path:a});else if(t.type===`SpecificResource`){let e=t.source;e?.type===`Canvas`&&i.push({canvas:e,path:a})}else t.type===`Range`&&i.push(...d(e,t,a));return i}function f(e,t,n,r={}){let i=n.map(t=>e.get(t,{skipSelfReturn:!1})),a=e.get(t),o=i.map(e=>e.id),s=d(e,a),c={isContiguous:!0,startIndex:-1,endIndex:-1,gaps:[],invalidRanges:[],invalidCanvases:[],reason:null};if(s.length===0)return r.detail?[!0,c]:[!0,null];let l=s.map(({canvas:e})=>o.indexOf(e.id)),u=!0,f=-1,p=new Map,m=(e,t)=>{p.has(e)||p.set(e,[]);let n=p.get(e);n.includes(t)||n.push(t)};for(let e=0;e<l.length;e++){let t=l[e],n=s[e],i=n.path[n.path.length-1];if(t===-1){u=!1,i&&m(i,`Canvas not found`),c.invalidCanvases.push(n.canvas.id);continue}if(e>0&&f!==-1)if(t<=f)u=!1,i&&m(i,`Canvas out of order`);else{let e=t-f;e>1&&(r.allowGaps||(u=!1),r.detail&&c.gaps.push({startIndex:f,endIndex:t,canvasIds:o.slice(f+1,t)})),f=t}else f=t}if(!r.allowSubset)if(s.length!==o.length)u=!1;else{let e=o.every(e=>s.some(t=>t.canvas.id===e));e||(u=!1)}if(!r.detail)return[u,null];let h=Array.from(p.keys());h.length>0&&(c.invalidRanges=h.map(e=>({id:e,reasons:p.get(e)||[]})));let g={...c,isContiguous:u},_=l.filter(e=>e!==-1);return _.length>0&&(g.startIndex=_[0],g.endIndex=_[_.length-1]),[u,g]}export{r as createRangeHelper,o as findAllCanvasesInRange,i as findFirstCanvasFromRange,a as findFirstCanvasFromRangeWithSelector,s as findManifestSelectedRange,c as findSelectedRange,f as isRangeContiguous,u as rangeToTableOfContentsTree,l as rangesToTableOfContentsTree};
//# sourceMappingURL=ranges-CDE4cufJ.js.map