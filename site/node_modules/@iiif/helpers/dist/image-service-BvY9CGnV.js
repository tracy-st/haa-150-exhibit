import{_defineProperty as e}from"./defineProperty-C901nNqu.js";import{createStore as t}from"./vanilla-CQtPfF5u.js";import{mitt_default as n}from"./mitt-BnbXAJlg.js";import{canonicalServiceUrl as r,createImageServiceRequest as i,extractFixedSizeScales as a,fixedSizesFromScales as o,getId as s,getImageServiceLevel as c,getImageServices as l,getType as u,imageServiceRequestToString as d,isImageService as f,isLevel0 as p,supportsCustomSizes as m}from"@iiif/parser/image-3";function h(e){let t=e.replace(/(https?:\/\/)?(www.)?/i,``);return t.indexOf(`/`)===-1?t:t.split(`/`)[0]}function g(e,t,n){let r=e>t?e:t,i=n.length,a=[];for(let e=0;e<i;e++){let t=n[e];if(!t||t.scaleFactors.length===0)continue;let i=t.scaleFactors[0];if(!i)continue;let o=r/i,s=[i];for(;o>=t.width;)i*=2,s.push(i),o/=2;a.push({...t,scaleFactors:s})}return a}function _(e,t,n){let a=i({"@context":e.version===3?`http://iiif.io/api/image/3/context.json`:`http://iiif.io/api/image/2/context.json`,id:r(s(e)),profile:e.level===null||e.level===void 0?`level0`:`level${e.level}`,type:e.version===3?`ImageService3`:`ImageService2`});if(a.type!==`image`)throw Error(`Invalid service`);a.size.max=!1,a.size.width=t,a.size.height=n;let o=d(a);return{id:o,type:`fixed`,width:t,height:n||e.height/(e.width||1)*t,unsafe:e.width>t}}function v(e,t,n){let r=e.width?e.width:e.maxWidth;return n.height<=e.maxHeight&&n.width<=e.maxWidth&&n.height>=e.minHeight&&n.width>=e.minWidth&&(!t||Math.abs(n.width-r)<Math.abs(t.width-r))}function y(e,t){let n=[],r=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),i=(e,t=0)=>r.explain?n.push(Array(t).fill(0).map(e=>`    `).join(``)+e().trim()):void 0,a=[],o=[],s=null;i(()=>`Using configuration: ${JSON.stringify(r,null,2)}`);let c=(e,t)=>{if(i(()=>`Swapping choice`,3),v(r,t,e)){if(r.preferFixedSize&&e.unsafe){i(()=>`We found an image that was marked as unsafe, but it was the best size. (${e.id})`,4),o.push(e);return}r.returnAllOptions&&t&&o.push(t),i(()=>`We found a new image that was the best size. (${e.id})`,4),s=e}else r.returnAllOptions&&o.push(e)};i(()=>`The input shows we have ${t.length} list(s) of candidates to choose from.`);let l=t.length;for(let e=0;e<l;e++){let n=t[e]();i(()=>`Candidate group ${e}: ${JSON.stringify(n,null,2)}`,1);let o=n.length;i(()=>`Checking candidate list number ${e} and found ${o} potential ways of creating image(s)`,1);for(let e=0;e<o;e++){let t=n[e];if(i(()=>`-> Checking candidate ${e}`,1),t.type===`unknown`&&r.atAnyCost&&(i(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),a.push(t)),t.type===`fixed`&&(t.unsafe?(i(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),a.push(t)):(i(()=>`We've found a fixed size image, checking if it matches the request`,2),c(t,s))),t.type===`fixed-service`)if(r.unsafeImageService){i(()=>`Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)`,2);let e=_(t,r.width,r.height);c(e,s)}else{i(()=>`Checking for an image from the tile source 3`,2);let e=_(t,t.width,t.height);c(e,s)}if(t.type===`variable`&&t.maxWidth){let e=_({id:t.id,type:`fixed-service`,width:t.maxWidth,height:t.maxWidth,level:t.level,version:t.version},t.maxWidth);c(e,s)}}if(s&&!r.returnAllOptions){if(s.unsafe||r.allowUnsafe)continue;i(()=>`We found a match in choice list number ${e}, no searching any more`);break}}return r.atAnyCost&&o.length===0?(i(()=>s?`We found an image! ${s.id} of type ${s.type}`:`We found no images, but "atAnyCost" is set, so returning that`),{best:s||a[0]||null,fallback:a.slice(1),log:n}):r.returnAllOptions?(i(()=>`Returning all options that we have found`),{best:(r.atAnyCost?s||o[0]||a[0]:s||o[0])||null,fallback:[...o,...a],log:n}):(i(()=>`Returning the best image that we found, and a fallback`),{best:s||o[0]||null,fallback:s?o:o.slice(1),log:n})}function b(e){let t=e[`@context`]?Array.isArray(e[`@context`])?e[`@context`]:[e[`@context`]]:[];return t.indexOf(`http://iiif.io/api/image/3/context.json`)!==-1}function x(e){return f(e)?(e&&e.sizes?e.sizes:[]).map(t=>({id:s(e),type:`fixed-service`,height:t.height,width:t.width,level:c(e),version:b(e)?3:2})):[]}function S(e){if(!m(e))return[];let t=[],n=Array.isArray(e.profile)?e.profile:[e.profile],r=n.length;for(let t=0;t<r;t++){let r=n[t];if(r&&typeof r!=`string`&&(r.maxHeight||r.maxWidth))return[{id:s(e),type:`variable`,minWidth:0,minHeight:0,maxHeight:r.maxHeight||r.maxWidth,maxWidth:r.maxWidth||r.maxHeight,level:c(e),version:e[`@context`]===`http://iiif.io/api/image/3/context.json`?3:2}]}if(e.tiles){let n=e.tiles.length;for(let r=0;r<n;r++){let n=e.tiles[r];n&&(n.height||n.width)&&t.push({id:s(e),type:`variable`,minHeight:0,minWidth:0,maxHeight:n.height||n.width,maxWidth:n.width,level:c(e),version:b(e)?3:2})}}return t}function C(e){let t=[],n=e.length;for(let r=0;r<n;r++){let n=e[r];if(!n)continue;let i=x(n);i.length&&t.push(...i);let a=S(n);a.length&&t.push(...a)}return t}function w(e){let t=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,n=e.match(t);if(n&&n[4]&&n[5]){let t=n[1],r=parseInt(n[4],10),i=parseInt(n[5],10),a=n[7];if((t===`max`||t===`full`)&&r&&i&&a)return{type:`fixed`,id:e,height:i,width:r}}return{type:`unknown`,id:e}}function T(e){if(typeof e==`string`)return w(e);let t=u(e);if(t!==`Image`&&t!==`sc:Image`)return null;let n=e,r=s(n);return r?r&&n.width&&n.height?{id:r,type:`fixed`,width:n.width,height:n.height,unsafe:!0}:w(r):null}function E(e,t=!0,n){let r=[],i=T(e);if(i===null)return r;let a=e;if(r.push(i),t&&a&&a.width&&a.height){let e=[],t=l(a);for(let r of t){let t={id:s(r),width:a.width,height:a.height};if(n.canLoadSync(t)){let r=n.loadServiceSync(t);r&&(r.height||=a.height,r.width||=a.width,e.push(...C([r])))}}if(e.length)return r.push(...e),r}return a.service&&r.push(...C(a.service)),r}function D(e,t){if(e.length!==t.length)return!1;if(e.length===0&&t.length===0)return!0;let n=e.length,r=!0;for(let i=0;i<n;i++){let n=e[i],a=t[i];if(n.width!==a.width||n.height!==a.height){r=!1;break}}if(r)return!0;let i=0;for(let r=0;r<n;r++)for(let a=0;a<n;a++)if(e[r].width===t[a].width&&e[r].height===t[a].height){i++;break}return i===n}var O=class{constructor(t={}){e(this,`config`,{verificationsRequired:1,approximateServices:!1,enableFetching:!0,disableThrottling:!1}),e(this,`fetchingCount`,0),e(this,`imageServices`,{}),e(this,`knownImageServers`,{}),this.config=Object.assign(this.config,t)}setConfig(e){Object.assign(this.config,e)}sample(e,t,n=!0){let i=h(s(e)),o=r(s(e)),c=this.knownImageServers[i];return this.imageServices[o]=Object.assign(e,{real:!0}),!c&&e.tiles&&!p(e)?(this.knownImageServers[i]={verifications:0,malformed:!1,root:i,preLoaded:n,sampledId:s(e),verified:!1,server:null,result:{context:e[`@context`]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:a(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,n=!1){let i=e?.source,a=h(s(e)),c=this.knownImageServers[a],l=r(s(e));return this.imageServices[l]?this.imageServices[l]||null:!this.config.approximateServices||!c||!c.result||!(i?.height||e.height)||!(i?.width||e.width)||!n&&(c.malformed||c.verifications<this.config.verificationsRequired)||e.source&&p(e.source)?null:(this.imageServices[l]||(this.imageServices[l]={"@context":c.result.context,"@id":s(e),id:s(e),protocol:`http://iiif.io/api/image`,tiles:i?.tiles||g(e.width,e.height,c.result.sampledTiles),sizes:i?.sizes||o(Math.round(e.width/c.result.resourceServiceRatio),Math.round(e.height/c.result.resourceServiceRatio),c.result.sizeRatios),profile:i?.profile||c.result.sampledProfile,height:i?.height||e.height,width:i?.width||e.width,real:!1}),this.imageServices[l]||null)}async getThumbnailFromResource(e,t,n=!0,r=[]){let i=e?await this.getImageCandidates(e,n):[];return y(t,[()=>r,()=>i])}async getImageCandidates(e,t=!0){let n=e;if(t&&n&&n.height&&n.width){let e=l(n);for(let t of e){let e={id:s(t),width:t.width?t.width:n.width,height:t.height?t.height:n.height,source:t};await this.loadService(e)}}return E(e,t,this)}async verify(e){let t=this.predict(e,!1,!0),n=await this.fetchService(s(e));if(!t)return!1;let r=t.height===n.height&&t.width===n.width&&t[`@context`]===n[`@context`]&&D(t.sizes||[],n.sizes||[]);if(r){let t=h(s(e)),n=this.knownImageServers[t];n&&(n.verifications+=1,n.verifications>=this.config.verificationsRequired&&(n.verified=!0))}return r}canLoadSync(e){let t=typeof e==`string`?e:s(e),n=r(t);if(this.imageServices[n])return!0;let i=this.knownImageServers[h(t)];return!!(i&&!i.malformed&&i.verifications>=this.config.verificationsRequired)}async markAsMalformed(e){return this.knownImageServers[h(s(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,t=!1){let n=r(e),i=this.imageServices[n];if(i&&(!t||i.real))return i;if(!this.config.enableFetching)throw Error(`Fetching is not enabled`);let a=await this.fetch(n).then(e=>e.json());return!a.id&&a[`@id`]&&(a.id=a[`@id`]),a.id!==e&&(a.id=e,a[`@id`]&&=e),this.imageServices[n]=Object.assign(a,{real:!0}),this.imageServices[n]}async fetch(e,t){return fetch(e,t)}async loadService(e,t=!1){if(!this.config.disableThrottling){let e=!0;for(;e;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(e=>setTimeout(e,500));else{e=!1;break}}let n=this.knownImageServers[h(s(e))];if(n&&!n.malformed&&!t){await n.result;let t=this.loadServiceSync(e);if(t)return t}this.fetchingCount++;let r=await this.fetchService(s(e),t);return this.fetchingCount--,r.real&&this.sample(r,e),r}loadServiceSync(e){let t=r(s(e));return this.imageServices[t]?this.imageServices[t]:this.config.approximateServices?this.predict(e):null}};function k(e={}){let r=e.events||n(),i=e.loader||new O,a=t((e,t)=>({loaded:{},loadServiceSync:(n,a,o)=>{let c=n.id||n[`@id`],l=t().loaded[c];if(l&&l.status===`done`)return l.service;if(l&&l.status===`loading`)return null;if(l&&l.status===`error`)throw Error(`Failed to load image service`);let u={id:s(n),width:n.width||a?.width||0,height:n.height||a?.height||0,source:n},d=i.loadServiceSync(u);return d?(e(e=>({loaded:{...e.loaded,[c]:{status:`done`,service:d,real:!0}}})),r.emit(`image-service.loaded`,{id:c,service:d})):o&&t().loadService(n,a).then(()=>{}),d},loadService:async(n,a)=>{let o=n.id||n[`@id`],c=t().loaded[o];if(c&&c.status===`done`)return c.service;if(c&&c.status===`loading`)return new Promise((e,t)=>{let i=t=>{t.id===o&&(r.off(`image-service.loaded`,i),e(t.service||n))};r.on(`image-service.loaded`,i)});if(c&&c.status===`error`&&!a?.force)throw Error(`Failed to load image service`);r.emit(`image-service.loading`,{id:o});try{let t={id:s(n),width:n.width||0,height:n.height||0,source:n},c=await i.loadService(t,a?.force);return e(e=>({loaded:{...e.loaded,[o]:{status:`done`,service:c,real:c.real}}})),r.emit(`image-service.loaded`,{id:o,service:c}),c}catch(e){throw r.emit(`image-service.error`,{id:o,error:e}),e}}}));return{store:a,events:r}}const A=k();function j(e){if(!e.width||!e.height)return null;if(e.tiles){let t=e.tiles.sort((e,t)=>Math.max(...t.scaleFactors)-Math.max(...e.scaleFactors)),n=t.length;for(let r=0;r<n;r++){let n=t[r];if(!n)continue;let i=n.width;if(!i)continue;let a=n.scaleFactors.length,o=n.scaleFactors.sort();for(let t=0;t<a;t++){let n=o[t];if(n&&e.width/n<=i&&e.height/n<=i)return{id:s(e),type:`fixed-service`,width:e.width/n|0,height:e.height/n|0,level:c(e),version:b(e)?3:2}}}}return null}export{O as ImageServiceLoader,k as createImageServiceStore,S as getCustomSizeFromService,T as getFixedSizeFromImage,x as getFixedSizesFromService,E as getImageCandidates,C as getImageCandidatesFromService,_ as getImageFromTileSource,h as getImageServerFromId,j as getSmallestScaleFactorAsSingleImage,A as imageServices,D as imageSizesMatch,w as inferImageSizeFromUrl,v as isBestMatch,b as isImage3,y as pickBestFromCandidates,g as sampledTilesToTiles};
//# sourceMappingURL=image-service-BvY9CGnV.js.map