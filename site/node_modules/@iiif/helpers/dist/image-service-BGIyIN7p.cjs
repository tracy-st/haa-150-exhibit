const e=require(`./chunk-DEHCWMz8.cjs`),t=require(`./defineProperty-65gtPnTc.cjs`),n=require(`./vanilla-Bv6fw5Yf.cjs`),r=require(`./mitt-o3zmbM37.cjs`),i=e.__toESM(require(`@iiif/parser/image-3`));function a(e){let t=e.replace(/(https?:\/\/)?(www.)?/i,``);return t.indexOf(`/`)===-1?t:t.split(`/`)[0]}function o(e,t,n){let r=e>t?e:t,i=n.length,a=[];for(let e=0;e<i;e++){let t=n[e];if(!t||t.scaleFactors.length===0)continue;let i=t.scaleFactors[0];if(!i)continue;let o=r/i,s=[i];for(;o>=t.width;)i*=2,s.push(i),o/=2;a.push({...t,scaleFactors:s})}return a}function s(e,t,n){let r=(0,i.createImageServiceRequest)({"@context":e.version===3?`http://iiif.io/api/image/3/context.json`:`http://iiif.io/api/image/2/context.json`,id:(0,i.canonicalServiceUrl)((0,i.getId)(e)),profile:e.level===null||e.level===void 0?`level0`:`level${e.level}`,type:e.version===3?`ImageService3`:`ImageService2`});if(r.type!==`image`)throw Error(`Invalid service`);r.size.max=!1,r.size.width=t,r.size.height=n;let a=(0,i.imageServiceRequestToString)(r);return{id:a,type:`fixed`,width:t,height:n||e.height/(e.width||1)*t,unsafe:e.width>t}}function c(e,t,n){let r=e.width?e.width:e.maxWidth;return n.height<=e.maxHeight&&n.width<=e.maxWidth&&n.height>=e.minHeight&&n.width>=e.minWidth&&(!t||Math.abs(n.width-r)<Math.abs(t.width-r))}function l(e,t){let n=[],r=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),i=(e,t=0)=>r.explain?n.push(Array(t).fill(0).map(e=>`    `).join(``)+e().trim()):void 0,a=[],o=[],l=null;i(()=>`Using configuration: ${JSON.stringify(r,null,2)}`);let u=(e,t)=>{if(i(()=>`Swapping choice`,3),c(r,t,e)){if(r.preferFixedSize&&e.unsafe){i(()=>`We found an image that was marked as unsafe, but it was the best size. (${e.id})`,4),o.push(e);return}r.returnAllOptions&&t&&o.push(t),i(()=>`We found a new image that was the best size. (${e.id})`,4),l=e}else r.returnAllOptions&&o.push(e)};i(()=>`The input shows we have ${t.length} list(s) of candidates to choose from.`);let d=t.length;for(let e=0;e<d;e++){let n=t[e]();i(()=>`Candidate group ${e}: ${JSON.stringify(n,null,2)}`,1);let o=n.length;i(()=>`Checking candidate list number ${e} and found ${o} potential ways of creating image(s)`,1);for(let e=0;e<o;e++){let t=n[e];if(i(()=>`-> Checking candidate ${e}`,1),t.type===`unknown`&&r.atAnyCost&&(i(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),a.push(t)),t.type===`fixed`&&(t.unsafe?(i(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),a.push(t)):(i(()=>`We've found a fixed size image, checking if it matches the request`,2),u(t,l))),t.type===`fixed-service`)if(r.unsafeImageService){i(()=>`Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)`,2);let e=s(t,r.width,r.height);u(e,l)}else{i(()=>`Checking for an image from the tile source 3`,2);let e=s(t,t.width,t.height);u(e,l)}if(t.type===`variable`&&t.maxWidth){let e=s({id:t.id,type:`fixed-service`,width:t.maxWidth,height:t.maxWidth,level:t.level,version:t.version},t.maxWidth);u(e,l)}}if(l&&!r.returnAllOptions){if(l.unsafe||r.allowUnsafe)continue;i(()=>`We found a match in choice list number ${e}, no searching any more`);break}}return r.atAnyCost&&o.length===0?(i(()=>l?`We found an image! ${l.id} of type ${l.type}`:`We found no images, but "atAnyCost" is set, so returning that`),{best:l||a[0]||null,fallback:a.slice(1),log:n}):r.returnAllOptions?(i(()=>`Returning all options that we have found`),{best:(r.atAnyCost?l||o[0]||a[0]:l||o[0])||null,fallback:[...o,...a],log:n}):(i(()=>`Returning the best image that we found, and a fallback`),{best:l||o[0]||null,fallback:l?o:o.slice(1),log:n})}function u(e){let t=e[`@context`]?Array.isArray(e[`@context`])?e[`@context`]:[e[`@context`]]:[];return t.indexOf(`http://iiif.io/api/image/3/context.json`)!==-1}function d(e){return(0,i.isImageService)(e)?(e&&e.sizes?e.sizes:[]).map(t=>({id:(0,i.getId)(e),type:`fixed-service`,height:t.height,width:t.width,level:(0,i.getImageServiceLevel)(e),version:u(e)?3:2})):[]}function f(e){if(!(0,i.supportsCustomSizes)(e))return[];let t=[],n=Array.isArray(e.profile)?e.profile:[e.profile],r=n.length;for(let t=0;t<r;t++){let r=n[t];if(r&&typeof r!=`string`&&(r.maxHeight||r.maxWidth))return[{id:(0,i.getId)(e),type:`variable`,minWidth:0,minHeight:0,maxHeight:r.maxHeight||r.maxWidth,maxWidth:r.maxWidth||r.maxHeight,level:(0,i.getImageServiceLevel)(e),version:e[`@context`]===`http://iiif.io/api/image/3/context.json`?3:2}]}if(e.tiles){let n=e.tiles.length;for(let r=0;r<n;r++){let n=e.tiles[r];n&&(n.height||n.width)&&t.push({id:(0,i.getId)(e),type:`variable`,minHeight:0,minWidth:0,maxHeight:n.height||n.width,maxWidth:n.width,level:(0,i.getImageServiceLevel)(e),version:u(e)?3:2})}}return t}function p(e){let t=[],n=e.length;for(let r=0;r<n;r++){let n=e[r];if(!n)continue;let i=d(n);i.length&&t.push(...i);let a=f(n);a.length&&t.push(...a)}return t}function m(e){let t=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,n=e.match(t);if(n&&n[4]&&n[5]){let t=n[1],r=parseInt(n[4],10),i=parseInt(n[5],10),a=n[7];if((t===`max`||t===`full`)&&r&&i&&a)return{type:`fixed`,id:e,height:i,width:r}}return{type:`unknown`,id:e}}function h(e){if(typeof e==`string`)return m(e);let t=(0,i.getType)(e);if(t!==`Image`&&t!==`sc:Image`)return null;let n=e,r=(0,i.getId)(n);return r?r&&n.width&&n.height?{id:r,type:`fixed`,width:n.width,height:n.height,unsafe:!0}:m(r):null}function g(e,t=!0,n){let r=[],a=h(e);if(a===null)return r;let o=e;if(r.push(a),t&&o&&o.width&&o.height){let e=[],t=(0,i.getImageServices)(o);for(let r of t){let t={id:(0,i.getId)(r),width:o.width,height:o.height};if(n.canLoadSync(t)){let r=n.loadServiceSync(t);r&&(r.height||=o.height,r.width||=o.width,e.push(...p([r])))}}if(e.length)return r.push(...e),r}return o.service&&r.push(...p(o.service)),r}function _(e,t){if(e.length!==t.length)return!1;if(e.length===0&&t.length===0)return!0;let n=e.length,r=!0;for(let i=0;i<n;i++){let n=e[i],a=t[i];if(n.width!==a.width||n.height!==a.height){r=!1;break}}if(r)return!0;let i=0;for(let r=0;r<n;r++)for(let a=0;a<n;a++)if(e[r].width===t[a].width&&e[r].height===t[a].height){i++;break}return i===n}var v=e.__toESM(t.require_defineProperty(),1),y=class{constructor(e={}){(0,v.default)(this,`config`,{verificationsRequired:1,approximateServices:!1,enableFetching:!0,disableThrottling:!1}),(0,v.default)(this,`fetchingCount`,0),(0,v.default)(this,`imageServices`,{}),(0,v.default)(this,`knownImageServers`,{}),this.config=Object.assign(this.config,e)}setConfig(e){Object.assign(this.config,e)}sample(e,t,n=!0){let r=a((0,i.getId)(e)),o=(0,i.canonicalServiceUrl)((0,i.getId)(e)),s=this.knownImageServers[r];return this.imageServices[o]=Object.assign(e,{real:!0}),!s&&e.tiles&&!(0,i.isLevel0)(e)?(this.knownImageServers[r]={verifications:0,malformed:!1,root:r,preLoaded:n,sampledId:(0,i.getId)(e),verified:!1,server:null,result:{context:e[`@context`]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:(0,i.extractFixedSizeScales)(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,n=!1){let r=e?.source,s=a((0,i.getId)(e)),c=this.knownImageServers[s],l=(0,i.canonicalServiceUrl)((0,i.getId)(e));return this.imageServices[l]?this.imageServices[l]||null:!this.config.approximateServices||!c||!c.result||!(r?.height||e.height)||!(r?.width||e.width)||!n&&(c.malformed||c.verifications<this.config.verificationsRequired)||e.source&&(0,i.isLevel0)(e.source)?null:(this.imageServices[l]||(this.imageServices[l]={"@context":c.result.context,"@id":(0,i.getId)(e),id:(0,i.getId)(e),protocol:`http://iiif.io/api/image`,tiles:r?.tiles||o(e.width,e.height,c.result.sampledTiles),sizes:r?.sizes||(0,i.fixedSizesFromScales)(Math.round(e.width/c.result.resourceServiceRatio),Math.round(e.height/c.result.resourceServiceRatio),c.result.sizeRatios),profile:r?.profile||c.result.sampledProfile,height:r?.height||e.height,width:r?.width||e.width,real:!1}),this.imageServices[l]||null)}async getThumbnailFromResource(e,t,n=!0,r=[]){let i=e?await this.getImageCandidates(e,n):[];return l(t,[()=>r,()=>i])}async getImageCandidates(e,t=!0){let n=e;if(t&&n&&n.height&&n.width){let e=(0,i.getImageServices)(n);for(let t of e){let e={id:(0,i.getId)(t),width:t.width?t.width:n.width,height:t.height?t.height:n.height,source:t};await this.loadService(e)}}return g(e,t,this)}async verify(e){let t=this.predict(e,!1,!0),n=await this.fetchService((0,i.getId)(e));if(!t)return!1;let r=t.height===n.height&&t.width===n.width&&t[`@context`]===n[`@context`]&&_(t.sizes||[],n.sizes||[]);if(r){let t=a((0,i.getId)(e)),n=this.knownImageServers[t];n&&(n.verifications+=1,n.verifications>=this.config.verificationsRequired&&(n.verified=!0))}return r}canLoadSync(e){let t=typeof e==`string`?e:(0,i.getId)(e),n=(0,i.canonicalServiceUrl)(t);if(this.imageServices[n])return!0;let r=this.knownImageServers[a(t)];return!!(r&&!r.malformed&&r.verifications>=this.config.verificationsRequired)}async markAsMalformed(e){return this.knownImageServers[a((0,i.getId)(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,t=!1){let n=(0,i.canonicalServiceUrl)(e),r=this.imageServices[n];if(r&&(!t||r.real))return r;if(!this.config.enableFetching)throw Error(`Fetching is not enabled`);let a=await this.fetch(n).then(e=>e.json());return!a.id&&a[`@id`]&&(a.id=a[`@id`]),a.id!==e&&(a.id=e,a[`@id`]&&=e),this.imageServices[n]=Object.assign(a,{real:!0}),this.imageServices[n]}async fetch(e,t){return fetch(e,t)}async loadService(e,t=!1){if(!this.config.disableThrottling){let e=!0;for(;e;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(e=>setTimeout(e,500));else{e=!1;break}}let n=this.knownImageServers[a((0,i.getId)(e))];if(n&&!n.malformed&&!t){await n.result;let t=this.loadServiceSync(e);if(t)return t}this.fetchingCount++;let r=await this.fetchService((0,i.getId)(e),t);return this.fetchingCount--,r.real&&this.sample(r,e),r}loadServiceSync(e){let t=(0,i.canonicalServiceUrl)((0,i.getId)(e));return this.imageServices[t]?this.imageServices[t]:this.config.approximateServices?this.predict(e):null}};function b(e={}){let t=e.events||r.mitt_default(),a=e.loader||new y,o=n.createStore((e,n)=>({loaded:{},loadServiceSync:(r,o,s)=>{let c=r.id||r[`@id`],l=n().loaded[c];if(l&&l.status===`done`)return l.service;if(l&&l.status===`loading`)return null;if(l&&l.status===`error`)throw Error(`Failed to load image service`);let u={id:(0,i.getId)(r),width:r.width||o?.width||0,height:r.height||o?.height||0,source:r},d=a.loadServiceSync(u);return d?(e(e=>({loaded:{...e.loaded,[c]:{status:`done`,service:d,real:!0}}})),t.emit(`image-service.loaded`,{id:c,service:d})):s&&n().loadService(r,o).then(()=>{}),d},loadService:async(r,o)=>{let s=r.id||r[`@id`],c=n().loaded[s];if(c&&c.status===`done`)return c.service;if(c&&c.status===`loading`)return new Promise((e,n)=>{let i=n=>{n.id===s&&(t.off(`image-service.loaded`,i),e(n.service||r))};t.on(`image-service.loaded`,i)});if(c&&c.status===`error`&&!o?.force)throw Error(`Failed to load image service`);t.emit(`image-service.loading`,{id:s});try{let n={id:(0,i.getId)(r),width:r.width||0,height:r.height||0,source:r},c=await a.loadService(n,o?.force);return e(e=>({loaded:{...e.loaded,[s]:{status:`done`,service:c,real:c.real}}})),t.emit(`image-service.loaded`,{id:s,service:c}),c}catch(e){throw t.emit(`image-service.error`,{id:s,error:e}),e}}}));return{store:o,events:t}}const x=b();function S(e){if(!e.width||!e.height)return null;if(e.tiles){let t=e.tiles.sort((e,t)=>Math.max(...t.scaleFactors)-Math.max(...e.scaleFactors)),n=t.length;for(let r=0;r<n;r++){let n=t[r];if(!n)continue;let a=n.width;if(!a)continue;let o=n.scaleFactors.length,s=n.scaleFactors.sort();for(let t=0;t<o;t++){let n=s[t];if(n&&e.width/n<=a&&e.height/n<=a)return{id:(0,i.getId)(e),type:`fixed-service`,width:e.width/n|0,height:e.height/n|0,level:(0,i.getImageServiceLevel)(e),version:u(e)?3:2}}}}return null}Object.defineProperty(exports,`ImageServiceLoader`,{enumerable:!0,get:function(){return y}}),Object.defineProperty(exports,`createImageServiceStore`,{enumerable:!0,get:function(){return b}}),Object.defineProperty(exports,`getCustomSizeFromService`,{enumerable:!0,get:function(){return f}}),Object.defineProperty(exports,`getFixedSizeFromImage`,{enumerable:!0,get:function(){return h}}),Object.defineProperty(exports,`getFixedSizesFromService`,{enumerable:!0,get:function(){return d}}),Object.defineProperty(exports,`getImageCandidates`,{enumerable:!0,get:function(){return g}}),Object.defineProperty(exports,`getImageCandidatesFromService`,{enumerable:!0,get:function(){return p}}),Object.defineProperty(exports,`getImageFromTileSource`,{enumerable:!0,get:function(){return s}}),Object.defineProperty(exports,`getImageServerFromId`,{enumerable:!0,get:function(){return a}}),Object.defineProperty(exports,`getSmallestScaleFactorAsSingleImage`,{enumerable:!0,get:function(){return S}}),Object.defineProperty(exports,`imageServices`,{enumerable:!0,get:function(){return x}}),Object.defineProperty(exports,`imageSizesMatch`,{enumerable:!0,get:function(){return _}}),Object.defineProperty(exports,`inferImageSizeFromUrl`,{enumerable:!0,get:function(){return m}}),Object.defineProperty(exports,`isBestMatch`,{enumerable:!0,get:function(){return c}}),Object.defineProperty(exports,`isImage3`,{enumerable:!0,get:function(){return u}}),Object.defineProperty(exports,`pickBestFromCandidates`,{enumerable:!0,get:function(){return l}}),Object.defineProperty(exports,`sampledTilesToTiles`,{enumerable:!0,get:function(){return o}});