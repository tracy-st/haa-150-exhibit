require(`./defineProperty-65gtPnTc.cjs`);const e=require(`./expand-target-CjBhcgOE.cjs`);require(`./annotation-targets-0Jiqf0D1.cjs`);function t(e,t,n){typeof t==`string`&&(t={id:t,type:`Canvas`});let r=e.get(t);if(r.rendering)for(let t of r.rendering){let n=e.get(t);if(`format`in n&&(n.format===`text/plain`||n.format===`application/xml`&&n?.profile===`http://www.loc.gov/standards/alto/`))return!0}if(r.annotations)for(let t of r.annotations){let n=e.get(t);for(let t of n.items||[]){let n=e.get(t);if(n.motivation?.includes(`supplementing`)&&n.body){let t=e.get(n.body),r=Array.isArray(t)?t:[t];for(let e of r)if(e.format===`text/vtt`||e.format===`text/plain`||e.type===`TextualBody`)return!0}}}if(n)for(let t of n)for(let n of t.items||[]){let t=e.get(n);if(t.motivation?.includes(`supplementing`)&&t.body){let n=e.get(t.body),r=Array.isArray(n)?n:[n];for(let e of r)if(e.format===`text/vtt`||e.format===`text/plain`||e.type===`TextualBody`)return!0}}return!1}async function n(e,t){typeof t==`string`&&(t={id:t,type:`Canvas`});let n=e.get(t),r=[];if(n.annotations)for(let t of n.annotations){let n=e.get(t),i=e.requestStatus(n.id);if(!i&&(!n.items||n[`iiif-parser:isExternal`]))try{r.push(await e.load(n.id))}catch{}else r.push(n)}return r}const r=/^(\d{2}:\d{2}:\d{2}[.,]\d{3})\s-->\s(\d{2}:\d{2}:\d{2}[.,]\d{3})(.*)\r?\n(.*(?:\r?\n(?!\r?\n).*)*)/gm;function i(e){let[t,n,r]=e.split(`:`).map(e=>parseFloat(e||`0`));return t*3600+n*60+r}async function a(e,t){let n=[],a;for(;a=r.exec(e);){let e=a[1],t=a[2],r=a[4].trim(),o={type:`TemporalSelector`,temporal:{startTime:i(e),endTime:i(t)}};n.push({startRaw:e,endRaw:t,text:r.replace(/(<([^>]+)>)/gi,``),textRaw:r,selector:{selector:o,selectors:[o]}})}return n.length?{id:t,source:{id:t,type:`Text`,format:`text/vtt`},plaintext:n.map(e=>e.text).join(`
`),segments:n}:null}async function o(e){return null}async function s(t,n){let r={id:n.id,source:{id:n.id,type:`AnnotationPage`},plaintext:``,segments:[]};if(!n.items)return null;for(let i of n.items){let n=t.get(i);if(n.motivation?.includes(`supplementing`)&&n.body){let i=t.get(n.body),a=Array.isArray(i)?i[0]:i;if((a.format===`text/plain`||a.type===`TextualBody`)&&a.value&&typeof a.value==`string`){let t=a.value,i=n.textGranularity;i||=t.includes(` `)?`line`:`word`,i===`line`||i===`paragraph`||i===`block`||i===`page`?t+=`
`:t+=` `;let o={text:t,textRaw:a.value,granularity:i};if(r.plaintext+=t,n.target)try{o.selector=e.expandTarget(n.target)}catch{}r.segments.push(o)}}}return r.plaintext=r.plaintext.trim(),r.plaintext===``&&r.segments.length===0?null:r}async function c(e,r,i={}){let c=e.get(r),l=await n(e,c);if(!t(e,r,l))return null;let u={id:c.id,source:c,plaintext:``,segments:[]};if(c.duration)for(let t of l)for(let n of t.items||[]){let t=e.get(n);if(t.motivation?.includes(`supplementing`)&&t.body){let n=e.get(t.body),r=Array.isArray(n)?n:[n];for(let e of r)if(e.format===`text/vtt`&&e.id){let t=i[e.id]||await fetch(e.id,{method:`GET`}).then(e=>e.text()),n=await a(t,e.id);if(n)return n}}}pageLabel:for(let t of l)for(let n of t.items||[]){let r=e.get(n);if(r.motivation?.includes(`supplementing`)&&r.body){let n=e.get(r.body),i=Array.isArray(n)?n:[n];for(let n of i)if(n.format===`text/plain`||n.type===`TextualBody`){let n=await s(e,t);if(n)return n;continue pageLabel}}}if(c.rendering)for(let t of c.rendering){let n=e.get(t);if(n.format===`text/plain`){let e=i[n.id]||await fetch(n.id,{method:`GET`}).then(e=>e.text());return{...u,plaintext:e}}}if(c.rendering)for(let t of c.rendering){let n=e.get(t);if(n.format===`application/xml`&&n.profile===`http://www.loc.gov/standards/alto/`){let e=await o(n.id);return e||null}}return null}async function l(e,r,i=5){let a=e.get(r)?.items||[],o=!1;for(let r of a){let a=e.get(r),s=t(e,a);if(s){o=!0;break}if(i>0){i--;let r=await n(e,a),s=t(e,a,r);if(s){o=!0;break}}}return o}exports.annotationPageToTranscription=s,exports.canvasHasTranscriptionSync=t,exports.canvasLoadExternalAnnotationPages=n,exports.getCanvasTranscription=c,exports.manifestHasTranscriptions=l,exports.timeStampToSeconds=i,exports.vttToTranscription=a;