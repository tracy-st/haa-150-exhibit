function tt(i){let n=i.points.length,r=!1,t=[];if(n>1){i.iedges=[];let e=i.points[n-1];for(let s=0;s<n;s++){let c=e;if(e=i.points[s],e.length===6){let d=e[2],m=e[3],g=e[4],y=e[5];t.push([s,[e[0]+d,e[1]+m],[e[0]+g,e[1]+y]]),r=!0}let o=[e[0]-c[0],e[1]-c[1]],p=o[0]*o[0]+o[1]*o[1];p>0?i.iedges.push([o[0]/p,o[1]/p]):i.iedges.push([0,0])}}else n===1?i.iedges=[[0,0]]:i.iedges=null;i.isBezier=r,i.bezierLines=t}function ct(i,n){let r=1/0,t=null,e=-1,s=i.points.length;if(s<=1)return[null,r,e];let c=i.points[s-1];for(let o=0;o<s;o++){let p=c;c=i.points[o];let d=p[0]-n[0],m=p[1]-n[1],g=d*d+m*m;g<r&&(t=p,r=g,e=o===0?s-1:o-1)}return[t,r,e]}function E(i){if(i.points.length>2){let n=Math.min(...i.points.map(s=>s[0])),r=Math.min(...i.points.map(s=>s[1])),t=Math.max(0,...i.points.map(s=>s[0])),e=Math.max(0,...i.points.map(s=>s[1]));i.boundingBox={x:n,y:r,width:t-n,height:e-r};return}i.boundingBox=null}function Kt(i){return i[0]*i[0]+i[1]*i[1]}function nt(i,n){let r=1/0,t=null,e=-1,s=[],c=i.points.length;if(c<=1)return[null,r,s,e];if(i.iedges===null&&(tt(i),!i.iedges))return[null,r,s,e];let o=i.points[c-1];for(let p=0;p<c;p++){let d=o;o=i.points[p];let m=(n[0]-d[0])*i.iedges[p][0]+(n[1]-d[1])*i.iedges[p][1],g;m<=0?g=d:m<1?g=[(1-m)*d[0]+m*o[0],(1-m)*d[1]+m*o[1]]:g=o;let y=Kt([g[0]-n[0],g[1]-n[1]]);y<r&&(t=g,r=y,s=[d,o],e=p===0?c-1:p-1)}return[t,r,s,e]}var j={type:"move-bounding-box",label:"Move bounding box",isValid(i,n,r){let t=n.polygon.points.length,e=t===n.selectedPoints.length,s=n.polygon.boundingBox;if(t<1||!e||!s)return!1;let c=i[0],o=c[0],p=c[1];return o>=s.x&&o<=s.x+s.width&&p>=s.y&&p<=s.y+s.height},transition(i,n,r){let t=n.transitionOrigin,e=n.polygon.boundingBox,s=i[0],c=s[0]-t[0],o=s[1]-t[1];n.transitionPoints=n.polygon.points.map(p=>p.length===6?[p[0]+c,p[1]+o,p[2],p[3],p[4],p[5]]:[p[0]+c,p[1]+o]),e&&(n.transitionBoundingBox={x:e.x+c,y:e.y+o,width:e.width,height:e.height})},commit(i,n,r){let t=n.transitionPoints;return n.transitionPoints=null,n.transitionBoundingBox=null,{points:t}}};var $={type:"move-shape",label:"Move shape",isValid(i,n,r){return r.Shift?!1:n.slowState.pointerInsideShape&&(!n.isOpen||n.line===null)},transition(i,n,r){j.transition(i,n,r)},commit(i,n,r){let t=n.transitionPoints;return n.transitionPoints=null,n.transitionBoundingBox=null,{points:t}}};function pt(i,n){return Math.abs(i-n)}function k(i,n){let r=pt(i[0],n[0]),t=pt(i[1],n[1]);return Math.sqrt(Math.pow(r,2)+Math.pow(t,2))}function et(i,n){return[i[0]-n[0],i[1]-n[1]]}function Ht(i,n){return i[0]*n[0]+i[1]*n[1]}function dt(i){return i[0]*i[0]+i[1]*i[1]}function G(i,n){return dt(et(i,n))}function K(i,n){let r,t,e,s;var c=function(f,a,P,x,M){if(x<=P+1)return;let O=P,R=0,A=f*f;r=[a[P],a[x]],t=et(r[1],r[0]);let C=dt(t),I,V,z,T,v;for(let D=P+1;D<x;D++)I=et(a[D],r[0]),T=Ht(I,t),T<=0?v=G(a[D],r[0]):C<=T?v=G(a[D],r[1]):(z=T/C,V=[r[0][0]+z*t[0],r[0][1]+z*t[1]],v=G(a[D],V)),!(v<=R)&&(O=D,R=v);R>A&&(M[O]=1,c(f,a,P,O,M),c(f,a,O,x,M))};let o=i.length,p=[],d,m,g,y,w=n*n;for(e=[],s=[],e[0]=i[0],d=m=1,y=0;d<o;d++)G(i[d],i[y])<w||(e[m++]=i[d],y=d);for(y<o-1&&(e[m++]=i[o-1]),s[0]=s[m-1]=1,c(n,e,0,m-1,s),d=g=0;d<m;d++)s[d]&&(p[g++]=e[d]);return p}var ut={type:"move-point",label:"Move point",modifiers:{Shift:"Constrain to axis"},isValid(i,n,r){if(r.Alt)return!1;let t=r.proximity,[e,s]=i[0],c=n.polygon.points,o=n.selectedPoints;for(let p=0;p<c.length;p++){let d=c[p],m=d[0]-e,g=d[1]-s;if(m*m+g*g<t*t)return!0}return!1},start(i,n,r){if(n.selectedPoints.length<2){let[t,e,s]=ct(n.polygon,i[0]);return{selectedPoints:[s]}}if(n.slowState.closestPoint&&!n.selectedPoints.includes(n.slowState.closestPoint))return{selectedPoints:[n.slowState.closestPoint]}},transition(i,n,r){let t=n.transitionOrigin,[e,s]=i[0],c=n.polygon.points,o=n.selectedPoints;if(n.slowState.closestPoint){let g=n.slowState.closestPoint;o.indexOf(g)===-1&&(o=[g])}let p=[],d=e-t[0],m=s-t[1];r.Shift&&(Math.abs(d)>Math.abs(m)?m=0:d=0);for(let g=0;g<c.length;g++){let y=o.indexOf(g)!==-1,w=c[g];y?w.length===6?p.push([w[0]+d,w[1]+m,w[2],w[3],w[4],w[5]]):p.push([w[0]+d,w[1]+m]):p.push(w)}n.transitionPoints=p},commit(i,n,r){let t=n.transitionPoints;return n.transitionPoints=null,n.transitionBoundingBox=null,{points:t}}};var ft=10,mt={type:"select-point",label:"Select point",trigger:{type:"click"},modifiers:{Shift:"Add to selection"},isValid(i,n,r){let t=-1;if(n.selectedPoints.length===1){let o=n.selectedPoints[0];o===0&&(t=n.polygon.points.length-1),o===n.polygon.points.length-1&&(t=0)}let[e,s]=i[0],c=n.polygon.points;for(let o=0;o<c.length;o++){let p=c[o],d=p[0]-e,m=p[1]-s;if(d*d+m*m<ft*ft)return t!==o}return!1},commit(i,n,r){let t=r.Shift?[...n.selectedPoints]:[],[e,s]=i[0],p=n.polygon.points.map((d,m)=>{let g=d[0]-e,y=d[1]-s;return[g*g+y*y,m]}).sort((d,m)=>d[0]-m[0])[0];if(n.line=null,!t.includes(p[1]))t.push(p[1]);else if(r.Shift)return{selectedPoints:t.filter(d=>d!==p[1])};return{selectedPoints:t}}};var H={type:"split-line",label:"Split line",isValid(i,n,r){return r.Meta||n.slowState.lineMode?!1:!!(n.closestLinePoint&&n.closestLineDistance<r.proximity)},transition(i,n,r){let t=n.transitionOrigin,[e,s]=i[0],c=n.polygon.points,o=[],p=e-t[0],d=s-t[1];for(let m=0;m<c.length;m++)if(o.push(c[m]),n.closestLineIndex===m){let g=n.closestLinePoint;o.push([g[0]+p,g[1]+d])}n.transitionPoints=o},commit(i,n,r){let t=n.transitionPoints;return n.transitionPoints=null,n.transitionBoundingBox=null,{selectedPoints:[n.closestLineIndex+1],points:t}}};var gt={type:"add-open-point",label:"Add point",trigger:{type:"click"},isValid(i,n,r){if(!n.isOpen)return!1;if(n.polygon.points.length===0)return!0;if(n.selectedPoints.length!==1||n.polygon.points.length>=2&&n.slowState.lineMode)return!1;let t=n.selectedPoints[0];return t===0||t===n.polygon.points.length-1},commit(i,n,r){let t=n.line?n.line[1]:i[0],e=n.polygon.points;return e.length===0?{selectedPoints:[0],points:[i[0]]}:(r.Shift,n.selectedPoints[0]===0?{selectedPoints:n.slowState.lineMode?[]:[0],points:[t,...e]}:(n.line=null,{selectedPoints:n.slowState.lineMode?[]:[e.length],points:[...e,t]}))}};var W={type:"close-shape",label:"Close shape",trigger:{type:"click"},isValid(i,n,r){if(!n.isOpen||n.selectedPoints.length!==1||n.polygon.points.length<2||r.Meta)return!1;let t=n.selectedPoints[0];if(t===0){let e=n.polygon.points[n.polygon.points.length-1];return k(i[0],e)<r.proximity}if(t===n.polygon.points.length-1){let e=n.polygon.points[0];return k(i[0],e)<r.proximity}return!1},commit(i,n,r){let t=n.selectedPoints[0];if(n.line=null,t===0)return{selectedPoints:[],points:n.polygon.points.slice(0).reverse(),isOpen:!1};if(t===n.polygon.points.length-1)return{selectedPoints:[],isOpen:!1}}};var ht={type:"deselect-draw",label:"Deselect draw",trigger:{type:"key",key:"Escape"},isValid(i,n,r){return!0},commit(i,n,r){return{selectedPoints:[]}}};var xt={type:"select-shape",label:"Select shape",trigger:{type:"click"},isValid(i,n,r){return $.isValid(i,n,r)},commit(i,n,r){return{selectedPoints:n.polygon.points.map((t,e)=>e)}}};var Pt={type:"deselect-bounding-box",label:"Deselect bounding box",trigger:{type:"click"},isValid(i,n,r){return!n.isOpen&&n.selectedPoints.length>2&&n.selectedPoints.length===n.polygon.points.length},commit(i,n,r){return{selectedPoints:[]}}};var yt={type:"bounding-box-corners",label:"Drag to resize",modifiers:{Shift:"Maintain aspect ratio",Alt:"Scale from center",Meta:"Rotate"},isValid(i,n,r){if(n.transitionDirection=null,n.transitionRotate=!1,n.isOpen||n.selectedPoints.length!==n.polygon.points.length||!n.polygon.boundingBox)return!1;let t=r.proximity*.5,e=r.proximity*3,s=i[0],c=n.polygon.boundingBox,o=c.x+t,p=c.x+c.width-t*2,d=c.y+t,m=c.y+c.height-t*2;if(s[0]>o&&s[0]<p&&s[1]>d&&s[1]<m)return!1;let g=[c.x+c.width,c.y+c.height],y=[c.x,c.y],w=[c.x+c.width,c.y],f=[c.x,c.y+c.height],a=["ne","nw","se","sw"],P=[k(i[0],w),k(i[0],y),k(i[0],g),k(i[0],f)],x=Math.min(...P);if(P[0]<e||P[1]<e||P[2]<e||P[3]<e){(x>r.proximity||r.Meta)&&(n.transitionRotate=!0);let M=P.indexOf(Math.min(...P));return n.transitionDirection=M!==-1?a[M]:null,!0}return!1},start(i,n,r){let t=i[0],e=n.polygon.boundingBox,s=[e.x+e.width,e.y+e.height],c=[e.x,e.y],o=[e.x+e.width,e.y],p=[e.x,e.y+e.height],d=["ne","nw","se","sw"],m=[k(i[0],o),k(i[0],c),k(i[0],s),k(i[0],p)],g=Math.min(...m),y=m.indexOf(g);n.transitionDirection=y!==-1?d[y]:null,g>r.proximity&&(n.transitionRotate=!0)},transition(i,n,r){let t=n.polygon.boundingBox,e=[t.x,t.y],s=n.transitionOrigin||i[0],[c,o]=i[0];if(r.Meta||n.transitionRotate){e=[t.x+t.width/2,t.y+t.height/2];let f=Math.atan2(s[1]-e[1],s[0]-e[0]),a=Math.atan2(o-e[1],c-e[0]),P=r.Shift,x=Math.PI/(r.Alt?4:12),M=a-f;P&&(M=Math.round(M/x)*x);let O=Math.cos(M),R=Math.sin(M),A=[];for(let I of n.polygon.points){let V=I[0]-e[0],z=I[1]-e[1],T=V*O-z*R,v=V*R+z*O,D=T+e[0],q=v+e[1];if(I.length===6){A.push([D,q,I[2],I[3],I[4],I[5]]);continue}A.push([D,q])}n.transitionPoints=A,E({points:A,iedges:null,boundingBox:null,isBezier:!1,bezierLines:[]}),n.transitionBoundingBox=n.polygon.boundingBox?{...n.polygon.boundingBox,rotation:M}:null;return}let p=0,d=0;switch(n.transitionDirection){case"se":{e=[t.x,t.y],p=c-s[0],d=o-s[1];break}case"sw":{e=[t.x+t.width,t.y],p=s[0]-c,d=o-s[1];break}case"ne":{e=[t.x,t.y+t.height],p=c-s[0],d=s[1]-o;break}case"nw":{e=[t.x+t.width,t.y+t.height],p=s[0]-c,d=s[1]-o;break}}if(r.Alt&&(e=[t.x+t.width/2,t.y+t.height/2],p*=2,d*=2),r.Shift){let f=t.width/t.height;Math.abs(t.width/p)>Math.abs(t.height/d)?d=p/f:p=d*f}let m=(t.width+p)/t.width,g=(t.height+d)/t.height,y=[];for(let f of n.polygon.points){let a=f[0]-e[0],P=f[1]-e[1],x=a*m,M=P*g,O=x+e[0],R=M+e[1];if(f.length===6){y.push([O,R,f[2],f[3],f[4],f[5]]);continue}y.push([O,R])}n.transitionPoints=y;let w={points:y,iedges:null,boundingBox:null,bezierLines:[],isBezier:!1};E(w),n.transitionBoundingBox=w.boundingBox},commit(i,n,r){let t=n.transitionPoints;return n.transitionPoints=null,n.transitionBoundingBox=null,n.transitionRotate=!1,{points:t}}};var St={type:"cut-line",label:"Add new point",trigger:{type:"click"},modifiers:{Shift:"Cut line"},isValid(i,n,r){return H.isValid(i,n,r)},commit(i,n,r){if(r.Shift&&!n.isOpen){let s=n.polygon.points,c=[],o=[],p=!1;for(let d=0;d<s.length;d++)p?o.push(s[d]):c.push(s[d]),n.closestLineIndex===d&&(p=!0);return{isOpen:!0,points:[...o,...c]}}let t=n.polygon.points,e=[];for(let s=0;s<t.length;s++)if(e.push(t[s]),n.closestLineIndex===s){let c=n.closestLinePoint;e.push(c)}return{points:e}}};var wt={type:"select-multiple-points",label:"Drag to select multiple points",isValid(i,n,r){return n.slowState.lineMode&&n.polygon.points.length>=2?!0:!n.line},transition(i,n,r){if(!n.transitionOrigin)return;let t=n.transitionOrigin[0],e=n.transitionOrigin[1],s=i[0][0],c=i[0][1],o=Math.min(t,s),p=Math.min(e,c),d=Math.abs(t-s),m=Math.abs(e-c);n.selectionBox={x:o,y:p,width:d,height:m}},commit(i,n,r){if(n.selectionBox){let t=[];r.Shift&&t.push(...n.selectedPoints);for(let e=0;e<n.polygon.points.length;e++){let s=n.polygon.points[e];s[0]>=n.selectionBox.x&&s[0]<=n.selectionBox.x+n.selectionBox.width&&s[1]>=n.selectionBox.y&&s[1]<=n.selectionBox.y+n.selectionBox.height&&t.push(e)}return{selectedPoints:t}}}};var bt={type:"deselect-points",label:"Deselect points",trigger:{type:"click"},isValid(i,n,r){return n.selectedPoints.length>0},commit(i,n,r){return{selectedPoints:[]}}};var _=4,Mt={type:"nudge-right",label:"Nudge right",trigger:{type:"key",key:"ArrowRight"},modifiers:{Shift:"Nudge right more"},isValid(i,n,r){return n.selectedPoints.length>0},commit(i,n,r){let t=r.proximity*.3,e=n.polygon.points,s=n.selectedPoints;return{points:e.map((o,p)=>s.includes(p)?[o[0]+(r.Shift?_*t:1),o[1]]:o)}}},Bt={type:"nudge-left",label:"Nudge left",trigger:{type:"key",key:"ArrowLeft"},modifiers:{Shift:"Nudge left more"},isValid(i,n,r){return n.selectedPoints.length>0},commit(i,n,r){let t=r.proximity*.3,e=n.polygon.points,s=n.selectedPoints;return{points:e.map((o,p)=>s.includes(p)?[Math.max(0,o[0]-(r.Shift?_*t:1)),o[1]]:o)}}},It={type:"nudge-up",label:"Nudge up",trigger:{type:"key",key:"ArrowUp"},modifiers:{Shift:"Nudge up more"},isValid(i,n,r){return n.selectedPoints.length>0},commit(i,n,r){let t=r.proximity*.3,e=n.polygon.points,s=n.selectedPoints;return{points:e.map((o,p)=>{if(s.includes(p)){let d=o[0],m=Math.max(0,o[1]-(r.Shift?_*t:1));return o.length===6?[d,m,o[2],o[3],o[4],o[5]]:[d,m]}return o})}}},At={type:"nudge-down",label:"Nudge down",trigger:{type:"key",key:"ArrowDown"},modifiers:{Shift:"Nudge down more"},isValid(i,n,r){return n.selectedPoints.length>0},commit(i,n,r){let t=r.proximity*.3,e=n.polygon.points,s=n.selectedPoints;return{points:e.map((o,p)=>{let d=o[0],m=Math.max(0,o[1]-(r.Shift?_*t:1));return s.includes(p)?o.length===6?[d,m,o[2],o[3],o[4],o[5]]:[d,m]:o})}}};var Lt={type:"delete-point",label:"Delete point",trigger:{type:"key",key:"Backspace"},isValid(i,n,r){return n.selectedPoints.length>0},commit(i,n,r){let e=n.polygon.points.filter((s,c)=>!n.selectedPoints.includes(c));return{isOpen:e.length<3,selectedPoints:[],points:e}}};var kt={type:"draw-shape",label:"Draw shape",isValid(i,n,r){let t=r.Alt||n.slowState.drawMode;return!!(n.isOpen&&(n.line||n.polygon.points.length===0)&&t)},start(i,n,r){n.transitionDraw=[]},transition(i,n,r){n.transitionDraw.push(i[0])},commit(i,n,r){let t=K(n.transitionDraw,n.scale*3);return n.transitionDraw=[],n.selectedPoints[0]===0?{isOpen:!1,points:[...t,...n.polygon.points.slice(0).reverse()]}:{isOpen:!1,points:[...n.polygon.points,...t]}}};var Ot={type:"stamp-shape",label:"Stamp shape",modifiers:{Shift:"Maintain aspect ratio"},isValid(i,n,r){return n.slowState.selectedStamp!==null},start(i,n,r){let t=i[0];if(t&&n.slowState.selectedStamp){let e=n.slowState.selectedStamp,s=t[0],c=t[1],o=[],p=Math.min(...e.points.map(a=>a[0])),d=Math.min(...e.points.map(a=>a[1])),m=Math.max(...e.points.map(a=>a[0]))-p,g=Math.max(...e.points.map(a=>a[1]))-d,y=m/32;g/32>y&&(y=g/32);let w=[],f=0;for(let a of e.points)w.push(f),o.push([s+(a[0]-p)/y,c+(a[1]-d)/y]),f++;return n.transitionPoints=o,{isOpen:!1,selectedPoints:w,points:o}}},transition(i,n,r){if(!n.transitionOrigin)return;let t=n.polygon.boundingBox,e=[t.x,t.y],s=n.transitionOrigin||i[0],[c,o]=i[0],p=n.transitionOrigin[0],d=n.transitionOrigin[1],m=i[0][0],g=i[0][1],y=m-p-32,w=g-d-32;if(r.Shift){let M=t.width/t.height;Math.abs(t.width/y)>Math.abs(t.height/w)?w=y/M:y=w*M}let f=(t.width+y)/t.width,a=(t.height+w)/t.height,P=[];for(let M of n.polygon.points){let O=M[0]-e[0],R=M[1]-e[1],A=O*f,C=R*a,I=A+e[0],V=C+e[1];if(M.length===6){P.push([I,V,M[2],M[3],M[4],M[5]]);continue}P.push([I,V])}n.transitionPoints=P;let x={points:P,iedges:null,boundingBox:null,bezierLines:[],isBezier:!1};E(x),n.transitionBoundingBox=x.boundingBox},commit(i,n,r){return{isOpen:!1,points:n.transitionPoints}}};var Rt={type:"close-shape-line",label:"Close shape line",trigger:{type:"click"},isValid(i,n,r){return!n.isOpen||n.polygon.points.length<3||!n.closestLinePoint||n.closestLineDistance>=r.proximity?!1:(n.closestLineIndex===0||n.closestLineIndex===n.polygon.points.length-2,!0)},commit(i,n,r){return W.commit(i,n,r)}};var Tt={type:"stamp-fixed-size-shape",label:"Stamp fixed size shape",trigger:{type:"click"},isValid(i,n,r){return n.slowState.selectedStamp!==null},commit(i,n,r){let t=i[0],e=n.slowState.selectedStamp;if(!t||!e)return;let s=t[0],c=t[1],o=[],p=Math.min(...e.points.map(a=>a[0])),d=Math.min(...e.points.map(a=>a[1])),m=Math.max(...e.points.map(a=>a[0]))-p,g=Math.max(...e.points.map(a=>a[1]))-d,y=4*r.proximity,w=m/y;g/y>w&&(w=g/y),s-=m/w/2,c-=g/w/2;let f=0;for(let a of e.points)o.push([s+(a[0]-p)/w,c+(a[1]-d)/w]),f++;return{isOpen:!1,points:o}}};var Dt={type:"move-line",label:"Move line",isValid(i,n,r){return n.slowState.lineMode?!!(n.closestLinePoint&&n.closestLineDistance<r.proximity):!1},transition(i,n){let r=n.transitionOrigin,t=n.polygon.boundingBox,e=i[0],s=e[0]-r[0],c=e[1]-r[1];n.transitionPoints=n.polygon.points.map(o=>o.length===6?[o[0]+s,o[1]+c,o[2],o[3],o[4],o[5]]:[o[0]+s,o[1]+c])},commit(i,n,r){let t=n.transitionPoints;return n.transitionPoints=null,n.transitionBoundingBox=null,{points:t}}};var Vt={type:"close-line-box",label:"Close Line Box",trigger:{type:"click"},isValid(i,n,r){return n.slowState.lineBoxMode===!0&&n.polygon.points.length===2&&n.lineBox!==null},commit(i,n,r){return n.lineBox?{isOpen:!1,points:n.lineBox}:{}}};function Nn(i={}){let n=i.proximityThreshold||10,r=i.closestLinePointFill||{selected:"#fff",unselected:"rgba(255, 255, 255, .5)"},t=i.closestLinePointStroke||{selected:"#000",unselected:"rgba(0, 0, 0, .5)"};function e(f,a,P){f&&a.transitionBoundingBox&&P.transitioning&&(f.setAttribute("x",""+a.transitionBoundingBox.x),f.setAttribute("y",""+a.transitionBoundingBox.y),f.setAttribute("width",""+a.transitionBoundingBox.width),f.setAttribute("height",""+a.transitionBoundingBox.height))}function s(f,a,P){f&&a.polygon.boundingBox&&P.showBoundingBox&&(f.setAttribute("x",""+a.polygon.boundingBox.x),f.setAttribute("y",""+a.polygon.boundingBox.y),f.setAttribute("width",""+a.polygon.boundingBox.width),f.setAttribute("height",""+a.polygon.boundingBox.height))}function c(f,a,P){if(f&&a.polygon.boundingBox&&P.showBoundingBox){let x=a.transitionBoundingBox||a.polygon.boundingBox;x.rotation?(f.style.transformOrigin=`${x.x+x.width/2}px ${x.y+x.height/2}px`,f.style.transform=`rotate(${Math.round(100*x.rotation*(180/Math.PI))/100}deg)`):f.style.transform="",f.setAttribute("points",[[x.x,x.y],[x.x+x.width,x.y],[x.x+x.width,x.y+x.height],[x.x,x.y+x.height]].map(M=>M.join(",")).join(" "))}}function o(f,a,P){f&&a.transitionPoints&&P.transitioning&&f.setAttribute("points",a.transitionPoints.map(x=>x.join(",")).join(" "))}function p(f,a,P){f&&a.closestLinePoint&&P.hasClosestLine&&(f.setAttribute("cx",""+a.closestLinePoint[0]),f.setAttribute("cy",""+a.closestLinePoint[1]),f.setAttribute("fill",a.closestLineDistance<n?r.selected:r.unselected),f.setAttribute("stroke",a.closestLineDistance<n?t.selected:t.unselected))}function d(f,a,P){f&&a.closestLinePoint&&P.hasClosestLine&&f.setAttribute("transform",`translate(${a.closestLinePoint[0]}, ${a.closestLinePoint[1]})`)}function m(f,a,P){f&&a.selectionBox&&P.transitionIntentType==="select-multiple-points"&&(f.setAttribute("x",""+a.selectionBox.x),f.setAttribute("y",""+a.selectionBox.y),f.setAttribute("width",""+a.selectionBox.width),f.setAttribute("height",""+a.selectionBox.height))}function g(f,a,P){if(f&&a.pointer&&a.selectedPoints.length)if(P.actionIntentType==="close-shape"||P.actionIntentType==="close-shape-line"){let x=a.polygon.points[0],M=a.polygon.points[a.polygon.points.length-1];x&&M&&f.setAttribute("points",`${x.join(",")} ${M.join(",")}`)}else if(a.line)f.setAttribute("points",`${a.line[0].join(",")} ${a.line[1].join(",")}`);else{let x=a.polygon.points[a.selectedPoints[0]];x&&x.length&&f.setAttribute("points",`${a.pointer[0]},${a.pointer[1]} ${x.join(",")}`)}}function y(f,a,P,x=3){f&&a.transitionDraw.length&&f.setAttribute("points",K(a.transitionDraw,x*3).map(M=>M.join(",")).join(" "))}function w(f,a){f&&a.lineBox&&f.setAttribute("points",a.lineBox.map(P=>P.join(",")).join(" "))}return{updateTransitionBoundingBox:e,updateClosestLinePointTransform:d,updateBoundingBoxPolygon:c,updateBoundingBox:s,updateTransitionShape:o,updateClosestLinePoint:p,updateSelectBox:m,updatePointLine:g,updateDrawPreview:y,updateLineBox:w}}var Wt=typeof window<"u"?window.requestAnimationFrame:i=>setTimeout(i,16),_t=typeof window<"u"?window.cancelAnimationFrame:i=>clearTimeout(i),ot=[Ot,yt,ut,Dt,H,$,j,kt,wt],Xt=ot.length,it=[Vt,Tt,W,mt,Rt,St,gt,xt,Pt,bt],Y=[ht,Mt,Bt,It,At,Lt],U={};ot.forEach(i=>{U[i.type]=i});it.forEach(i=>{U[i.type]=i});Y.forEach(i=>{U[i.type]=i});var X=20;function fe(i,n){let r={shapeId:i?.id||null,noShape:i===null,transitioning:!1,actionIntentType:null,transitionIntentType:null,selectedPoints:[],hasClosestLine:!1,modifiers:{Alt:!1,Shift:!1,Meta:!1,proximity:X},showBoundingBox:!1,currentModifiers:{},validIntentKeys:{},pointerInsideShape:!1,closestPoint:null,transitionModifiers:null,selectedStamp:null,lineMode:!1,lineBoxMode:!1,drawMode:!1,bezierLines:[]},t={isOpen:i?i.open:!1,polygon:{points:i?.points||[],iedges:null,boundingBox:null,isBezier:null,bezierLines:[]},scale:1,selectedPoints:[],pointer:null,line:null,lineBox:null,transitionPoints:null,transitionOrigin:null,transitionBoundingBox:null,closestLinePoint:null,closestLineDistance:0,closestLineIndex:-1,transitionRotate:!1,transitionDirection:null,transitionBezierLine:null,selectionBox:null,slowState:r,transitionDraw:[]},e={startTime:0,time:0,shouldUpdate:!1,nextSlowState:null,renderFunc:()=>{},setStateFunc:()=>{},animationFrame:0,actionIntent:null,transitionIntent:null,undoStack:[],undoStackPointer:-1},s={isPressed:!1,isClicking:!1,lastPress:null,pressTimeout:0,noTransition:!1};function c(l){tt(l),l.isBezier&&o({bezierLines:l.bezierLines}),E(l),e.shouldUpdate=!0}c(t.polygon);function o(l){let u=Object.keys(l);if(u.length===0)return;let S=e.nextSlowState||t.slowState,h=!1;if(u.length===1&&u[0]==="validIntentKeys"&&S.validIntentKeys){let b=Object.keys(S.validIntentKeys),B=Object.keys(l.validIntentKeys||{});if(b.length===B.length){for(let L of b)S.validIntentKeys[L]!==l.validIntentKeys[L]&&(h=!0);if(!h)return}}if(!(u.length===1&&u.includes("hasClosestLine")&&l.hasClosestLine===S.hasClosestLine)){if(e.nextSlowState){e.nextSlowState={...e.nextSlowState,...l};return}e.nextSlowState={...t.slowState,...l}}}function p(l,u=!1){e.time+=l,d(),m(),x(),P(),a(),M(),R(),O(),e.renderFunc(t,t.slowState,l),!u&&(e.animationFrame=Wt(p))}function d(){if(e.shouldUpdate&&(n({id:t.slowState.shapeId||void 0,open:t.isOpen,points:t.polygon.points}),e.shouldUpdate=!1),e.nextSlowState&&e.nextSlowState!==t.slowState){let l=Object.keys(t.slowState),u={},S=!1;for(let h of l){let b=t.slowState[h],B=e.nextSlowState[h];b!==B?(S=!0,u[h]=B):u[h]=b}S&&(t.slowState=u,e.nextSlowState=null,e.setStateFunc(t.slowState))}}function m(){t.slowState.showBoundingBox?(t.slowState.noShape||t.selectedPoints.length===0||t.selectedPoints.length!==t.polygon.points.length)&&o({showBoundingBox:!1}):!t.slowState.noShape&&t.polygon.points.length&&t.selectedPoints.length===t.polygon.points.length&&o({showBoundingBox:!0})}function g(l){t.selectedPoints=l.selectedPoints,o({selectedPoints:l.selectedPoints}),t.polygon.points=l.points,t.polygon.boundingBox=null,t.polygon.iedges=null,t.polygon.isBezier=null,c(t.polygon),o({closestPoint:null}),(l.isOpen===!0||l.isOpen===!1)&&(t.isOpen=l.isOpen,e.shouldUpdate=!0)}function y(){if(e.undoStackPointer===-1)return;e.undoStackPointer--;let l=e.undoStack[e.undoStackPointer];g(l)}function w(){if(e.undoStackPointer===e.undoStack.length-1)return;e.undoStackPointer++;let l=e.undoStack[e.undoStackPointer];g(l)}function f(l){e.undoStackPointer++,e.undoStack[e.undoStackPointer]=l,e.undoStack.length>15&&(e.undoStack.shift(),e.undoStackPointer--)}function a(){if(!t.pointer||t.slowState.noShape){o({pointerInsideShape:!1});return}let[l,u]=t.pointer,S=t.polygon.points,h=t.polygon.boundingBox;if(!h){o({pointerInsideShape:!1});return}if(l<h.x||l>h.x+h.width||u<h.y||u>h.height+h.y){o({pointerInsideShape:!1});return}let b=!1;for(let B=0,L=S.length-1;B<S.length;L=B++)S[B][1]>u!=S[L][1]>u&&l<(S[L][0]-S[B][0])*(u-S[B][1])/(S[L][1]-S[B][1])+S[B][0]&&(b=!b);o({pointerInsideShape:b})}function P(){if(t.slowState.noShape||!t.pointer||t.slowState.transitioning||!t.polygon.points||t.polygon.points.length===0)return;let[l,u]=t.pointer,S=t.polygon.points.map((h,b)=>{let B=h[0]-l,L=h[1]-u;return[B*B+L*L,b]}).sort((h,b)=>h[0]-b[0]);S.length&&o({closestPoint:S[0][1]})}function x(){if(!t.pointer||t.slowState.transitioning)return;if(t.slowState.noShape){t.closestLineIndex=-1,t.closestLinePoint=null,t.closestLineDistance=0;return}let[l,u,S,h]=nt(t.polygon,t.pointer),b=st()*st();u<b&&(!t.isOpen||t.slowState.lineMode||t.polygon.points.length-1!==h)?(t.closestLinePoint=l,t.closestLineDistance=Math.sqrt(u),t.closestLineIndex=h,o({hasClosestLine:!0})):(t.closestLinePoint=null,t.closestLineDistance=0,t.closestLineIndex=-1,o({hasClosestLine:!1}))}function M(){if(!t.pointer||t.slowState.transitioning||t.slowState.noShape)return;let l=!1;for(let h=0;h<Xt;h++){let b=ot[h];if(b.isValid(s.isPressed?[s.lastPress]:[t.pointer],t,A())){if(e.transitionIntent===b){l=!0;break}o({transitionIntentType:b.type}),e.transitionIntent=b,l=!0;break}}l||e.transitionIntent&&(e.transitionIntent=null,o({transitionIntentType:null}));let u=!1;for(let h=0;h<it.length;h++){let b=it[h];if(I(b)){if(e.actionIntent===b){u=!0;break}o({actionIntentType:b.type}),e.actionIntent=b,u=!0;break}}u||e.actionIntent&&(e.actionIntent=null,o({actionIntentType:null}));let S={};for(let h=0;h<Y.length;h++){let b=Y[h];b.trigger.type==="key"&&I(b)&&(S[b.trigger.key]=b.label)}o({validIntentKeys:S})}function O(){let l=t.pointer;if(t.lineBox=null,!l||z()||t.polygon.points.length!==2)return;let[u,S]=l,[h,b]=t.polygon.points[0],[B,L]=t.polygon.points[1],[N,J,rt,lt]=nt(t.polygon,l);if(!N)return;let F=u-N[0],at=S-N[1],Q=[h,b],Z=[B,L],$t=[Z[0]+F,Z[1]+at],Gt=[Q[0]+F,Q[1]+at];t.lineBox=[Q,Z,$t,Gt]}function R(){let l=t.pointer;if(!l||!z()||t.slowState.noShape)return;let u=t.selectedPoints[0];if(t.line=[t.polygon.points[u],l],t.slowState.modifiers.Shift){let S=0;if(t.polygon.points.length>1){let F=t.selectedPoints[0];F===0?S=Math.atan2(t.polygon.points[1][1]-t.polygon.points[0][1],t.polygon.points[1][0]-t.polygon.points[0][0]):S=Math.atan2(t.polygon.points[F-1][1]-t.polygon.points[F][1],t.polygon.points[F-1][0]-t.polygon.points[F][0])}let h=l[0]-t.polygon.points[u][0],b=l[1]-t.polygon.points[u][1],B=Math.atan2(b,h),L=Math.PI/4,N=Math.round((B-S)/L)*L+S,J=k(t.polygon.points[u],l),rt=Math.cos(N)*J+t.polygon.points[u][0],lt=Math.sin(N)*J+t.polygon.points[u][1];t.line[1]=[rt,lt]}}function A(){return t.slowState.modifiers}function C(l){let u=l.commit([s.lastPress],t,A());u&&(u.selectedPoints&&(t.selectedPoints=u.selectedPoints,o({selectedPoints:u.selectedPoints})),u.points&&(t.polygon.points=u.points,t.polygon.boundingBox=null,t.polygon.iedges=null,t.polygon.isBezier=null,t.transitionBoundingBox=null,c(t.polygon),o({closestPoint:null,selectedStamp:null})),(u.isOpen===!0||u.isOpen===!1)&&(t.isOpen=u.isOpen,e.shouldUpdate=!0),f({isOpen:t.isOpen,points:t.polygon.points,selectedPoints:t.selectedPoints})),o({transitionModifiers:null})}function I(l){return l.isValid(t.pointer?[t.pointer]:[],t,A())}function V(l){l==="Delete"&&(l="Backspace");for(let u of Y)if(!(u.trigger.type!=="key"||u.trigger.key!==l)&&I(u))return C(u),!0}function z(){let l=t.polygon.points,u=t.pointer;if(!t.isOpen||!l.length||t.selectedPoints.length!==1||!u)return!1;let S=t.selectedPoints[0],h=S===0,b=S===l.length-1;return h||b}let T={reset(){o({modifiers:{Alt:!1,Shift:!1,Meta:!1,proximity:X}})},getForType(l){let u={};if(!l)return u;let S=U[l];return!S||!S.modifiers?u:S.modifiers},set(l){l!=="Shift"&&l!=="Alt"&&l!=="Meta"||o({modifiers:{...e.nextSlowState?.modifiers||t.slowState.modifiers,[l]:!0}})},unset(l){l!=="Shift"&&l!=="Alt"&&l!=="Meta"||o({modifiers:{...e.nextSlowState?.modifiers||t.slowState.modifiers,[l]:!1}})}},v={set(l){o({selectedStamp:l})},clear(){o({selectedStamp:null})},square(){o({selectedStamp:{id:"square",open:!1,points:[[0,0],[0,100],[100,100],[100,0]]}})},triangle(){o({selectedStamp:{id:"triangle",open:!1,points:[[50,0],[0,100],[100,100]]}})},pentagon(){o({selectedStamp:{id:"pentagon",open:!1,points:[[0,0],[0,100],[100,100],[100,0],[50,-50]]}})},hexagon(){o({selectedStamp:{id:"hexagon",open:!1,points:[[0,0],[0,100],[50,150],[100,100],[100,0],[50,-50]]}})}},D={down(l){return l=="Shift"||l=="Alt"||l=="Meta"?(T.set(l),!0):l==="Control"?(T.set("Meta"),!0):l==="z"&&t.slowState.modifiers.Meta?(t.slowState.modifiers.Shift?w():y(),!0):V(l)},up(l){if(l==="Control"){T.unset("Meta");return}l!=="Shift"&&l!=="Alt"&&l!=="Meta"||T.unset(l)}};function q(l){t.scale=l,o({modifiers:{...e.nextSlowState?.modifiers||t.slowState.modifiers,proximity:l*X}})}function st(){return X*t.scale}let Ct={set:l=>{e.renderFunc=l},start:(l,u)=>{e.startTime=performance.now(),e.time=0,l&&(e.renderFunc=l),u&&(u(t.slowState),e.setStateFunc=u),p(0)},stop:()=>{e.animationFrame&&(_t(e.animationFrame),e.animationFrame=0)},step:(l=16)=>{p(l)}};function zt(l){let u=l[0];if(!(!u||!u[0]&&u[0]!==0||!u[1]&&u[1]!==0)&&!(Number.isNaN(u[0])||Number.isNaN(u[1]))){if(t.pointer=u||null,t.slowState.transitioning)e.transitionIntent&&e.transitionIntent.transition(l,t,A());else if(s.isPressed&&!s.noTransition&&(!s.isClicking||k(s.lastPress,t.pointer)>10))if(clearTimeout(s.pressTimeout),s.isClicking=!1,e.transitionIntent){if(t.transitionOrigin=s.lastPress,o({transitioning:!0}),e.transitionIntent.start){let h=e.transitionIntent.start([s.lastPress],t,A());h&&(h.selectedPoints&&(t.selectedPoints=h.selectedPoints,o({selectedPoints:h.selectedPoints})),(h.isOpen===!0||h.isOpen===!1)&&(t.isOpen=h.isOpen,e.shouldUpdate=!0),h.points&&(t.polygon.points=h.points,t.polygon.boundingBox=null,t.polygon.iedges=null,c(t.polygon),o({closestPoint:null})))}o({transitionModifiers:e.transitionIntent.modifiers||null}),e.transitionIntent.transition([s.lastPress],t,A())}else s.noTransition=!0}}function vt(){t.pointer=null,t.slowState.transitioning||(s.isPressed=!1,s.isClicking=!1,s.lastPress=null,o({transitionIntentType:null,actionIntentType:null}),e.transitionIntent=null,e.actionIntent=null)}function Ft(){s.isClicking=!0,s.isPressed=!0,s.lastPress=t.pointer,s.pressTimeout=setTimeout(()=>{s.isPressed&&(s.isClicking=!1)},250)}function Et(){t.slowState.transitioning?(o({transitioning:!1}),e.transitionIntent&&C(e.transitionIntent),e.transitionIntent=null,o({transitionIntentType:null})):s.isClicking&&(e.actionIntent&&C(e.actionIntent),e.actionIntent=null,o({actionIntentType:null})),s.isPressed=!1,s.isClicking=!1,s.lastPress=null,s.noTransition=!1,clearTimeout(s.pressTimeout)}function Nt(l){t.polygon.points=l?.points||[],t.polygon.boundingBox=null,t.polygon.iedges=null,t.isOpen=l?.open||!1,c(t.polygon),e.nextSlowState=null,e.undoStack=[],e.undoStackPointer=-1,t.lineBox=null,t.line=null,s.pressTimeout&&clearTimeout(s.pressTimeout),o({noShape:l===null,shapeId:l?.id||null,transitioning:!1,actionIntentType:null,transitionIntentType:null,selectedPoints:[],hasClosestLine:!1,modifiers:{Alt:!1,Shift:!1,Meta:!1,proximity:t.slowState.modifiers.proximity},showBoundingBox:!1,currentModifiers:{},validIntentKeys:{},selectedStamp:null,drawMode:!1,closestPoint:null,pointerInsideShape:!1,lineBoxMode:!1,lineMode:!1}),d()}function Ut(l){if(!l)return"";let u=U[l];return!u||!u.modifiers?u.label||"":t.slowState.modifiers.Shift&&u.modifiers.Shift?u.modifiers.Shift:t.slowState.modifiers.Alt&&u.modifiers.Alt?u.modifiers.Alt:t.slowState.modifiers.Meta&&u.modifiers.Meta?u.modifiers.Meta:u.label}function qt(){t.slowState.lineMode?o({lineMode:!1,lineBoxMode:!1,drawMode:!1}):o({lineMode:!0,lineBoxMode:!1,drawMode:!1})}function jt(){t.slowState.lineBoxMode?o({lineMode:!1,lineBoxMode:!1,drawMode:!1}):o({lineBoxMode:!0,lineMode:!0,drawMode:!1})}return{draw:{enable(){o({drawMode:!0,lineMode:!1,lineBoxMode:!1})},disable(){o({drawMode:!1})},toggle(){o({drawMode:!t.slowState.drawMode,lineMode:!1,lineBoxMode:!1})}},state:t,modifiers:T,stamps:v,key:D,setScale:q,clock:Ct,pointer:zt,blur:vt,pointerDown:Ft,pointerUp:Et,setShape:Nt,modes:{toggleLineBoxMode:jt,toggleLineMode:qt,enableLineMode(){o({lineMode:!0,lineBoxMode:!1,drawMode:!1})},disableLineMode(){o({lineMode:!1,lineBoxMode:!1,drawMode:!1})},enableLineBoxMode(){o({lineMode:!0,lineBoxMode:!0,drawMode:!1})},disableLineBoxMode(){o({lineMode:!1,lineBoxMode:!1,drawMode:!1})}},label:Ut}}export{fe as createHelper,Nn as createSvgHelpers};
